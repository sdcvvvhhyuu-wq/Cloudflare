// <!--GAMFC-->version base on commit: 94ebd83c59a94713fe49e03c692a4edb0b91dc53 - last update: 2025-12-11 00:42:42 UTC <!--GAMFC-END-->.

import{connect}from'cloudflare:sockets';const Config={'userID':'d342d11e-d424-4583-b36e-524ab1f0afa4','proxyIPs':['nima.nscl.ir:443','bpb.yousef.isegaro.com:443'],'scamalytics':{'username':'','apiKey':'','baseUrl':'https://api12.scamalytics.com/v3/'},'socks5':{'enabled':![],'relayMode':![],'address':''},async 'fromEnv'(a){let b=null;if(a['DB'])try{const {results:f}=await a['DB']['prepare']('SELECT\x20ip_port\x20FROM\x20proxy_health\x20WHERE\x20is_healthy\x20=\x201\x20ORDER\x20BY\x20latency_ms\x20ASC\x20LIMIT\x201')['all']();b=f[0x0]?.['ip_port']||null,b&&console['log']('Using\x20best\x20healthy\x20proxy\x20IP\x20from\x20DB:\x20'+b);}catch(g){console['error']('Failed\x20to\x20read\x20proxy\x20health\x20from\x20DB:\x20'+g['message']);}!b&&(b=a['PROXYIP'],b&&console['log']('Using\x20proxy\x20IP\x20from\x20env.PROXYIP:\x20'+b));!b&&(b=this['proxyIPs'][Math['floor'](Math['random']()*this['proxyIPs']['length'])],b&&console['log']('Using\x20proxy\x20IP\x20from\x20hardcoded\x20list:\x20'+b));!b&&(console['error']('CRITICAL:\x20No\x20proxy\x20IP\x20could\x20be\x20determined'),b=this['proxyIPs'][0x0]);const [c,d='443']=b['split'](':');return{'userID':a['UUID']||this['userID'],'proxyIP':c,'proxyPort':parseInt(d,0xa),'proxyAddress':b,'scamalytics':{'username':a['SCAMALYTICS_USERNAME']||this['scamalytics']['username'],'apiKey':a['SCAMALYTICS_API_KEY']||this['scamalytics']['apiKey'],'baseUrl':a['SCAMALYTICS_BASEURL']||this['scamalytics']['baseUrl']},'socks5':{'enabled':!!a['SOCKS5'],'relayMode':a['SOCKS5_RELAY']==='true'||this['socks5']['relayMode'],'address':a['SOCKS5']||this['socks5']['address']}};}},CONST={'ED_PARAMS':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'},'VLESS_PROTOCOL':'vless','WS_READY_STATE_OPEN':0x1,'WS_READY_STATE_CLOSING':0x2,'ADMIN_LOGIN_FAIL_LIMIT':0x5,'ADMIN_LOGIN_LOCK_TTL':0x258,'SCAMALYTICS_THRESHOLD':0x32,'USER_PATH_RATE_LIMIT':0x14,'USER_PATH_RATE_TTL':0x3c,'AUTO_REFRESH_INTERVAL':0xea60,'IP_CLEANUP_AGE_DAYS':0x1e,'HEALTH_CHECK_INTERVAL':0x493e0,'HEALTH_CHECK_TIMEOUT':0x1388};function generateNonce(){const a=new Uint8Array(0x10);return crypto['getRandomValues'](a),btoa(String['fromCharCode']['apply'](null,a));}function addSecurityHeaders(a,b,c={}){const d=['default-src\x20\x27self\x27','form-action\x20\x27self\x27','object-src\x20\x27none\x27','frame-ancestors\x20\x27none\x27','base-uri\x20\x27self\x27',b?'script-src\x20\x27nonce-'+b+'\x27\x20\x27unsafe-inline\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com':'script-src\x20\x27self\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com\x20\x27unsafe-inline\x27','style-src\x20\x27self\x27\x20\x27unsafe-inline\x27\x20\x27unsafe-hashes\x27',('img-src\x20\x27self\x27\x20data:\x20https:\x20blob:\x20'+(c['img']||''))['trim'](),('connect-src\x20\x27self\x27\x20https:\x20'+(c['connect']||''))['trim']()];a['set']('Content-Security-Policy',d['join'](';\x20')),a['set']('Strict-Transport-Security','max-age=63072000;\x20includeSubDomains;\x20preload'),a['set']('X-Content-Type-Options','nosniff'),a['set']('X-Frame-Options','SAMEORIGIN'),a['set']('Referrer-Policy','strict-origin-when-cross-origin'),a['set']('Permissions-Policy','camera=(),\x20microphone=(),\x20geolocation=(),\x20payment=(),\x20usb=()'),a['set']('alt-svc','h3=\x22:443\x22;\x20ma=0'),a['set']('Cross-Origin-Opener-Policy','same-origin'),a['set']('Cross-Origin-Embedder-Policy','require-corp'),a['set']('Cross-Origin-Resource-Policy','same-origin');}function timingSafeEqual(c,d){if(typeof c!=='string'||typeof d!=='string')return![];const e=c['length'],f=d['length'];let g=0x0;if(e!==f){for(let h=0x0;h<e;h++){g|=c['charCodeAt'](h)^c['charCodeAt'](h);}return![];}for(let j=0x0;j<e;j++){g|=c['charCodeAt'](j)^d['charCodeAt'](j);}return g===0x0;}function escapeHTML(a){if(typeof a!=='string')return'';return a['replace'](/[&<>"']/g,b=>({'&':'&amp;','<':'&lt;','>':'&gt;','\x22':'&quot;','\x27':'&#39;'}[b]));}function generateUUID(){return crypto['randomUUID']();}function isValidUUID(a){if(typeof a!=='string')return![];const b=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return b['test'](a);}function isExpired(a,b){if(!a||!b)return!![];const c=b['includes'](':')&&b['split'](':')['length']===0x2?b+':00':b,d=c['split']('.')[0x0],e=new Date(a+'T'+d+'Z');return e<=new Date()||isNaN(e['getTime']());}async function formatBytes(a){if(a===0x0)return'0\x20Bytes';const b=0x400,c=['Bytes','KB','MB','GB','TB'],d=Math['floor'](Math['log'](a)/Math['log'](b));return parseFloat((a/Math['pow'](b,d))['toFixed'](0x2))+'\x20'+c[d];}async function kvGet(a,b,c='text'){if(!a)return console['error']('kvGet:\x20Database\x20not\x20available\x20for\x20key\x20'+b),null;try{const d=a['prepare']('SELECT\x20value,\x20expiration\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b),f=await d['first']();if(!f)return null;if(f['expiration']&&f['expiration']<Math['floor'](Date['now']()/0x3e8))return await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run'](),null;if(c==='json')try{return JSON['parse'](f['value']);}catch(g){return console['error']('Failed\x20to\x20parse\x20JSON\x20for\x20key\x20'+b+':\x20'+g),null;}return f['value'];}catch(h){return console['error']('kvGet\x20error\x20for\x20'+b+':\x20'+h),null;}}async function kvPut(a,b,c,d={}){if(!a){console['error']('kvPut:\x20Database\x20not\x20available\x20for\x20key\x20'+b);return;}try{typeof c==='object'&&(c=JSON['stringify'](c));const f=d['expirationTtl']?Math['floor'](Date['now']()/0x3e8+d['expirationTtl']):null;await a['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20key_value\x20(key,\x20value,\x20expiration)\x20VALUES\x20(?,\x20?,\x20?)')['bind'](b,c,f)['run']();}catch(g){console['error']('kvPut\x20error\x20for\x20'+b+':\x20'+g);}}async function kvDelete(a,b){if(!a){console['error']('kvDelete:\x20Database\x20not\x20available\x20for\x20key\x20'+b);return;}try{await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run']();}catch(c){console['error']('kvDelete\x20error\x20for\x20'+b+':\x20'+c);}}async function getUserData(a,b,c){try{if(!isValidUUID(b))return null;if(!a['DB'])return console['error']('D1\x20binding\x20missing'),null;const d='user:'+b;try{const h=await kvGet(a['DB'],d,'json');if(h&&h['uuid'])return h;}catch(i){console['error']('Failed\x20to\x20get\x20cached\x20data\x20for\x20'+b,i);}const f=await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!f)return null;const g=kvPut(a['DB'],d,f,{'expirationTtl':0xe10});return c?c['waitUntil'](g):await g,f;}catch(j){return console['error']('getUserData\x20error\x20for\x20'+b+':\x20'+j['message']),null;}}async function updateUsage(a,b,c,d){if(c<=0x0||!b)return;if(!a['DB']){console['error']('updateUsage:\x20D1\x20binding\x20missing');return;}const f='usage_lock:'+b;let g=![];try{while(!g){const k=await kvGet(a['DB'],f);!k?(await kvPut(a['DB'],f,'locked',{'expirationTtl':0x5}),g=!![]):await new Promise(l=>setTimeout(l,0x64));}const h=Math['round'](c),i=a['DB']['prepare']('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](h,b)['run'](),j=kvDelete(a['DB'],'user:'+b);d?d['waitUntil'](Promise['all']([i,j])):await Promise['all']([i,j]);}catch(l){console['error']('Failed\x20to\x20update\x20usage\x20for\x20'+b+':',l);}finally{if(g)try{await kvDelete(a['DB'],f);}catch(m){console['error']('Failed\x20to\x20release\x20lock\x20for\x20'+b+':',m);}}}async function isSuspiciousIP(a,b,c=CONST['SCAMALYTICS_THRESHOLD']){if(!b['username']||!b['apiKey'])return console['warn']('âš ï¸\x20\x20Scamalytics\x20API\x20credentials\x20not\x20configured.\x20IP\x20'+a+'\x20allowed\x20by\x20default\x20(fail-open\x20mode).'),![];const d=new AbortController(),f=setTimeout(()=>d['abort'](),0x1388);try{const g=b['baseUrl']+'score?username='+b['username']+'&ip='+a+'&key='+b['apiKey'],h=await fetch(g,{'signal':d['signal']});if(!h['ok'])return console['warn']('Scamalytics\x20API\x20returned\x20'+h['status']+'\x20for\x20'+a+'.\x20Allowing\x20(fail-open).'),![];const i=await h['json']();return i['score']>=c;}catch(j){return j['name']==='AbortError'?console['warn']('Scamalytics\x20timeout\x20for\x20'+a+'.\x20Allowing\x20(fail-open).'):console['error']('Scamalytics\x20error\x20for\x20'+a+':\x20'+j['message']+'.\x20Allowing\x20(fail-open).'),![];}finally{clearTimeout(f);}}async function hashSHA256(a){const b=new TextEncoder(),c=b['encode'](a),d=await crypto['subtle']['digest']('SHA-256',c),e=Array['from'](new Uint8Array(d));return e['map'](f=>f['toString'](0x10)['padStart'](0x2,'0'))['join']('');}async function checkRateLimit(a,b,c,d){if(!a)return![];try{const f=await kvGet(a,b),g=parseInt(f,0xa)||0x0;if(g>=c)return!![];return await kvPut(a,b,(g+0x1)['toString'](),{'expirationTtl':d}),![];}catch(h){return console['error']('checkRateLimit\x20error\x20for\x20'+b+':\x20'+h),![];}}async function ensureTablesExist(a,b){if(!a['DB']){console['warn']('ensureTablesExist:\x20D1\x20binding\x20not\x20available');return;}try{const c=['CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20users\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20uuid\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20created_at\x20DATETIME\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20\x20\x20\x20\x20expiration_date\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20expiration_time\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20notes\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20traffic_limit\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20traffic_used\x20INTEGER\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ip_limit\x20INTEGER\x20DEFAULT\x20-1\x0a\x20\x20\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20user_ips\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20uuid\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ip\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20last_seen\x20DATETIME\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20\x20\x20\x20\x20PRIMARY\x20KEY\x20(uuid,\x20ip),\x0a\x20\x20\x20\x20\x20\x20\x20\x20FOREIGN\x20KEY\x20(uuid)\x20REFERENCES\x20users(uuid)\x20ON\x20DELETE\x20CASCADE\x0a\x20\x20\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20key_value\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20key\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20value\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20expiration\x20INTEGER\x0a\x20\x20\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20proxy_health\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20ip_port\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20is_healthy\x20INTEGER\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20latency_ms\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20last_check\x20INTEGER\x20DEFAULT\x20(strftime(\x27%s\x27,\x20\x27now\x27))\x0a\x20\x20\x20\x20\x20\x20)'],d=c['map'](f=>a['DB']['prepare'](f));await a['DB']['batch'](d),console['log']('D1\x20tables\x20ensured\x20successfully');}catch(f){console['error']('Failed\x20to\x20create\x20D1\x20tables:',f);}}const byteToHex=Array['from']({'length':0x100},(a,b)=>(b+0x100)['toString'](0x10)['slice'](0x1));function unsafeStringify(a,b=0x0){return(byteToHex[a[b]]+byteToHex[a[b+0x1]]+byteToHex[a[b+0x2]]+byteToHex[a[b+0x3]]+'-'+byteToHex[a[b+0x4]]+byteToHex[a[b+0x5]]+'-'+byteToHex[a[b+0x6]]+byteToHex[a[b+0x7]]+'-'+byteToHex[a[b+0x8]]+byteToHex[a[b+0x9]]+'-'+byteToHex[a[b+0xa]]+byteToHex[a[b+0xb]]+byteToHex[a[b+0xc]]+byteToHex[a[b+0xd]]+byteToHex[a[b+0xe]]+byteToHex[a[b+0xf]])['toLowerCase']();}function stringify(a,b=0x0){const c=unsafeStringify(a,b);if(!isValidUUID(c))throw new TypeError('Stringified\x20UUID\x20is\x20invalid');return c;}function randomizeCase(a){let b='';for(let c=0x0;c<a['length'];c++){b+=Math['random']()<0.5?a[c]['toUpperCase']():a[c]['toLowerCase']();}return b;}function generateRandomPath(a=0xc,b=''){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let d='';for(let e=0x0;e<a;e++){d+=c['charAt'](Math['floor'](Math['random']()*c['length']));}return'/'+d+(b?'?'+b:'');}const CORE_PRESETS={'xray':{'tls':{'path':()=>generateRandomPath(0xc,'ed=2560'),'security':'tls','fp':'chrome','alpn':'http/1.1','extra':{}},'tcp':{'path':()=>generateRandomPath(0xc,'ed=2560'),'security':'none','fp':'chrome','extra':{}}},'sb':{'tls':{'path':()=>generateRandomPath(0x12),'security':'tls','fp':'chrome','alpn':'http/1.1','extra':CONST['ED_PARAMS']},'tcp':{'path':()=>generateRandomPath(0x12),'security':'none','fp':'chrome','extra':CONST['ED_PARAMS']}}};function makeName(a,b){return a+'-'+b['toUpperCase']();}function createVlessLink({userID:a,address:b,port:c,host:d,path:e,security:f,sni:g,fp:h,alpn:i,extra:extra={},name:j}){const l=new URLSearchParams({'type':'ws','host':d,'path':e});f&&(l['set']('security',f),f==='tls'&&l['set']('allowInsecure','1'));if(g)l['set']('sni',g);if(h)l['set']('fp',h);if(i)l['set']('alpn',i);for(const [m,n]of Object['entries'](extra))l['set'](m,n);return'vless://'+a+'@'+b+':'+c+'?'+l['toString']()+'#'+encodeURIComponent(j);}function buildLink({core:a,proto:b,userID:c,hostName:d,address:e,port:f,tag:g}){const h=CORE_PRESETS[a][b];return createVlessLink({'userID':c,'address':e,'port':f,'host':d,'path':h['path'](),'security':h['security'],'sni':h['security']==='tls'?randomizeCase(d):undefined,'fp':h['fp'],'alpn':h['alpn'],'extra':h['extra'],'name':makeName(g,b)});}const pick=a=>a[Math['floor'](Math['random']()*a['length'])];async function handleIpSubscription(a,b,c,d){const f=new URL(a['url']),g=f['searchParams']['get']('name'),h={'total_TB':0x17c,'base_GB':0xa410,'daily_growth_GB':0xfa,'expire_date':'2028-4-20'},i=[d,'creativecommons.org','www.speedtest.net','sky.rethinkdns.com','cfip.1323123.xyz','cfip.xxxxxxxx.tk','go.inmobi.com','singapore.com','www.visa.com','www.wto.org','cf.090227.xyz','cdnjs.com','zula.ir','csgo.com','fbi.gov'],j=[0x1bb,0x20fb,0x805,0x823,0x827,0x830],k=[0x50,0x1f90,0x22b0,0x804,0x822,0x826,0x82f];let l=[];const m=d['endsWith']('.pages.dev');i['forEach']((A,B)=>{l['push'](buildLink({'core':b,'proto':'tls','userID':c,'hostName':d,'address':A,'port':pick(j),'tag':'D'+(B+0x1)})),!m&&l['push'](buildLink({'core':b,'proto':'tcp','userID':c,'hostName':d,'address':A,'port':pick(k),'tag':'D'+(B+0x1)}));});try{const A=await fetch('https://raw.githubusercontent.com/NiREvil/vless/refs/heads/main/Cloudflare-IPs.json');if(A['ok']){const B=await A['json'](),C=[...B['ipv4']||[],...B['ipv6']||[]]['slice'](0x0,0x14)['map'](D=>D['ip']);C['forEach']((D,E)=>{const F=D['includes'](':')?'['+D+']':D;l['push'](buildLink({'core':b,'proto':'tls','userID':c,'hostName':d,'address':F,'port':pick(j),'tag':'IP'+(E+0x1)})),!m&&l['push'](buildLink({'core':b,'proto':'tcp','userID':c,'hostName':d,'address':F,'port':pick(k),'tag':'IP'+(E+0x1)}));});}}catch(D){console['error']('Fetch\x20IP\x20list\x20failed',D);}const n=0x400*0x400*0x400,o=0x400*n,p=h['total_TB']*o,q=h['base_GB']*n,s=new Date(),t=s['getHours']()+s['getMinutes']()/0x3c,u=t/0x18*(h['daily_growth_GB']*n),v=q+u/0x2,w=q+u/0x2,x=Math['floor'](new Date(h['expire_date'])['getTime']()/0x3e8),y='upload='+Math['round'](w)+';\x20download='+Math['round'](v)+';\x20total='+p+';\x20expire='+x,z={'Content-Type':'text/plain;charset=utf-8','Profile-Update-Interval':'6','Subscription-Userinfo':y};return g&&(z['Profile-Title']=g),new Response(btoa(l['join']('\x0a')),{'headers':z});}async function ProtocolOverWSHandler(a,b){const c=new WebSocketPair(),[d,e]=Object['values'](c);e['accept']();let f='',g='',h=null;const i=(n,o)=>{console['log']('['+f+':'+g+']\x20'+n,o||'');},j=a['headers']['get']('Sec-WebSocket-Protocol')||'',k=MakeReadableWebSocketStream(e,j,i);let l={'value':null},m=![];return k['pipeTo'](new WritableStream({async 'write'(n,o){if(h)return h['write'](n);if(l['value']){const w=l['value']['writable']['getWriter']();await w['write'](n),w['releaseLock']();return;}const {hasError:p,message:q,addressType:r,portRemote:portRemote=0x1bb,addressRemote:addressRemote='',rawDataIndex:s,ProtocolVersion:ProtocolVersion=new Uint8Array([0x0,0x0]),isUDP:t}=ProcessProtocolHeader(n,b['userID']);f=addressRemote,g=portRemote+'--'+Math['random']()+'\x20'+(t?'udp':'tcp')+'\x20';if(p)throw new Error(q);const u=new Uint8Array([ProtocolVersion[0x0],0x0]),v=n['slice'](s);if(t){if(portRemote===0x35){const x=await createDnsPipeline(e,u,i);h=x['write'],h(v);}else throw new Error('UDP\x20proxy\x20is\x20only\x20enabled\x20for\x20DNS\x20(port\x2053)');return;}HandleTCPOutBound(l,r,addressRemoteSocket,r,addressRemote,portRemote,v,e,u,i,b);},'close'(){i('readableWebSocketStream\x20closed');},'abort'(n){i('readableWebSocketStream\x20aborted',n);}}))['catch'](n=>{console['error']('Pipeline\x20failed:',n['stack']||n);}),new Response(null,{'status':0x65,'webSocket':d});}function ProcessProtocolHeader(a,b){if(a['byteLength']<0x18)return{'hasError':!![],'message':'invalid\x20data'};const c=new DataView(a),d=c['getUint8'](0x0),e=stringify(new Uint8Array(a['slice'](0x1,0x11))),f=b['split'](',')['map'](p=>p['trim']()),g=f['some'](p=>e===p);if(!g)return{'hasError':!![],'message':'invalid\x20user'};const h=c['getUint8'](0x11),i=c['getUint8'](0x12+h);if(i!==0x1&&i!==0x2)return{'hasError':!![],'message':'command\x20'+i+'\x20is\x20not\x20supported'};const j=0x12+h+0x1,k=c['getUint16'](j),l=c['getUint8'](j+0x2);let m,n,o;switch(l){case 0x1:n=0x4,o=j+0x3,m=new Uint8Array(a['slice'](o,o+n))['join']('.');break;case 0x2:n=c['getUint8'](j+0x3),o=j+0x4,m=new TextDecoder()['decode'](a['slice'](o,o+n));break;case 0x3:n=0x10,o=j+0x3,m=Array['from']({'length':0x8},(p,q)=>c['getUint16'](o+q*0x2)['toString'](0x10))['join'](':');break;default:return{'hasError':!![],'message':'invalid\x20addressType:\x20'+l};}if(!m)return{'hasError':!![],'message':'addressValue\x20is\x20empty,\x20addressType\x20is\x20'+l};return{'hasError':![],'addressRemote':m,'addressType':l,'portRemote':k,'rawDataIndex':o+n,'ProtocolVersion':new Uint8Array([d]),'isUDP':i===0x2};}async function HandleTCPOutBound(a,b,c,d,e,f,g,h,i){!i&&(i={'userID':'d342d11e-d424-4583-b36e-524ab1f0afa4','socks5Address':'','socks5Relay':![],'proxyIP':'nima.nscl.ir','proxyPort':'443','enableSocks':![],'parsedSocks5Address':{}});async function j(m,n,o=![]){let p;i['socks5Relay']?p=await socks5Connect(b,m,n,h,i['parsedSocks5Address']):p=o?await socks5Connect(b,m,n,h,i['parsedSocks5Address']):connect({'hostname':m,'port':n});a['value']=p,h('connected\x20to\x20'+m+':'+n);const q=p['writable']['getWriter']();return await q['write'](e),q['releaseLock'](),p;}async function k(){const m=i['enableSocks']?await j(c,d,!![]):await j(i['proxyIP']||c,i['proxyPort']||d,![]);m['closed']['catch'](n=>{console['log']('retry\x20tcpSocket\x20closed\x20error',n);})['finally'](()=>{safeCloseWebSocket(f);}),RemoteSocketToWS(m,f,g,null,h);}const l=await j(c,d);RemoteSocketToWS(l,f,g,k,h);}function MakeReadableWebSocketStream(a,b,c){return new ReadableStream({'start'(d){a['addEventListener']('message',g=>d['enqueue'](g['data'])),a['addEventListener']('close',()=>{safeCloseWebSocket(a),d['close']();}),a['addEventListener']('error',g=>{c('webSocketServer\x20has\x20error'),d['error'](g);});const {earlyData:e,error:f}=base64ToArrayBuffer(b);if(f)d['error'](f);else{if(e)d['enqueue'](e);}},'pull'(d){},'cancel'(d){c('ReadableStream\x20was\x20canceled,\x20due\x20to\x20'+d),safeCloseWebSocket(a);}});}async function RemoteSocketToWS(a,b,c,d,e){let f=![];try{await a['readable']['pipeTo'](new WritableStream({async 'write'(g){if(b['readyState']!==CONST['WS_READY_STATE_OPEN'])throw new Error('WebSocket\x20is\x20not\x20open');f=!![];const h=c?await new Blob([c,g])['arrayBuffer']():g;b['send'](h),c=null;},'close'(){e('Remote\x20connection\x20readable\x20closed.\x20Had\x20incoming\x20data:\x20'+f);},'abort'(g){console['error']('Remote\x20connection\x20readable\x20aborted:',g);}}));}catch(g){console['error']('RemoteSocketToWS\x20error:',g['stack']||g),safeCloseWebSocket(b);}!f&&d&&(e('No\x20incoming\x20data,\x20retrying'),await d());}function base64ToArrayBuffer(a){if(!a)return{'earlyData':null,'error':null};try{const b=atob(a['replace'](/-/g,'+')['replace'](/_/g,'/')),c=new ArrayBuffer(b['length']),d=new Uint8Array(c);for(let e=0x0;e<b['length'];e++){d[e]=b['charCodeAt'](e);}return{'earlyData':c,'error':null};}catch(f){return{'earlyData':null,'error':f};}}function safeCloseWebSocket(a){try{(a['readyState']===CONST['WS_READY_STATE_OPEN']||a['readyState']===CONST['WS_READY_STATE_CLOSING'])&&a['close']();}catch(b){console['error']('safeCloseWebSocket\x20error:',b);}}async function createDnsPipeline(a,b,c){let d=![];const e=new TransformStream({'transform'(g,h){for(let i=0x0;i<g['byteLength'];){const j=g['slice'](i,i+0x2),k=new DataView(j)['getUint16'](0x0),l=new Uint8Array(g['slice'](i+0x2,i+0x2+k));i=i+0x2+k,h['enqueue'](l);}}});e['readable']['pipeTo'](new WritableStream({async 'write'(g){try{const h=await fetch('https://1.1.1.1/dns-query',{'method':'POST','headers':{'content-type':'application/dns-message'},'body':g}),i=await h['arrayBuffer'](),j=i['byteLength'],k=new Uint8Array([j>>0x8&0xff,j&0xff]);a['readyState']===CONST['WS_READY_STATE_OPEN']&&(c('DNS\x20query\x20successful,\x20length:\x20'+j),d?a['send'](await new Blob([k,i])['arrayBuffer']()):(a['send'](await new Blob([b,k,i])['arrayBuffer']()),d=!![]));}catch(l){c('DNS\x20query\x20error:\x20'+l);}}}))['catch'](g=>{c('DNS\x20stream\x20error:\x20'+g);});const f=e['writable']['getWriter']();return{'write':g=>f['write'](g)};}async function socks5Connect(a,b,c,d,e){const {username:f,password:g,hostname:h,port:i}=e,j=connect({'hostname':h,'port':i}),k=j['writable']['getWriter'](),l=j['readable']['getReader'](),m=new TextEncoder();await k['write'](new Uint8Array([0x5,0x2,0x0,0x2]));let n=(await l['read']())['value'];if(n[0x0]!==0x5||n[0x1]===0xff)throw new Error('SOCKS5\x20server\x20connection\x20failed.');if(n[0x1]===0x2){if(!f||!g)throw new Error('SOCKS5\x20auth\x20credentials\x20not\x20provided.');const q=new Uint8Array([0x1,f['length'],...m['encode'](f),g['length'],...m['encode'](g)]);await k['write'](q),n=(await l['read']())['value'];if(n[0x0]!==0x1||n[0x1]!==0x0)throw new Error('SOCKS5\x20authentication\x20failed.');}let o;switch(a){case 0x1:o=new Uint8Array([0x1,...b['split']('.')['map'](Number)]);break;case 0x2:o=new Uint8Array([0x3,b['length'],...m['encode'](b)]);break;case 0x3:o=new Uint8Array([0x4,...b['split'](':')['flatMap'](r=>[parseInt(r['slice'](0x0,0x2),0x10),parseInt(r['slice'](0x2),0x10)])]);break;default:throw new Error('Invalid\x20addressType\x20for\x20SOCKS5:\x20'+a);}const p=new Uint8Array([0x5,0x1,0x0,...o,c>>0x8,c&0xff]);await k['write'](p),n=(await l['read']())['value'];if(n[0x1]!==0x0)throw new Error('Failed\x20to\x20open\x20SOCKS5\x20connection.');return k['releaseLock'](),l['releaseLock'](),j;}function socks5AddressParser(a){try{const [b,c]=a['includes']('@')?a['split']('@'):[null,a],[d,e]=c['split'](':'),f=parseInt(e,0xa);if(!d||isNaN(f))throw new Error();let g,h;if(b){[g,h]=b['split'](':');if(!g)throw new Error();}return{'username':g,'password':h,'hostname':d,'port':f};}catch{throw new Error('Invalid\x20SOCKS5\x20address\x20format.\x20Expected\x20[user:pass@]host:port');}}async function isAdmin(a,b){const c=a['headers']['get']('Cookie');if(!c)return![];const d=c['match'](/auth_token=([^;]+)/)?.[0x1];if(!d)return![];const e=await hashSHA256(d),f=await kvGet(b['DB'],'admin_session_token_hash');return f&&timingSafeEqual(e,f);}async function handleAdminRequest(a,b,c,d){try{await ensureTablesExist(b,c);const f=new URL(a['url']),g={'Content-Type':'application/json'},h=new Headers({'Content-Type':'text/html;charset=utf-8'}),i=a['headers']['get']('CF-Connecting-IP');if(!b['ADMIN_KEY'])return addSecurityHeaders(h,null,{}),new Response('Admin\x20panel\x20is\x20not\x20configured.',{'status':0x1f7,'headers':h});if(b['ADMIN_IP_WHITELIST']){const m=b['ADMIN_IP_WHITELIST']['split'](',')['map'](n=>n['trim']());if(!m['includes'](i))return console['warn']('Admin\x20access\x20denied\x20for\x20IP:\x20'+i),addSecurityHeaders(h,null,{}),new Response('Access\x20denied.',{'status':0x193,'headers':h});}else{const n={'username':b['SCAMALYTICS_USERNAME']||Config['scamalytics']['username'],'apiKey':b['SCAMALYTICS_API_KEY']||Config['scamalytics']['apiKey'],'baseUrl':b['SCAMALYTICS_BASEURL']||Config['scamalytics']['baseUrl']};if(await isSuspiciousIP(i,n,b['SCAMALYTICS_THRESHOLD']||CONST['SCAMALYTICS_THRESHOLD']))return console['warn']('Admin\x20access\x20denied\x20for\x20suspicious\x20IP:\x20'+i),addSecurityHeaders(h,null,{}),new Response('Access\x20denied.',{'status':0x193,'headers':h});}const j='/'+d+'/'+b['ADMIN_KEY'];if(!f['pathname']['startsWith'](j)){const o=new Headers();return addSecurityHeaders(o,null,{}),new Response('Not\x20found',{'status':0x194,'headers':o});}const k=f['pathname']['substring'](j['length'])||'/';if(k['startsWith']('/api/')){if(!b['DB']){const s=new Headers(g);return addSecurityHeaders(s,null,{}),new Response(JSON['stringify']({'error':'Database\x20not\x20configured'}),{'status':0x1f7,'headers':s});}if(!await isAdmin(a,b)){const t=new Headers(g);return addSecurityHeaders(t,null,{}),new Response(JSON['stringify']({'error':'Forbidden'}),{'status':0x193,'headers':t});}const p='admin_api_rate:'+i;if(await checkRateLimit(b['DB'],p,0x64,0x3c)){const u=new Headers(g);return addSecurityHeaders(u,null,{}),new Response(JSON['stringify']({'error':'API\x20rate\x20limit\x20exceeded'}),{'status':0x1ad,'headers':u});}if(a['method']!=='GET'){const v=a['headers']['get']('Origin'),w=a['headers']['get']('Sec-Fetch-Site');if(!v||new URL(v)['hostname']!==f['hostname']||w!=='same-origin'){const z=new Headers(g);return addSecurityHeaders(z,null,{}),new Response(JSON['stringify']({'error':'Invalid\x20Origin/Request'}),{'status':0x193,'headers':z});}const x=a['headers']['get']('X-CSRF-Token'),y=a['headers']['get']('Cookie')?.['match'](/csrf_token=([^;]+)/)?.[0x1];if(!x||!y||!timingSafeEqual(x,y)){const A=new Headers(g);return addSecurityHeaders(A,null,{}),new Response(JSON['stringify']({'error':'CSRF\x20validation\x20failed'}),{'status':0x193,'headers':A});}}if(k==='/api/stats'&&a['method']==='GET'){const B=new Headers(g);addSecurityHeaders(B,null,{});try{const C=await b['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users')['first']('count'),D=await b['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users\x20WHERE\x20datetime(expiration_date\x20||\x20\x27T\x27\x20||\x20expiration_time\x20||\x20\x27Z\x27)\x20<\x20datetime(\x27now\x27)')['first'](),E=D?.['count']||0x0,F=C-E,G=await b['DB']['prepare']('SELECT\x20SUM(traffic_used)\x20as\x20sum\x20FROM\x20users')['first'](),H=G?.['sum']||0x0;return new Response(JSON['stringify']({'total_users':C,'active_users':F,'expired_users':E,'total_traffic':H}),{'status':0xc8,'headers':B});}catch(I){return new Response(JSON['stringify']({'error':I['message']}),{'status':0x1f4,'headers':B});}}if(k==='/api/users'&&a['method']==='GET'){const J=new Headers(g);addSecurityHeaders(J,null,{});try{const {results:K}=await b['DB']['prepare']('SELECT\x20uuid,\x20created_at,\x20expiration_date,\x20expiration_time,\x20notes,\x20traffic_limit,\x20traffic_used,\x20ip_limit\x20FROM\x20users\x20ORDER\x20BY\x20created_at\x20DESC')['all']();return new Response(JSON['stringify'](K??[]),{'status':0xc8,'headers':J});}catch(L){return new Response(JSON['stringify']({'error':L['message']}),{'status':0x1f4,'headers':J});}}if(k==='/api/users'&&a['method']==='POST'){const M=new Headers(g);addSecurityHeaders(M,null,{});try{const {uuid:N,exp_date:O,exp_time:P,notes:Q,traffic_limit:R,ip_limit:S}=await a['json']();if(!N||!O||!P||!/^\d{4}-\d{2}-\d{2}$/['test'](O)||!/^\d{2}:\d{2}:\d{2}$/['test'](P))throw new Error('Invalid\x20or\x20missing\x20fields.');return await b['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20expiration_date,\x20expiration_time,\x20notes,\x20traffic_limit,\x20ip_limit,\x20traffic_used)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x200)')['bind'](N,O,P,Q||null,R,S||-0x1)['run'](),c['waitUntil'](kvPut(b['DB'],'user:'+N,{'uuid':N,'expiration_date':O,'expiration_time':P,'notes':Q||null,'traffic_limit':R,'ip_limit':S||-0x1,'traffic_used':0x0},{'expirationTtl':0xe10})),new Response(JSON['stringify']({'success':!![],'uuid':N}),{'status':0xc9,'headers':M});}catch(T){if(T['message']?.['includes']('UNIQUE\x20constraint\x20failed'))return new Response(JSON['stringify']({'error':'UUID\x20already\x20exists.'}),{'status':0x199,'headers':M});return new Response(JSON['stringify']({'error':T['message']}),{'status':0x190,'headers':M});}}if(k==='/api/users/bulk-delete'&&a['method']==='POST'){const U=new Headers(g);addSecurityHeaders(U,null,{});try{const {uuids:V}=await a['json']();if(!Array['isArray'](V)||V['length']===0x0)throw new Error('Invalid\x20request\x20body.');const W=b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?'),X=V['map'](Y=>W['bind'](Y));return await b['DB']['batch'](X),c['waitUntil'](Promise['all'](V['map'](Y=>kvDelete(b['DB'],'user:'+Y)))),new Response(JSON['stringify']({'success':!![],'count':V['length']}),{'status':0xc8,'headers':U});}catch(Y){return new Response(JSON['stringify']({'error':Y['message']}),{'status':0x190,'headers':U});}}const q=k['match'](/^\/api\/users\/([a-f0-9-]+)$/);if(q&&a['method']==='PUT'){const Z=new Headers(g);addSecurityHeaders(Z,null,{});const a0=q[0x1];try{const {exp_date:a1,exp_time:a2,notes:a3,traffic_limit:a4,ip_limit:a5,reset_traffic:a6}=await a['json']();if(!a1||!a2)throw new Error('Invalid\x20date/time\x20fields.');let a7='UPDATE\x20users\x20SET\x20expiration_date\x20=\x20?,\x20expiration_time\x20=\x20?,\x20notes\x20=\x20?,\x20traffic_limit\x20=\x20?,\x20ip_limit\x20=\x20?',a8=[a1,a2,a3||null,a4,a5||-0x1];return a6&&(a7+=',\x20traffic_used\x20=\x200'),a7+='\x20WHERE\x20uuid\x20=\x20?',a8['push'](a0),await b['DB']['prepare'](a7)['bind'](...a8)['run'](),c['waitUntil'](kvDelete(b['DB'],'user:'+a0)),new Response(JSON['stringify']({'success':!![],'uuid':a0}),{'status':0xc8,'headers':Z});}catch(a9){return new Response(JSON['stringify']({'error':a9['message']}),{'status':0x190,'headers':Z});}}if(q&&a['method']==='DELETE'){const aa=new Headers(g);addSecurityHeaders(aa,null,{});const ab=q[0x1];try{return await b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](ab)['run'](),c['waitUntil'](kvDelete(b['DB'],'user:'+ab)),new Response(JSON['stringify']({'success':!![],'uuid':ab}),{'status':0xc8,'headers':aa});}catch(ac){return new Response(JSON['stringify']({'error':ac['message']}),{'status':0x1f4,'headers':aa});}}if(k==='/api/logout'&&a['method']==='POST'){const ad=new Headers(g);addSecurityHeaders(ad,null,{});try{await kvDelete(b['DB'],'admin_session_token_hash');const ae=['auth_token=;\x20Max-Age=0;\x20Path=/;\x20Secure;\x20HttpOnly;\x20SameSite=Strict','csrf_token=;\x20Max-Age=0;\x20Path=/;\x20Secure;\x20SameSite=Strict'];return ad['append']('Set-Cookie',ae[0x0]),ad['append']('Set-Cookie',ae[0x1]),new Response(JSON['stringify']({'success':!![]}),{'status':0xc8,'headers':ad});}catch(af){return new Response(JSON['stringify']({'error':af['message']}),{'status':0x1f4,'headers':ad});}}if(k==='/api/health-check'&&a['method']==='POST'){const ag=new Headers(g);addSecurityHeaders(ag,null,{});try{return await performHealthCheck(b,c),new Response(JSON['stringify']({'success':!![]}),{'status':0xc8,'headers':ag});}catch(ah){return new Response(JSON['stringify']({'error':ah['message']}),{'status':0x1f4,'headers':ag});}}const r=new Headers(g);return addSecurityHeaders(r,null,{}),new Response(JSON['stringify']({'error':'API\x20route\x20not\x20found'}),{'status':0x194,'headers':r});}if(k==='/'){if(a['method']==='POST'){const aj='login_fail_ip:'+i;try{const ak=await kvGet(b['DB'],aj),al=parseInt(ak,0xa)||0x0;if(al>=CONST['ADMIN_LOGIN_FAIL_LIMIT'])return addSecurityHeaders(h,null,{}),new Response('Too\x20many\x20failed\x20login\x20attempts.',{'status':0x1ad,'headers':h});const am=await a['formData']();if(timingSafeEqual(am['get']('password'),b['ADMIN_KEY'])){const an=crypto['randomUUID'](),ao=crypto['randomUUID'](),ap=await hashSHA256(an);c['waitUntil'](Promise['all']([kvPut(b['DB'],'admin_session_token_hash',ap,{'expirationTtl':0x15180}),kvDelete(b['DB'],aj)]));const aq=new Headers({'Location':j});return aq['append']('Set-Cookie','auth_token='+an+';\x20HttpOnly;\x20Secure;\x20Path='+j+';\x20Max-Age=86400;\x20SameSite=Strict'),aq['append']('Set-Cookie','csrf_token='+ao+';\x20Secure;\x20Path='+j+';\x20Max-Age=86400;\x20SameSite=Strict'),addSecurityHeaders(aq,null,{}),new Response(null,{'status':0x12e,'headers':aq});}else return c['waitUntil'](kvPut(b['DB'],aj,(al+0x1)['toString'](),{'expirationTtl':CONST['ADMIN_LOGIN_LOCK_TTL']})),addSecurityHeaders(h,null,{}),new Response('Invalid\x20password',{'status':0x191,'headers':h});}catch(ar){return console['error']('Admin\x20login\x20error:',ar['stack']),addSecurityHeaders(h,null,{}),new Response('An\x20internal\x20error\x20occurred.',{'status':0x1f4,'headers':h});}}if(a['method']==='GET'){const as=generateNonce();addSecurityHeaders(h,as,{});const at='\x0a<!DOCTYPE\x20html>\x0a<html>\x0a<head><title>Admin\x20Panel</title></head>\x0a<body>\x0a<h1>Admin\x20Panel</h1>\x0a'+(await isAdmin(a,b)?'<p>Welcome,\x20Admin!</p>':'<form\x20method=\x22POST\x22><input\x20type=\x22password\x22\x20name=\x22password\x22\x20required><button>Login</button></form>')+'\x0a</body>\x0a</html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20';return new Response(at,{'headers':h});}const ai=new Headers();return addSecurityHeaders(ai,null,{}),new Response('Method\x20Not\x20Allowed',{'status':0x195,'headers':ai});}const l=new Headers();return addSecurityHeaders(l,null,{}),new Response('Not\x20found',{'status':0x194,'headers':l});}catch(au){console['error']('handleAdminRequest\x20error:',au['message'],au['stack']);const av=new Headers();return addSecurityHeaders(av,null,{}),new Response('Internal\x20Server\x20Error',{'status':0x1f4,'headers':av});}}async function handleUserPanel(a,b,c,d,f,g){try{const h='https://'+c+'/xray/'+b,i='https://'+c+'/sb/'+b,j=buildLink({'core':'xray','proto':'tls','userID':b,'hostName':c,'address':c,'port':0x1bb,'tag':'Main'}),k=buildLink({'core':'sb','proto':'tls','userID':b,'hostName':c,'address':c,'port':0x1bb,'tag':'Main'}),l=isExpired(f['expiration_date'],f['expiration_time']),m=f['expiration_date']&&f['expiration_time']?f['expiration_date']+'T'+f['expiration_time']+'Z':null;let n=0x0;f['traffic_limit']&&f['traffic_limit']>0x0&&(n=Math['min']((f['traffic_used']||0x0)/f['traffic_limit']*0x64,0x64));const o=await formatBytes(f['traffic_used']||0x0);let p='Unlimited';f['traffic_limit']&&f['traffic_limit']>0x0&&(p=await formatBytes(f['traffic_limit']));const q='\x0a<!doctype\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20<meta\x20charset=\x22utf-8\x22\x20/>\x0a\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,initial-scale=1\x22\x20/>\x0a\x20\x20<title>User\x20Panel\x20â€”\x20VLESS\x20Configuration</title>\x0a\x20\x20<style\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20:root{\x0a\x20\x20\x20\x20\x20\x20--bg:#0b1220;\x20--card:#0f1724;\x20--muted:#9aa4b2;\x20--accent:#3b82f6;\x0a\x20\x20\x20\x20\x20\x20--success:#22c55e;\x20--danger:#ef4444;\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20*{box-sizing:border-box}\x0a\x20\x20\x20\x20body{\x0a\x20\x20\x20\x20\x20\x20margin:0;\x20font-family:\x20Inter,\x20system-ui,\x20sans-serif;\x0a\x20\x20\x20\x20\x20\x20background:\x20linear-gradient(180deg,#061021\x200%,\x20#071323\x20100%);\x0a\x20\x20\x20\x20\x20\x20color:#e6eef8;\x20padding:28px;\x20min-height:100vh;\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20.container{max-width:1100px;margin:0\x20auto}\x0a\x20\x20\x20\x20.card{background:var(--card);\x20border-radius:12px;\x20padding:20px;\x0a\x20\x20\x20\x20\x20\x20border:1px\x20solid\x20rgba(255,255,255,0.03);\x20margin-bottom:20px;}\x0a\x20\x20\x20\x20h1{font-size:28px;\x20margin:0\x200\x208px}\x0a\x20\x20\x20\x20.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin:20px\x200}\x0a\x20\x20\x20\x20.stat{padding:14px;background:rgba(255,255,255,0.02);border-radius:10px;text-align:center}\x0a\x20\x20\x20\x20.stat\x20.val{font-weight:700;font-size:22px;margin-bottom:4px}\x0a\x20\x20\x20\x20.stat\x20.lbl{color:var(--muted);font-size:12px;text-transform:uppercase}\x0a\x20\x20\x20\x20.stat.status-active\x20.val{color:var(--success)}\x0a\x20\x20\x20\x20.stat.status-expired\x20.val{color:var(--danger)}\x0a\x20\x20\x20\x20.btn{display:inline-flex;align-items:center;gap:8px;padding:11px\x2016px;border-radius:8px;\x0a\x20\x20\x20\x20\x20\x20border:none;cursor:pointer;font-weight:600;font-size:14px;transition:all\x200.2s;\x0a\x20\x20\x20\x20\x20\x20text-decoration:none;color:inherit}\x0a\x20\x20\x20\x20.btn.primary{background:var(--accent);color:#fff}\x0a\x20\x20\x20\x20.btn.primary:hover{transform:translateY(-2px)}\x0a\x20\x20\x20\x20pre{background:#071529;padding:14px;border-radius:8px;overflow:auto;font-size:13px;margin:10px\x200}\x0a\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20<h1>ðŸš€\x20VXR.SXR\x20Configuration\x20Panel</h1>\x0a\x20\x20\x20\x20<p\x20style=\x22color:var(--muted);margin-bottom:20px\x22>Manage\x20your\x20proxy\x20configuration\x20and\x20monitor\x20usage</p>\x0a\x0a\x20\x20\x20\x20<div\x20class=\x22stats\x22>\x0a\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat\x20'+(l?'status-expired':'status-active')+'\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22val\x22>'+(l?'Expired':'Active')+'</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22lbl\x22>Status</div>\x0a\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22val\x22>'+o+'</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22lbl\x22>Used</div>\x0a\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22val\x22>'+p+'</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22lbl\x22>Limit</div>\x0a\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22val\x22>'+n['toFixed'](0x1)+'%</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22lbl\x22>Usage</div>\x0a\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20</div>\x0a\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20<h2>ðŸ“±\x20Xray\x20Subscription</h2>\x0a\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20primary\x22\x20onclick=\x22copy(\x27'+h+'\x27)\x22>ðŸ“‹\x20Copy\x20Link</button>\x0a\x20\x20\x20\x20\x20\x20<pre>'+escapeHTML(j)+'</pre>\x0a\x20\x20\x20\x20</div>\x0a\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20<h2>ðŸ“±\x20Sing-Box\x20Subscription</h2>\x0a\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20primary\x22\x20onclick=\x22copy(\x27'+i+'\x27)\x22>ðŸ“‹\x20Copy\x20Link</button>\x0a\x20\x20\x20\x20\x20\x20<pre>'+escapeHTML(k)+'</pre>\x0a\x20\x20\x20\x20</div>\x0a\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20<h2>ðŸ‘¤\x20Account\x20Details</h2>\x0a\x20\x20\x20\x20\x20\x20<p><strong>UUID:</strong>\x20'+b+'</p>\x0a\x20\x20\x20\x20\x20\x20<p><strong>Proxy:</strong>\x20'+(d||c)+'</p>\x0a\x20\x20\x20\x20\x20\x20<p><strong>Your\x20IP:</strong>\x20'+g+'</p>\x0a\x20\x20\x20\x20\x20\x20'+(f['notes']?'<p><strong>Notes:</strong>\x20'+escapeHTML(f['notes'])+'</p>':'')+'\x0a\x20\x20\x20\x20</div>\x0a\x20\x20</div>\x0a\x0a\x20\x20<script\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20function\x20copy(text)\x20{\x0a\x20\x20\x20\x20\x20\x20navigator.clipboard.writeText(text).then(()\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20alert(\x27Copied\x20to\x20clipboard!\x27);\x0a\x20\x20\x20\x20\x20\x20}).catch(()\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20alert(\x27Failed\x20to\x20copy\x27);\x0a\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20}\x0a\x20\x20</script>\x0a</body>\x0a</html>\x0a\x20\x20\x20\x20',r=generateNonce(),s=new Headers({'Content-Type':'text/html;charset=utf-8'});addSecurityHeaders(s,r,{});let t=q['replace'](/CSP_NONCE_PLACEHOLDER/g,r);return new Response(t,{'headers':s});}catch(u){console['error']('handleUserPanel\x20error:',u['message']);const v=new Headers();return addSecurityHeaders(v,null,{}),new Response('Internal\x20Server\x20Error',{'status':0x1f4,'headers':v});}}async function performHealthCheck(a,b){if(!a['DB']){console['warn']('performHealthCheck:\x20D1\x20binding\x20not\x20available');return;}const c=a['PROXYIPS']?a['PROXYIPS']['split'](',')['map'](f=>f['trim']()):Config['proxyIPs'],d=[];for(const f of c){const [g,h='443']=f['split'](':');let i=null,j=0x0;const k=Date['now']();try{const l=new AbortController(),m=setTimeout(()=>l['abort'](),CONST['HEALTH_CHECK_TIMEOUT']),n=await fetch('https://'+g+':'+h,{'signal':l['signal']});clearTimeout(m),n['ok']&&(i=Date['now']()-k,j=0x1);}catch(o){console['error']('Health\x20check\x20failed\x20for\x20'+f+':\x20'+o['message']);}d['push'](a['DB']['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20proxy_health\x20(ip_port,\x20is_healthy,\x20latency_ms,\x20last_check)\x20VALUES\x20(?,\x20?,\x20?,\x20?)')['bind'](f,j,i,Date['now']()));}try{await a['DB']['batch'](d),console['log']('Proxy\x20health\x20check\x20completed.');}catch(p){console['error']('performHealthCheck\x20batch\x20error:\x20'+p['message']);}}export default{async 'fetch'(a,b,c){try{await ensureTablesExist(b,c);let d;try{d=await Config['fromEnv'](b);}catch(n){console['error']('Configuration\x20Error:\x20'+n['message']);const o=new Headers();return addSecurityHeaders(o,null,{}),new Response('Service\x20temporarily\x20unavailable',{'status':0x1f7,'headers':o});}const f=new URL(a['url']),g=a['headers']['get']('CF-Connecting-IP'),h=b['ADMIN_PATH_PREFIX']||'admin';if(f['pathname']['startsWith']('/'+h+'/'))return await handleAdminRequest(a,b,c,h);if(f['pathname']==='/health'){const p=new Headers();return addSecurityHeaders(p,null,{}),new Response('OK',{'status':0xc8,'headers':p});}if(f['pathname']==='/health-check'&&a['method']==='GET'){await performHealthCheck(b,c);const q=new Headers();return addSecurityHeaders(q,null,{}),new Response('Health\x20check\x20performed',{'status':0xc8,'headers':q});}if(f['pathname']['startsWith']('/api/user/')){const r=f['pathname']['substring']('/api/user/'['length']),s=new Headers({'Content-Type':'application/json'});addSecurityHeaders(s,null,{});if(a['method']!=='GET')return new Response(JSON['stringify']({'error':'Method\x20Not\x20Allowed'}),{'status':0x195,'headers':s});if(!isValidUUID(r))return new Response(JSON['stringify']({'error':'Invalid\x20UUID'}),{'status':0x190,'headers':s});const t=await getUserData(b,r,c);if(!t)return new Response(JSON['stringify']({'error':'Authentication\x20failed'}),{'status':0x193,'headers':s});return new Response(JSON['stringify']({'traffic_used':t['traffic_used']||0x0,'traffic_limit':t['traffic_limit'],'expiration_date':t['expiration_date'],'expiration_time':t['expiration_time']}),{'status':0xc8,'headers':s});}if(f['pathname']==='/favicon.ico')return new Response(null,{'status':0x12d,'headers':{'Location':'https://www.google.com/favicon.ico'}});const i=a['headers']['get']('Upgrade');if(i?.['toLowerCase']()==='websocket'){if(!b['DB']){const B=new Headers();return addSecurityHeaders(B,null,{}),new Response('Service\x20not\x20configured\x20properly',{'status':0x1f7,'headers':B});}const u=b['HOST_HEADERS']?b['HOST_HEADERS']['split'](',')['map'](C=>C['trim']()):['speed.cloudflare.com'],v=pick(u),w=new Headers(a['headers']);w['set']('Host',v);const x=new Request(a,{'headers':w}),y={'userID':d['userID'],'proxyIP':d['proxyIP'],'proxyPort':d['proxyPort'],'socks5Address':d['socks5']['address'],'socks5Relay':d['socks5']['relayMode'],'enableSocks':d['socks5']['enabled'],'parsedSocks5Address':d['socks5']['enabled']?socks5AddressParser(d['socks5']['address']):{}},z=await ProtocolOverWSHandler(x,y),A=new Headers(z['headers']);return addSecurityHeaders(A,null,{}),new Response(z['body'],{'status':z['status'],'webSocket':z['webSocket'],'headers':A});}const j=async C=>{const D='user_path_rate:'+g;if(await checkRateLimit(b['DB'],D,CONST['USER_PATH_RATE_LIMIT'],CONST['USER_PATH_RATE_TTL'])){const G=new Headers();return addSecurityHeaders(G,null,{}),new Response('Rate\x20limit\x20exceeded',{'status':0x1ad,'headers':G});}const E=f['pathname']['substring'](('/'+C+'/')['length']);if(!isValidUUID(E)){const H=new Headers();return addSecurityHeaders(H,null,{}),new Response('Invalid\x20UUID',{'status':0x190,'headers':H});}const F=await getUserData(b,E,c);if(!F){const I=new Headers();return addSecurityHeaders(I,null,{}),new Response('Authentication\x20failed',{'status':0x193,'headers':I});}if(isExpired(F['expiration_date'],F['expiration_time'])){const J=new Headers();return addSecurityHeaders(J,null,{}),new Response('Authentication\x20failed',{'status':0x193,'headers':J});}if(F['traffic_limit']&&F['traffic_limit']>0x0&&(F['traffic_used']||0x0)>=F['traffic_limit']){const K=new Headers();return addSecurityHeaders(K,null,{}),new Response('Authentication\x20failed',{'status':0x193,'headers':K});}return await handleIpSubscription(a,C,E,f['hostname']);};if(f['pathname']['startsWith']('/xray/'))return await j('xray');if(f['pathname']['startsWith']('/sb/'))return await j('sb');const k=f['pathname']['slice'](0x1);if(isValidUUID(k)){const C='user_path_rate:'+g;if(await checkRateLimit(b['DB'],C,CONST['USER_PATH_RATE_LIMIT'],CONST['USER_PATH_RATE_TTL'])){const E=new Headers();return addSecurityHeaders(E,null,{}),new Response('Rate\x20limit\x20exceeded',{'status':0x1ad,'headers':E});}const D=await getUserData(b,k,c);if(!D){const F=new Headers();return addSecurityHeaders(F,null,{}),new Response('Authentication\x20failed',{'status':0x193,'headers':F});}return await handleUserPanel(a,k,f['hostname'],d['proxyAddress'],D,g);}if(b['ROOT_PROXY_URL'])try{let G;try{G=new URL(b['ROOT_PROXY_URL']);}catch(L){console['error']('Invalid\x20ROOT_PROXY_URL:\x20'+b['ROOT_PROXY_URL'],L);const M=new Headers();return addSecurityHeaders(M,null,{}),new Response('Proxy\x20configuration\x20error',{'status':0x1f4,'headers':M});}const H=new URL(a['url']);H['hostname']=G['hostname'],H['protocol']=G['protocol'];G['port']&&(H['port']=G['port']);const I=new Request(H['toString'](),{'method':a['method'],'headers':a['headers'],'body':a['body'],'redirect':'manual'});I['headers']['set']('Host',G['hostname']),I['headers']['set']('X-Forwarded-For',g),I['headers']['set']('X-Real-IP',g);const J=await fetch(I),K=new Headers(J['headers']);return K['set']('alt-svc','h3=\x22:443\x22;\x20ma=0'),addSecurityHeaders(K,null,{}),new Response(J['body'],{'status':J['status'],'statusText':J['statusText'],'headers':K});}catch(N){console['error']('Reverse\x20Proxy\x20Error:\x20'+N['message']);const O=new Headers();return addSecurityHeaders(O,null,{}),new Response('Proxy\x20error:\x20'+N['message'],{'status':0x1f6,'headers':O});}const l='\x0a\x20\x20\x20\x20\x20\x20\x20\x20<!DOCTYPE\x20html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<html>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<title>Welcome\x20to\x20nginx!</title>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20width:\x2035em;\x20margin:\x200\x20auto;\x20font-family:\x20Tahoma,\x20Verdana,\x20Arial,\x20sans-serif;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</head>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Welcome\x20to\x20nginx!</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>If\x20you\x20see\x20this\x20page,\x20the\x20nginx\x20web\x20server\x20is\x20successfully\x20installed\x20and\x20working.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</html>\x0a\x20\x20\x20\x20\x20\x20',m=new Headers({'Content-Type':'text/html'});return addSecurityHeaders(m,null,{}),new Response(l,{'headers':m});}catch(P){console['error']('Fetch\x20handler\x20error:',P['message'],P['stack']);const Q=new Headers();return addSecurityHeaders(Q,null,{}),new Response('Internal\x20Server\x20Error',{'status':0x1f4,'headers':Q});}}};