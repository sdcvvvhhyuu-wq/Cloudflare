// <!--GAMFC-->version base on commit: 9cf2abf8451f9ede91767c90853846e85cbbc297 - last update: 2025-12-11 00:18:30 UTC <!--GAMFC-END-->.

import{connect}from'cloudflare:sockets';const Config={'userID':'d342d11e-d424-4583-b36e-524ab1f0afa4','proxyIPs':['nima.nscl.ir:443','bpb.yousef.isegaro.com:443'],'scamalytics':{'username':'','apiKey':'','baseUrl':'https://api12.scamalytics.com/v3/'},'socks5':{'enabled':![],'relayMode':![],'address':''},async 'fromEnv'(a){let b=null;if(a['DB'])try{const {results:f}=await a['DB']['prepare']('SELECT\x20ip_port\x20FROM\x20proxy_health\x20WHERE\x20is_healthy\x20=\x201\x20ORDER\x20BY\x20latency_ms\x20ASC\x20LIMIT\x201')['all']();b=f[0x0]?.['ip_port']||null,b&&console['log']('Using\x20best\x20healthy\x20proxy\x20IP\x20from\x20DB:\x20'+b);}catch(g){console['error']('Failed\x20to\x20read\x20proxy\x20health\x20from\x20DB:\x20'+g['message']);}!b&&(b=a['PROXYIP'],b&&console['log']('Using\x20proxy\x20IP\x20from\x20env.PROXYIP:\x20'+b));!b&&(b=this['proxyIPs'][Math['floor'](Math['random']()*this['proxyIPs']['length'])],b&&console['log']('Using\x20proxy\x20IP\x20from\x20hardcoded\x20list:\x20'+b));!b&&(console['error']('CRITICAL:\x20No\x20proxy\x20IP\x20could\x20be\x20determined'),b=this['proxyIPs'][0x0]);const [c,d='443']=b['split'](':');return{'userID':a['UUID']||this['userID'],'proxyIP':c,'proxyPort':parseInt(d,0xa),'proxyAddress':b,'scamalytics':{'username':a['SCAMALYTICS_USERNAME']||this['scamalytics']['username'],'apiKey':a['SCAMALYTICS_API_KEY']||this['scamalytics']['apiKey'],'baseUrl':a['SCAMALYTICS_BASEURL']||this['scamalytics']['baseUrl']},'socks5':{'enabled':!!a['SOCKS5'],'relayMode':a['SOCKS5_RELAY']==='true'||this['socks5']['relayMode'],'address':a['SOCKS5']||this['socks5']['address']}};}},CONST={'ED_PARAMS':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'},'VLESS_PROTOCOL':'vless','WS_READY_STATE_OPEN':0x1,'WS_READY_STATE_CLOSING':0x2,'ADMIN_LOGIN_LOGIN_FAIL_LIMIT':0x5,'ADMIN_LOGIN_LOCK_TTL':0x258,'SCAMALYTICS_THRESHOLD':0x32,'USER_PATH_RATE_LIMIT':0x14,'USER_PATH_RATE_TTL':0x3c,'AUTO_REFRESH_INTERVAL':0xea60,'IP_CLEANUP_AGE_DAYS':0x1e,'HEALTH_CHECK_INTERVAL':0x493e0,'HEALTH_CHECK_TIMEOUT':0x1388};function generateNonce(){const a=new Uint8Array(0x10);return crypto['getRandomValues'](a),btoa(String['fromCharCode']['apply'](null,a));}function addSecurityHeaders(a,b,c={}){const d=['default-src\x20\x27self\x27','form-action\x20\x27self\x27','object-src\x20\x27none\x27','frame-ancestors\x20\x27none\x27','base-uri\x20\x27self\x27',b?'script-src\x20\x27nonce-'+b+'\x27\x20\x27unsafe-inline\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com':'script-src\x20\x27self\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com\x20\x27unsafe-inline\x27','style-src\x20\x27self\x27\x20\x27unsafe-inline\x27\x20\x27unsafe-hashes\x27',('img-src\x20\x27self\x27\x20data:\x20https:\x20blob:\x20'+(c['img']||''))['trim'](),('connect-src\x20\x27self\x27\x20https:\x20'+(c['connect']||''))['trim']()];a['set']('Content-Security-Policy',d['join'](';\x20')),a['set']('Strict-Transport-Security','max-age=63072000;\x20includeSubDomains;\x20preload'),a['set']('X-Content-Type-Options','nosniff'),a['set']('X-Frame-Options','SAMEORIGIN'),a['set']('Referrer-Policy','strict-origin-when-cross-origin'),a['set']('Permissions-Policy','camera=(),\x20microphone=(),\x20geolocation=(),\x20payment=(),\x20usb=()'),a['set']('alt-svc','h3=\x22:443\x22;\x20ma=0'),a['set']('Cross-Origin-Opener-Policy','same-origin'),a['set']('Cross-Origin-Embedder-Policy','require-corp'),a['set']('Cross-Origin-Resource-Policy','same-origin');}function timingSafeEqual(c,d){if(typeof c!=='string'||typeof d!=='string')return![];const e=c['length'],f=d['length'];let g=0x0;if(e!==f){for(let h=0x0;h<e;h++){g|=c['charCodeAt'](h)^c['charCodeAt'](h);}return![];}for(let j=0x0;j<e;j++){g|=c['charCodeAt'](j)^d['charCodeAt'](j);}return g===0x0;}function escapeHTML(a){if(typeof a!=='string')return'';return a['replace'](/[&<>"']/g,b=>({'&':'&amp;','<':'&lt;','>':'&gt;','\x22':'&quot;','\x27':'&#39;'}[b]));}function generateUUID(){return crypto['randomUUID']();}function isValidUUID(a){if(typeof a!=='string')return![];const b=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return b['test'](a);}function isExpired(a,b){if(!a||!b)return!![];const c=b['includes'](':')&&b['split'](':')['length']===0x2?b+':00':b,d=c['split']('.')[0x0],e=new Date(a+'T'+d+'Z');return e<=new Date()||isNaN(e['getTime']());}async function formatBytes(a){if(a===0x0)return'0\x20Bytes';const b=0x400,c=['Bytes','KB','MB','GB','TB'],d=Math['floor'](Math['log'](a)/Math['log'](b));return parseFloat((a/Math['pow'](b,d))['toFixed'](0x2))+'\x20'+c[d];}async function kvGet(a,b,c='text'){if(!a)return console['error']('kvGet:\x20Database\x20not\x20available\x20for\x20key\x20'+b),null;try{const d=a['prepare']('SELECT\x20value,\x20expiration\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b),f=await d['first']();if(!f)return null;if(f['expiration']&&f['expiration']<Math['floor'](Date['now']()/0x3e8))return await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run'](),null;if(c==='json')try{return JSON['parse'](f['value']);}catch(g){return console['error']('Failed\x20to\x20parse\x20JSON\x20for\x20key\x20'+b+':\x20'+g),null;}return f['value'];}catch(h){return console['error']('kvGet\x20error\x20for\x20'+b+':\x20'+h),null;}}async function kvPut(a,b,c,d={}){if(!a){console['error']('kvPut:\x20Database\x20not\x20available\x20for\x20key\x20'+b);return;}try{typeof c==='object'&&(c=JSON['stringify'](c));const f=d['expirationTtl']?Math['floor'](Date['now']()/0x3e8+d['expirationTtl']):null;await a['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20key_value\x20(key,\x20value,\x20expiration)\x20VALUES\x20(?,\x20?,\x20?)')['bind'](b,c,f)['run']();}catch(g){console['error']('kvPut\x20error\x20for\x20'+b+':\x20'+g);}}async function kvDelete(a,b){if(!a){console['error']('kvDelete:\x20Database\x20not\x20available\x20for\x20key\x20'+b);return;}try{await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run']();}catch(c){console['error']('kvDelete\x20error\x20for\x20'+b+':\x20'+c);}}async function getUserData(a,b,c){try{if(!isValidUUID(b))return null;if(!a['DB'])return console['error']('D1\x20binding\x20missing'),null;const d='user:'+b;try{const h=await kvGet(a['DB'],d,'json');if(h&&h['uuid'])return h;}catch(i){console['error']('Failed\x20to\x20get\x20cached\x20data\x20for\x20'+b,i);}const f=await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!f)return null;const g=kvPut(a['DB'],d,f,{'expirationTtl':0xe10});return c?c['waitUntil'](g):await g,f;}catch(j){return console['error']('getUserData\x20error\x20for\x20'+b+':\x20'+j['message']),null;}}async function updateUsage(a,b,c,d){if(c<=0x0||!b)return;if(!a['DB']){console['error']('updateUsage:\x20D1\x20binding\x20missing');return;}const f='usage_lock:'+b;let g=![];try{while(!g){const k=await kvGet(a['DB'],f);!k?(await kvPut(a['DB'],f,'locked',{'expirationTtl':0x5}),g=!![]):await new Promise(l=>setTimeout(l,0x64));}const h=Math['round'](c),i=a['DB']['prepare']('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](h,b)['run'](),j=kvDelete(a['DB'],'user:'+b);d?d['waitUntil'](Promise['all']([i,j])):await Promise['all']([i,j]);}catch(l){console['error']('Failed\x20to\x20update\x20usage\x20for\x20'+b+':',l);}finally{if(g)try{await kvDelete(a['DB'],f);}catch(m){console['error']('Failed\x20to\x20release\x20lock\x20for\x20'+b+':',m);}}}function generateRandomPath(a=0xc,b=''){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let d='';for(let e=0x0;e<a;e++){d+=c['charAt'](Math['floor'](Math['random']()*c['length']));}return'/'+d+(b?'?'+b:'');}function randomizeCase(a){let b='';for(let c=0x0;c<a['length'];c++){b+=Math['random']()<0.5?a[c]['toUpperCase']():a[c]['toLowerCase']();}return b;}const CORE_PRESETS={'xray':{'tls':{'path':()=>generateRandomPath(0xc,'ed=2560'),'security':'tls','fp':'chrome','alpn':'http/1.1','extra':{}},'tcp':{'path':()=>generateRandomPath(0xc,'ed=2560'),'security':'none','fp':'chrome','extra':{}}},'sb':{'tls':{'path':()=>generateRandomPath(0x12),'security':'tls','fp':'chrome','alpn':'http/1.1','extra':CONST['ED_PARAMS']},'tcp':{'path':()=>generateRandomPath(0x12),'security':'none','fp':'chrome','extra':CONST['ED_PARAMS']}}};function makeName(a,b){return a+'-'+b['toUpperCase']();}function createVlessLink({userID:a,address:b,port:c,host:d,path:e,security:f,sni:g,fp:h,alpn:i,extra:extra={},name:j}){const l=new URLSearchParams({'type':'ws','host':d,'path':e});f&&(l['set']('security',f),f==='tls'&&l['set']('allowInsecure','1'));if(g)l['set']('sni',g);if(h)l['set']('fp',h);if(i)l['set']('alpn',i);for(const [m,n]of Object['entries'](extra))l['set'](m,n);return'vless://'+a+'@'+b+':'+c+'?'+l['toString']()+'#'+encodeURIComponent(j);}function buildLink({core:a,proto:b,userID:c,hostName:d,address:e,port:f,tag:g}){const h=CORE_PRESETS[a][b];return createVlessLink({'userID':c,'address':e,'port':f,'host':d,'path':h['path'](),'security':h['security'],'sni':h['security']==='tls'?randomizeCase(d):undefined,'fp':h['fp'],'alpn':h['alpn'],'extra':h['extra'],'name':makeName(g,b)});}const pick=a=>a[Math['floor'](Math['random']()*a['length'])];async function handleIpSubscription(a,b,c){const d=[c,'creativecommons.org','www.speedtest.net','sky.rethinkdns.com','cfip.1323123.xyz','cfip.xxxxxxxx.tk','go.inmobi.com','singapore.com','www.visa.com','www.wto.org','cf.090227.xyz','cdnjs.com','zula.ir','csgo.com','fbi.gov'],f=[0x1bb,0x20fb,0x805,0x823,0x827,0x830],g=[0x50,0x1f90,0x22b0,0x804,0x822,0x826,0x82f];let h=[];const i=c['endsWith']('.pages.dev');d['forEach']((k,l)=>{h['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':k,'port':pick(f),'tag':'D'+(l+0x1)})),!i&&h['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':k,'port':pick(g),'tag':'D'+(l+0x1)}));});try{const k=await fetch('https://raw.githubusercontent.com/NiREvil/vless/refs/heads/main/Cloudflare-IPs.json');if(k['ok']){const l=await k['json'](),m=[...l['ipv4']||[],...l['ipv6']||[]]['slice'](0x0,0x14)['map'](n=>n['ip']);m['forEach']((n,o)=>{const p=n['includes'](':')?'['+n+']':n;h['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':p,'port':pick(f),'tag':'IP'+(o+0x1)})),!i&&h['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':p,'port':pick(g),'tag':'IP'+(o+0x1)}));});}}catch(n){console['error']('Fetch\x20IP\x20list\x20failed',n);}const j=new Headers({'Content-Type':'text/plain;charset=utf-8'});return addSecurityHeaders(j,null,{}),new Response(btoa(h['join']('\x0a')),{'headers':j});}async function hashSHA256(a){const b=new TextEncoder(),c=b['encode'](a),d=await crypto['subtle']['digest']('SHA-256',c),e=Array['from'](new Uint8Array(d));return e['map'](f=>f['toString'](0x10)['padStart'](0x2,'0'))['join']('');}async function checkRateLimit(a,b,c,d){if(!a)return![];try{const f=await kvGet(a,b),g=parseInt(f,0xa)||0x0;if(g>=c)return!![];return await kvPut(a,b,(g+0x1)['toString'](),{'expirationTtl':d}),![];}catch(h){return console['error']('checkRateLimit\x20error\x20for\x20'+b+':\x20'+h),![];}}async function isSuspiciousIP(a,b,c=CONST['SCAMALYTICS_THRESHOLD']){if(!b['username']||!b['apiKey'])return console['warn']('âš ï¸\x20\x20Scamalytics\x20API\x20credentials\x20not\x20configured.\x20IP\x20'+a+'\x20allowed\x20by\x20default\x20(fail-open\x20mode).'),![];const d=new AbortController(),f=setTimeout(()=>d['abort'](),0x1388);try{const g=b['baseUrl']+'score?username='+b['username']+'&ip='+a+'&key='+b['apiKey'],h=await fetch(g,{'signal':d['signal']});if(!h['ok'])return console['warn']('Scamalytics\x20API\x20returned\x20'+h['status']+'\x20for\x20'+a+'.\x20Allowing\x20(fail-open).'),![];const i=await h['json']();return i['score']>=c;}catch(j){return j['name']==='AbortError'?console['warn']('Scamalytics\x20timeout\x20for\x20'+a+'.\x20Allowing\x20(fail-open).'):console['error']('Scamalytics\x20error\x20for\x20'+a+':\x20'+j['message']+'.\x20Allowing\x20(fail-open).'),![];}finally{clearTimeout(f);}}function base32ToBuffer(a){const b='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567',c=a['toUpperCase']()['replace'](/=+$/,'');let d=0x0,e=0x0,f=0x0;const g=new Uint8Array(Math['floor'](c['length']*0x5/0x8));for(let h=0x0;h<c['length'];h++){const j=c[h],k=b['indexOf'](j);if(k===-0x1)throw new Error('Invalid\x20Base32\x20character');e=e<<0x5|k,d+=0x5,d>=0x8&&(g[f++]=e>>>d-0x8&0xff,d-=0x8);}return g['buffer'];}async function generateHOTP(a,b){const c=new ArrayBuffer(0x8),d=new DataView(c);d['setBigUint64'](0x0,BigInt(b),![]);const e=await crypto['subtle']['importKey']('raw',a,{'name':'HMAC','hash':'SHA-1'},![],['sign']),f=await crypto['subtle']['sign']('HMAC',e,c),g=new Uint8Array(f),h=g[g['length']-0x1]&0xf,i=(g[h]&0x7f)<<0x18|(g[h+0x1]&0xff)<<0x10|(g[h+0x2]&0xff)<<0x8|g[h+0x3]&0xff,j=i%0xf4240;return j['toString']()['padStart'](0x6,'0');}async function validateTOTP(a,b){if(!a||!b||b['length']!==0x6||!/^\d{6}$/['test'](b))return![];let c;try{c=base32ToBuffer(a);}catch(i){return console['error']('Failed\x20to\x20decode\x20TOTP\x20secret:',i['message']),![];}const d=0x1e,f=Math['floor'](Date['now']()/0x3e8),g=Math['floor'](f/d),h=[g,g-0x1,g+0x1];for(const j of h){const k=await generateHOTP(c,j);if(timingSafeEqual(b,k))return!![];}return![];}async function ensureTablesExist(a,b){if(!a['DB']){console['warn']('ensureTablesExist:\x20D1\x20binding\x20not\x20available,\x20skipping\x20table\x20creation');return;}try{const c=['CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20users\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20uuid\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20created_at\x20DATETIME\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20\x20\x20\x20\x20expiration_date\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20expiration_time\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20notes\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20traffic_limit\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20traffic_used\x20INTEGER\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ip_limit\x20INTEGER\x20DEFAULT\x20-1\x0a\x20\x20\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20user_ips\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20uuid\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ip\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20last_seen\x20DATETIME\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20\x20\x20\x20\x20PRIMARY\x20KEY\x20(uuid,\x20ip),\x0a\x20\x20\x20\x20\x20\x20\x20\x20FOREIGN\x20KEY\x20(uuid)\x20REFERENCES\x20users(uuid)\x20ON\x20DELETE\x20CASCADE\x0a\x20\x20\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20key_value\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20key\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20value\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20expiration\x20INTEGER\x0a\x20\x20\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20proxy_health\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20ip_port\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20is_healthy\x20INTEGER\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20latency_ms\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20last_check\x20INTEGER\x20DEFAULT\x20(strftime(\x27%s\x27,\x20\x27now\x27))\x0a\x20\x20\x20\x20\x20\x20)'],d=c['map'](f=>a['DB']['prepare'](f));await a['DB']['batch'](d),console['log']('D1\x20tables\x20ensured/created\x20successfully');}catch(f){console['error']('Failed\x20to\x20create\x20D1\x20tables:',f);}}const byteToHex=Array['from']({'length':0x100},(a,b)=>(b+0x100)['toString'](0x10)['slice'](0x1));function unsafeStringify(a,b=0x0){return(byteToHex[a[b]]+byteToHex[a[b+0x1]]+byteToHex[a[b+0x2]]+byteToHex[a[b+0x3]]+'-'+byteToHex[a[b+0x4]]+byteToHex[a[b+0x5]]+'-'+byteToHex[a[b+0x6]]+byteToHex[a[b+0x7]]+'-'+byteToHex[a[b+0x8]]+byteToHex[a[b+0x9]]+'-'+byteToHex[a[b+0xa]]+byteToHex[a[b+0xb]]+byteToHex[a[b+0xc]]+byteToHex[a[b+0xd]]+byteToHex[a[b+0xe]]+byteToHex[a[b+0xf]])['toLowerCase']();}function stringify(a,b=0x0){const c=unsafeStringify(a,b);if(!isValidUUID(c))throw new TypeError('Stringified\x20UUID\x20is\x20invalid');return c;}const adminLoginHTML='<!DOCTYPE\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20\x20\x20<meta\x20charset=\x22UTF-8\x22>\x0a\x20\x20\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>\x0a\x20\x20\x20\x20<title>Admin\x20Login</title>\x0a\x20\x20\x20\x20<style\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20display:\x20flex;\x20justify-content:\x20center;\x20align-items:\x20center;\x20height:\x20100vh;\x20margin:\x200;\x20background-color:\x20#121212;\x20font-family:\x20-apple-system,\x20BlinkMacSystemFont,\x20\x22Segoe\x20UI\x22,\x20Roboto,\x20Helvetica,\x20Arial,\x20sans-serif;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.login-container\x20{\x20background-color:\x20#1e1e1e;\x20padding:\x2040px;\x20border-radius:\x2012px;\x20box-shadow:\x200\x204px\x2020px\x20rgba(0,\x200,\x200,\x200.5);\x20text-align:\x20center;\x20width:\x20320px;\x20border:\x201px\x20solid\x20#333;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20h1\x20{\x20color:\x20#ffffff;\x20margin-bottom:\x2024px;\x20font-weight:\x20500;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20form\x20{\x20display:\x20flex;\x20flex-direction:\x20column;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20input[type=\x22password\x22],\x20input[type=\x22text\x22]\x20{\x20background-color:\x20#2c2c2c;\x20border:\x201px\x20solid\x20#444;\x20color:\x20#ffffff;\x20padding:\x2012px;\x20border-radius:\x208px;\x20margin-bottom:\x2020px;\x20font-size:\x2016px;\x20box-sizing:\x20border-box;\x20width:\x20100%;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20input[type=\x22password\x22]:focus,\x20input[type=\x22text\x22]:focus\x20{\x20outline:\x20none;\x20border-color:\x20#007aff;\x20box-shadow:\x200\x200\x200\x202px\x20rgba(0,\x20122,\x20255,\x200.3);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20button\x20{\x20background-color:\x20#007aff;\x20color:\x20white;\x20border:\x20none;\x20padding:\x2012px;\x20border-radius:\x208px;\x20font-size:\x2016px;\x20font-weight:\x20600;\x20cursor:\x20pointer;\x20transition:\x20background-color\x200.2s;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20button:hover\x20{\x20background-color:\x20#005ecb;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.error\x20{\x20color:\x20#ff3b30;\x20margin-top:\x2015px;\x20font-size:\x2014px;\x20}\x0a\x20\x20\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20\x20\x20<div\x20class=\x22login-container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<h1>Admin\x20Login</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<form\x20method=\x22POST\x22\x20action=\x22ADMIN_PATH_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22password\x22\x20name=\x22password\x22\x20placeholder=\x22Enter\x20admin\x20password\x22\x20required>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20name=\x22totp\x22\x20placeholder=\x22Enter\x20TOTP\x20code\x20(if\x20enabled)\x22\x20autocomplete=\x22off\x22\x20/>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20type=\x22submit\x22>Login</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</form>\x0a\x20\x20\x20\x20</div>\x0a</body>\x0a</html>',adminPanelHTML='<!DOCTYPE\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20\x20\x20<meta\x20charset=\x22UTF-8\x22>\x0a\x20\x20\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>\x0a\x20\x20\x20\x20<title>Admin\x20Dashboard</title>\x0a\x20\x20\x20\x20<style\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20:root\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20--bg-main:\x20#111827;\x20--bg-card:\x20#1F2937;\x20--border:\x20#374151;\x20--text-primary:\x20#F9FAFB;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20--text-secondary:\x20#9CA3AF;\x20--accent:\x20#3B82F6;\x20--accent-hover:\x20#2563EB;\x20--danger:\x20#EF4444;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20--danger-hover:\x20#DC2626;\x20--success:\x20#22C55E;\x20--expired:\x20#F59e0b;\x20--btn-secondary-bg:\x20#4B5563;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20margin:\x200;\x20font-family:\x20Inter,\x20system-ui,\x20-apple-system,\x20\x22Segoe\x20UI\x22,\x20Roboto,\x20sans-serif;\x20background-color:\x20var(--bg-main);\x20color:\x20var(--text-primary);\x20font-size:\x2014px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.container\x20{\x20max-width:\x201200px;\x20margin:\x2040px\x20auto;\x20padding:\x200\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20h1,\x20h2\x20{\x20font-weight:\x20600;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20h1\x20{\x20font-size:\x2024px;\x20margin-bottom:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20h2\x20{\x20font-size:\x2018px;\x20border-bottom:\x201px\x20solid\x20var(--border);\x20padding-bottom:\x2010px;\x20margin-bottom:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.card\x20{\x20background-color:\x20var(--bg-card);\x20border-radius:\x208px;\x20padding:\x2024px;\x20border:\x201px\x20solid\x20var(--border);\x20box-shadow:\x200\x204px\x206px\x20rgba(0,0,0,0.1);\x20margin-bottom:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.dashboard-stats\x20{\x20display:\x20grid;\x20grid-template-columns:\x20repeat(auto-fit,\x20minmax(200px,\x201fr));\x20gap:\x2016px;\x20margin-bottom:\x2024px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.stat-card\x20{\x20background:\x20#1F2937;\x20padding:\x2016px;\x20border-radius:\x208px;\x20text-align:\x20center;\x20border:\x201px\x20solid\x20var(--border);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.stat-value\x20{\x20font-size:\x2024px;\x20font-weight:\x20600;\x20color:\x20var(--accent);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.stat-label\x20{\x20font-size:\x2012px;\x20color:\x20var(--text-secondary);\x20text-transform:\x20uppercase;\x20margin-top:\x204px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.form-grid\x20{\x20display:\x20grid;\x20grid-template-columns:\x20repeat(auto-fit,minmax(200px,\x201fr));\x20gap:\x2016px;\x20align-items:\x20flex-end;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.form-group\x20{\x20display:\x20flex;\x20flex-direction:\x20column;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.form-group\x20label\x20{\x20margin-bottom:\x208px;\x20font-weight:\x20500;\x20color:\x20var(--text-secondary);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20input[type=\x22text\x22],\x20input[type=\x22date\x22],\x20input[type=\x22time\x22],\x20input[type=\x22number\x22],\x20select\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20width:\x20100%;\x20box-sizing:\x20border-box;\x20background-color:\x20#374151;\x20border:\x201px\x20solid\x20#4B5563;\x20color:\x20var(--text-primary);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20padding:\x2010px;\x20border-radius:\x206px;\x20font-size:\x2014px;\x20transition:\x20border-color\x200.2s;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20input:focus,\x20select:focus\x20{\x20outline:\x20none;\x20border-color:\x20var(--accent);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.btn\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20padding:\x2010px\x2016px;\x20border:\x20none;\x20border-radius:\x206px;\x20font-weight:\x20600;\x20cursor:\x20pointer;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20transition:\x20all\x200.2s;\x20display:\x20inline-flex;\x20align-items:\x20center;\x20justify-content:\x20center;\x20gap:\x208px;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.btn-primary\x20{\x20background-color:\x20var(--accent);\x20color:\x20white;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.btn-primary:hover\x20{\x20background-color:\x20var(--accent-hover);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.btn-secondary\x20{\x20background-color:\x20var(--btn-secondary-bg);\x20color:\x20white;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.btn-danger\x20{\x20background-color:\x20var(--danger);\x20color:\x20white;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.table-wrapper\x20{\x20overflow-x:\x20auto;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20table\x20{\x20width:\x20100%;\x20border-collapse:\x20collapse;\x20margin-top:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20th,\x20td\x20{\x20padding:\x2012px\x2016px;\x20text-align:\x20left;\x20border-bottom:\x201px\x20solid\x20var(--border);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20th\x20{\x20color:\x20var(--text-secondary);\x20font-weight:\x20600;\x20font-size:\x2012px;\x20text-transform:\x20uppercase;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.status-badge\x20{\x20padding:\x204px\x208px;\x20border-radius:\x2012px;\x20font-size:\x2012px;\x20font-weight:\x20600;\x20display:\x20inline-block;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.status-active\x20{\x20background-color:\x20var(--success);\x20color:\x20#064E3B;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20.status-expired\x20{\x20background-color:\x20var(--expired);\x20color:\x20#78350F;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20#toast\x20{\x20position:\x20fixed;\x20top:\x2020px;\x20right:\x2020px;\x20background-color:\x20var(--bg-card);\x20color:\x20white;\x20padding:\x2015px\x2020px;\x20border-radius:\x208px;\x20z-index:\x201001;\x20display:\x20none;\x20border:\x201px\x20solid\x20var(--border);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20#toast.show\x20{\x20display:\x20block;\x20}\x0a\x20\x20\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<h1>Admin\x20Dashboard</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22logoutBtn\x22\x20class=\x22btn\x20btn-danger\x22\x20style=\x22position:\x20absolute;\x20top:\x2020px;\x20right:\x2020px;\x22>Logout</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22healthCheckBtn\x22\x20class=\x22btn\x20btn-secondary\x22\x20style=\x22position:\x20absolute;\x20top:\x2020px;\x20right:\x20120px;\x22>Run\x20Health\x20Check</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22dashboard-stats\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><div\x20class=\x22stat-value\x22\x20id=\x22total-users\x22>0</div><div\x20class=\x22stat-label\x22>Total\x20Users</div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><div\x20class=\x22stat-value\x22\x20id=\x22active-users\x22>0</div><div\x20class=\x22stat-label\x22>Active\x20Users</div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><div\x20class=\x22stat-value\x22\x20id=\x22expired-users\x22>0</div><div\x20class=\x22stat-label\x22>Expired\x20Users</div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><div\x20class=\x22stat-value\x22\x20id=\x22total-traffic\x22>0\x20KB</div><div\x20class=\x22stat-label\x22>Total\x20Traffic\x20Used</div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h2>Create\x20User</h2>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<form\x20id=\x22createUserForm\x22\x20class=\x22form-grid\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label>UUID</label><input\x20type=\x22text\x22\x20id=\x22uuid\x22\x20required></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label>Expiry\x20Date</label><input\x20type=\x22date\x22\x20id=\x22expiryDate\x22\x20required></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label>Expiry\x20Time\x20(UTC)</label><input\x20type=\x22time\x22\x20id=\x22expiryTime\x22\x20step=\x221\x22\x20required></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label>Notes</label><input\x20type=\x22text\x22\x20id=\x22notes\x22\x20placeholder=\x22Optional\x22></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><button\x20type=\x22submit\x22\x20class=\x22btn\x20btn-primary\x22>Create\x20User</button></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</form>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h2>User\x20List</h2>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22table-wrapper\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<table>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<thead><tr><th>UUID</th><th>Created</th><th>Expiry</th><th>Status</th><th>Notes</th><th>Actions</th></tr></thead>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<tbody\x20id=\x22userList\x22></tbody>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</table>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20<div\x20id=\x22toast\x22></div>\x0a\x20\x20\x20\x20<script\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20API_BASE\x20=\x20\x27ADMIN_API_BASE_PATH_PLACEHOLDER\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20async\x20function\x20formatBytes(bytes)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(bytes\x20===\x200)\x20return\x20\x270\x20Bytes\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20k\x20=\x201024;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20sizes\x20=\x20[\x27Bytes\x27,\x20\x27KB\x27,\x20\x27MB\x27,\x20\x27GB\x27,\x20\x27TB\x27];\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20i\x20=\x20Math.floor(Math.log(bytes)\x20/\x20Math.log(k));\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return\x20parseFloat((bytes\x20/\x20Math.pow(k,\x20i)).toFixed(2))\x20+\x20\x27\x20\x27\x20+\x20sizes[i];\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20function\x20showToast(msg)\x20{\x20const\x20t\x20=\x20document.getElementById(\x27toast\x27);\x20t.textContent\x20=\x20msg;\x20t.classList.add(\x27show\x27);\x20setTimeout(()\x20=>\x20t.classList.remove(\x27show\x27),\x203000);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20getCsrfToken\x20=\x20()\x20=>\x20document.cookie.split(\x27;\x20\x27).find(row\x20=>\x20row.startsWith(\x27csrf_token=\x27))?.split(\x27=\x27)[1]\x20||\x20\x27\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20api\x20=\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20get:\x20(e)\x20=>\x20fetch(API_BASE\x20+\x20e,\x20{\x20credentials:\x20\x27include\x27\x20}).then(r\x20=>\x20r.json()),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20post:\x20(e,\x20b)\x20=>\x20fetch(API_BASE\x20+\x20e,\x20{\x20method:\x20\x27POST\x27,\x20credentials:\x20\x27include\x27,\x20headers:\x20{\x27Content-Type\x27:\x20\x27application/json\x27,\x20\x27X-CSRF-Token\x27:\x20getCsrfToken()},\x20body:\x20JSON.stringify(b)\x20}).then(r\x20=>\x20r.json()),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20delete:\x20(e)\x20=>\x20fetch(API_BASE\x20+\x20e,\x20{\x20method:\x20\x27DELETE\x27,\x20credentials:\x20\x27include\x27,\x20headers:\x20{\x27X-CSRF-Token\x27:\x20getCsrfToken()}\x20}).then(r\x20=>\x20r.json()),\x0a\x20\x20\x20\x20\x20\x20\x20\x20};\x0a\x20\x20\x20\x20\x20\x20\x20\x20async\x20function\x20fetchStats()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20stats\x20=\x20await\x20api.get(\x27/stats\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27total-users\x27).textContent\x20=\x20stats.total_users;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27active-users\x27).textContent\x20=\x20stats.active_users;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27expired-users\x27).textContent\x20=\x20stats.expired_users;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27total-traffic\x27).textContent\x20=\x20await\x20formatBytes(stats.total_traffic);\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20async\x20function\x20fetchUsers()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20users\x20=\x20await\x20api.get(\x27/users\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20list\x20=\x20document.getElementById(\x27userList\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20list.innerHTML\x20=\x20users.map(u\x20=>\x20`<tr><td>${u.uuid.substring(0,\x208)}...</td><td>${new\x20Date(u.created_at).toLocaleString()}</td><td>${u.expiration_date}\x20${u.expiration_time}</td><td><span\x20class=\x22status-badge\x20status-active\x22>Active</span></td><td>${u.notes\x20||\x20\x27-\x27}</td><td><button\x20class=\x22btn\x20btn-danger\x22\x20onclick=\x22deleteUser(\x27${u.uuid}\x27)\x22>Delete</button></td></tr>`).join(\x27\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20async\x20function\x20deleteUser(uuid)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(confirm(\x27Delete\x20user?\x27))\x20{\x20await\x20api.delete(\x27/users/\x27\x20+\x20uuid);\x20showToast(\x27User\x20deleted\x27);\x20fetchUsers();\x20fetchStats();\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27createUserForm\x27).addEventListener(\x27submit\x27,\x20async\x20(e)\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20e.preventDefault();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20await\x20api.post(\x27/users\x27,\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uuid:\x20document.getElementById(\x27uuid\x27).value,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20exp_date:\x20document.getElementById(\x27expiryDate\x27).value,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20exp_time:\x20document.getElementById(\x27expiryTime\x27).value,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20notes:\x20document.getElementById(\x27notes\x27).value\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x27User\x20created\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20e.target.reset();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27uuid\x27).value\x20=\x20crypto.randomUUID();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20fetchUsers();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20fetchStats();\x0a\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27logoutBtn\x27).addEventListener(\x27click\x27,\x20async\x20()\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20await\x20api.post(\x27/logout\x27,\x20{});\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20location.reload();\x0a\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27healthCheckBtn\x27).addEventListener(\x27click\x27,\x20async\x20()\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20await\x20api.post(\x27/health-check\x27,\x20{});\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x27Health\x20check\x20completed\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27uuid\x27).value\x20=\x20crypto.randomUUID();\x0a\x20\x20\x20\x20\x20\x20\x20\x20fetchUsers();\x0a\x20\x20\x20\x20\x20\x20\x20\x20fetchStats();\x0a\x20\x20\x20\x20\x20\x20\x20\x20setInterval(()\x20=>\x20{\x20fetchUsers();\x20fetchStats();\x20},\x2060000);\x0a\x20\x20\x20\x20</script>\x0a</body>\x0a</html>';async function isAdmin(a,b){const c=a['headers']['get']('Cookie');if(!c)return![];const d=c['match'](/auth_token=([^;]+)/)?.[0x1];if(!d)return![];const e=await hashSHA256(d),f=await kvGet(b['DB'],'admin_session_token_hash');return f&&timingSafeEqual(e,f);}async function handleAdminRequest(a,b,c,d){try{await ensureTablesExist(b,c);const f=new URL(a['url']),g={'Content-Type':'application/json'},h=new Headers({'Content-Type':'text/html;charset=utf-8'}),i=a['headers']['get']('CF-Connecting-IP');if(!b['ADMIN_KEY'])return addSecurityHeaders(h,null,{}),new Response('Admin\x20panel\x20is\x20not\x20configured.',{'status':0x1f7,'headers':h});if(b['ADMIN_IP_WHITELIST']){const m=b['ADMIN_IP_WHITELIST']['split'](',')['map'](n=>n['trim']());if(!m['includes'](i))return addSecurityHeaders(h,null,{}),new Response('Access\x20denied.',{'status':0x193,'headers':h});}const j='/'+d+'/'+b['ADMIN_KEY'];if(!f['pathname']['startsWith'](j)){const n=new Headers();return addSecurityHeaders(n,null,{}),new Response('Not\x20found',{'status':0x194,'headers':n});}const k=f['pathname']['substring'](j['length'])||'/';if(k['startsWith']('/api/')){if(!b['DB']){const q=new Headers(g);return addSecurityHeaders(q,null,{}),new Response(JSON['stringify']({'error':'Database\x20not\x20configured'}),{'status':0x1f7,'headers':q});}if(!await isAdmin(a,b)){const r=new Headers(g);return addSecurityHeaders(r,null,{}),new Response(JSON['stringify']({'error':'Forbidden'}),{'status':0x193,'headers':r});}if(a['method']!=='GET'){const s=a['headers']['get']('X-CSRF-Token'),t=a['headers']['get']('Cookie')?.['match'](/csrf_token=([^;]+)/)?.[0x1];if(!s||!t||!timingSafeEqual(s,t)){const u=new Headers(g);return addSecurityHeaders(u,null,{}),new Response(JSON['stringify']({'error':'CSRF\x20validation\x20failed'}),{'status':0x193,'headers':u});}}if(k==='/api/stats'&&a['method']==='GET'){const v=new Headers(g);addSecurityHeaders(v,null,{});try{const w=await b['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users')['first']('count'),x=await b['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users\x20WHERE\x20datetime(expiration_date\x20||\x20\x27T\x27\x20||\x20expiration_time\x20||\x20\x27Z\x27)\x20<\x20datetime(\x27now\x27)')['first'](),y=x?.['count']||0x0,z=w-y,A=await b['DB']['prepare']('SELECT\x20SUM(traffic_used)\x20as\x20sum\x20FROM\x20users')['first'](),B=A?.['sum']||0x0;return new Response(JSON['stringify']({'total_users':w,'active_users':z,'expired_users':y,'total_traffic':B}),{'status':0xc8,'headers':v});}catch(C){return new Response(JSON['stringify']({'error':C['message']}),{'status':0x1f4,'headers':v});}}if(k==='/api/users'&&a['method']==='GET'){const D=new Headers(g);addSecurityHeaders(D,null,{});try{const {results:E}=await b['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20ORDER\x20BY\x20created_at\x20DESC')['all']();return new Response(JSON['stringify'](E??[]),{'status':0xc8,'headers':D});}catch(F){return new Response(JSON['stringify']({'error':F['message']}),{'status':0x1f4,'headers':D});}}if(k==='/api/users'&&a['method']==='POST'){const G=new Headers(g);addSecurityHeaders(G,null,{});try{const {uuid:H,exp_date:I,exp_time:J,notes:K,traffic_limit:L,ip_limit:M}=await a['json']();return await b['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20expiration_date,\x20expiration_time,\x20notes,\x20traffic_limit,\x20ip_limit,\x20traffic_used)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x200)')['bind'](H,I,J,K||null,L||null,M||-0x1)['run'](),c['waitUntil'](kvPut(b['DB'],'user:'+H,{'uuid':H,'expiration_date':I,'expiration_time':J,'notes':K,'traffic_limit':L,'ip_limit':M,'traffic_used':0x0},{'expirationTtl':0xe10})),new Response(JSON['stringify']({'success':!![],'uuid':H}),{'status':0xc9,'headers':G});}catch(N){return new Response(JSON['stringify']({'error':N['message']}),{'status':0x190,'headers':G});}}const o=k['match'](/^\/api\/users\/([a-f0-9-]+)$/);if(o&&a['method']==='DELETE'){const O=new Headers(g);addSecurityHeaders(O,null,{});const P=o[0x1];try{return await b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](P)['run'](),c['waitUntil'](kvDelete(b['DB'],'user:'+P)),new Response(JSON['stringify']({'success':!![]}),{'status':0xc8,'headers':O});}catch(Q){return new Response(JSON['stringify']({'error':Q['message']}),{'status':0x1f4,'headers':O});}}if(k==='/api/logout'&&a['method']==='POST'){const R=new Headers(g);addSecurityHeaders(R,null,{});try{return await kvDelete(b['DB'],'admin_session_token_hash'),R['append']('Set-Cookie','auth_token=;\x20Max-Age=0;\x20Path=/;\x20Secure;\x20HttpOnly;\x20SameSite=Strict'),R['append']('Set-Cookie','csrf_token=;\x20Max-Age=0;\x20Path=/;\x20Secure;\x20SameSite=Strict'),new Response(JSON['stringify']({'success':!![]}),{'status':0xc8,'headers':R});}catch(S){return new Response(JSON['stringify']({'error':S['message']}),{'status':0x1f4,'headers':R});}}if(k==='/api/health-check'&&a['method']==='POST'){const T=new Headers(g);addSecurityHeaders(T,null,{});try{return await performHealthCheck(b,c),new Response(JSON['stringify']({'success':!![]}),{'status':0xc8,'headers':T});}catch(U){return new Response(JSON['stringify']({'error':U['message']}),{'status':0x1f4,'headers':T});}}const p=new Headers(g);return addSecurityHeaders(p,null,{}),new Response(JSON['stringify']({'error':'API\x20route\x20not\x20found'}),{'status':0x194,'headers':p});}if(k==='/'){if(a['method']==='POST'){const V='login_fail_ip:'+i,W=await kvGet(b['DB'],V),X=parseInt(W,0xa)||0x0;if(X>=CONST['ADMIN_LOGIN_FAIL_LIMIT'])return addSecurityHeaders(h,null,{}),new Response('Too\x20many\x20failed\x20login\x20attempts.',{'status':0x1ad,'headers':h});const Y=await a['formData']();if(timingSafeEqual(Y['get']('password'),b['ADMIN_KEY'])){if(b['ADMIN_TOTP_SECRET']){const a3=Y['get']('totp');if(!await validateTOTP(b['ADMIN_TOTP_SECRET'],a3)){c['waitUntil'](kvPut(b['DB'],V,(X+0x1)['toString'](),{'expirationTtl':CONST['ADMIN_LOGIN_LOCK_TTL']}));const a4=generateNonce();addSecurityHeaders(h,a4,{});let a5=adminLoginHTML['replace']('</form>','</form><p\x20class=\x22error\x22>Invalid\x20TOTP\x20code.</p>');return a5=a5['replace'](/CSP_NONCE_PLACEHOLDER/g,a4),a5=a5['replace']('action=\x22ADMIN_PATH_PLACEHOLDER\x22','action=\x22'+j+'\x22'),new Response(a5,{'status':0x191,'headers':h});}}const Z=crypto['randomUUID'](),a0=crypto['randomUUID'](),a1=await hashSHA256(Z);c['waitUntil'](Promise['all']([kvPut(b['DB'],'admin_session_token_hash',a1,{'expirationTtl':0x15180}),kvDelete(b['DB'],V)]));const a2=new Headers({'Location':j});return a2['append']('Set-Cookie','auth_token='+Z+';\x20HttpOnly;\x20Secure;\x20Path='+j+';\x20Max-Age=86400;\x20SameSite=Strict'),a2['append']('Set-Cookie','csrf_token='+a0+';\x20Secure;\x20Path='+j+';\x20Max-Age=86400;\x20SameSite=Strict'),addSecurityHeaders(a2,null,{}),new Response(null,{'status':0x12e,'headers':a2});}else{c['waitUntil'](kvPut(b['DB'],V,(X+0x1)['toString'](),{'expirationTtl':CONST['ADMIN_LOGIN_LOCK_TTL']}));const a6=generateNonce();addSecurityHeaders(h,a6,{});let a7=adminLoginHTML['replace']('</form>','</form><p\x20class=\x22error\x22>Invalid\x20password.</p>');return a7=a7['replace'](/CSP_NONCE_PLACEHOLDER/g,a6),a7=a7['replace']('action=\x22ADMIN_PATH_PLACEHOLDER\x22','action=\x22'+j+'\x22'),new Response(a7,{'status':0x191,'headers':h});}}if(a['method']==='GET'){const a8=generateNonce();addSecurityHeaders(h,a8,{});let a9;return await isAdmin(a,b)?(a9=adminPanelHTML,a9=a9['replace']('\x27ADMIN_API_BASE_PATH_PLACEHOLDER\x27','\x27'+j+'/api\x27')):(a9=adminLoginHTML,a9=a9['replace']('action=\x22ADMIN_PATH_PLACEHOLDER\x22','action=\x22'+j+'\x22')),a9=a9['replace'](/CSP_NONCE_PLACEHOLDER/g,a8),new Response(a9,{'headers':h});}}const l=new Headers();return addSecurityHeaders(l,null,{}),new Response('Not\x20found',{'status':0x194,'headers':l});}catch(aa){console['error']('handleAdminRequest\x20error:',aa['message']);const ab=new Headers();return addSecurityHeaders(ab,null,{}),new Response('Internal\x20Server\x20Error',{'status':0x1f4,'headers':ab});}}async function handleUserPanel(a,b,c,d,f,g){try{const h='https://'+c+'/xray/'+b,i='https://'+c+'/sb/'+b,j=buildLink({'core':'xray','proto':'tls','userID':b,'hostName':c,'address':c,'port':0x1bb,'tag':'Main'}),k=buildLink({'core':'sb','proto':'tls','userID':b,'hostName':c,'address':c,'port':0x1bb,'tag':'Main'}),l={'universalAndroid':'v2rayng://install-config?url='+encodeURIComponent(h),'shadowrocket':'shadowrocket://add/sub?url='+encodeURIComponent(h)+'&name='+encodeURIComponent(c)},m=isExpired(f['expiration_date'],f['expiration_time']),n=f['expiration_date']&&f['expiration_time']?f['expiration_date']+'T'+f['expiration_time']+'Z':null;let o=0x0;f['traffic_limit']&&f['traffic_limit']>0x0&&(o=Math['min']((f['traffic_used']||0x0)/f['traffic_limit']*0x64,0x64));const p=a['cf']||{},q={'city':p['city']||'','country':p['country']||'','isp':p['asOrganization']||''},r='<!doctype\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20<meta\x20charset=\x22utf-8\x22\x20/>\x0a\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,initial-scale=1\x22\x20/>\x0a\x20\x20<title>User\x20Panel\x20â€”\x20VLESS\x20Configuration</title>\x0a\x20\x20<style\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20:root{\x20--bg:#0b1220;\x20--card:#0f1724;\x20--accent:#3b82f6;\x20--success:#22c55e;\x20--danger:#ef4444;\x20}\x0a\x20\x20\x20\x20*\x20{\x20box-sizing:border-box\x20}\x0a\x20\x20\x20\x20body\x20{\x20margin:0;\x20font-family:\x20Inter,\x20system-ui;\x20background:\x20linear-gradient(180deg,#061021\x200%,\x20#071323\x20100%);\x20color:#e6eef8;\x20min-height:100vh;\x20padding:28px;\x20}\x0a\x20\x20\x20\x20.container\x20{\x20max-width:1100px;\x20margin:0\x20auto\x20}\x0a\x20\x20\x20\x20.card\x20{\x20background:var(--card);\x20border-radius:12px;\x20padding:20px;\x20margin-bottom:20px;\x20border:1px\x20solid\x20rgba(255,255,255,0.03);\x20}\x0a\x20\x20\x20\x20h1\x20{\x20font-size:28px;\x20margin:0\x200\x2010px\x20}\x0a\x20\x20\x20\x20.stat\x20{\x20padding:14px;\x20background:rgba(255,255,255,0.02);\x20border-radius:10px;\x20text-align:center;\x20}\x0a\x20\x20\x20\x20.stat\x20.val\x20{\x20font-weight:700;\x20font-size:22px;\x20margin-bottom:4px\x20}\x0a\x20\x20\x20\x20.btn\x20{\x20padding:11px\x2016px;\x20border-radius:8px;\x20border:none;\x20cursor:pointer;\x20font-weight:600;\x20transition:all\x200.2s;\x20}\x0a\x20\x20\x20\x20.btn.primary\x20{\x20background:linear-gradient(135deg,var(--accent),#60a5fa);\x20color:#fff;\x20}\x0a\x20\x20\x20\x20pre.config\x20{\x20background:#071529;\x20padding:14px;\x20border-radius:8px;\x20overflow:auto;\x20font-family:monospace;\x20font-size:13px;\x20}\x0a\x20\x20\x20\x20.hidden\x20{\x20display:none\x20}\x0a\x20\x20\x20\x20#qr-display\x20{\x20min-height:280px;\x20display:flex;\x20align-items:center;\x20justify-content:center;\x20}\x0a\x20\x20\x20\x20#toast\x20{\x20position:fixed;\x20right:20px;\x20top:20px;\x20background:#0f1b2a;\x20padding:14px\x2018px;\x20border-radius:10px;\x20display:none;\x20z-index:1000;\x20}\x0a\x20\x20\x20\x20#toast.show\x20{\x20display:block\x20}\x0a\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20<h1>ðŸš€\x20VXR.SXR\x20Configuration\x20Panel</h1>\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat\x22><div\x20class=\x22val\x22\x20id=\x22status-badge\x22>'+(m?'Expired':'Active')+'</div></div>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20<h2>ðŸ“±\x20Xray\x20Subscription</h2>\x0a\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20primary\x22\x20id=\x22copy-xray-sub\x22>ðŸ“‹\x20Copy\x20Xray\x20Link</button>\x0a\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x22\x20id=\x22show-xray-config\x22>View\x20Config</button>\x0a\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x22\x20id=\x22qr-xray-btn\x22>QR\x20Code</button>\x0a\x20\x20\x20\x20\x20\x20<pre\x20class=\x22config\x20hidden\x22\x20id=\x22xray-config\x22>'+escapeHTML(j)+'</pre>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20<h2>ðŸ“±\x20Sing-Box\x20Subscription</h2>\x0a\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20primary\x22\x20id=\x22copy-sb-sub\x22>ðŸ“‹\x20Copy\x20Singbox\x20Link</button>\x0a\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x22\x20id=\x22show-sb-config\x22>View\x20Config</button>\x0a\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x22\x20id=\x22qr-sb-btn\x22>QR\x20Code</button>\x0a\x20\x20\x20\x20\x20\x20<pre\x20class=\x22config\x20hidden\x22\x20id=\x22sb-config\x22>'+escapeHTML(k)+'</pre>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20<h2>QR\x20Code\x20Scanner</h2>\x0a\x20\x20\x20\x20\x20\x20<div\x20id=\x22qr-display\x22><p>Click\x20any\x20\x22QR\x20Code\x22\x20button\x20to\x20generate.</p></div>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20</div>\x0a\x20\x20<div\x20id=\x22toast\x22></div>\x0a\x20\x20<script\x20nonce=\x22CSP_NONCE_PLACEHOLDER\x22>\x0a\x20\x20\x20\x20window.CONFIG\x20=\x20{\x0a\x20\x20\x20\x20\x20\x20uuid:\x20\x22'+b+'\x22,\x0a\x20\x20\x20\x20\x20\x20subXrayUrl:\x20\x22'+h+'\x22,\x0a\x20\x20\x20\x20\x20\x20subSbUrl:\x20\x22'+i+'\x22,\x0a\x20\x20\x20\x20\x20\x20singleXrayConfig:\x20'+JSON['stringify'](j)+',\x0a\x20\x20\x20\x20\x20\x20singleSingboxConfig:\x20'+JSON['stringify'](k)+',\x0a\x20\x20\x20\x20};\x0a\x20\x20\x20\x20\x0a\x20\x20\x20\x20function\x20showToast(msg)\x20{\x20const\x20t\x20=\x20document.getElementById(\x27toast\x27);\x20t.textContent\x20=\x20msg;\x20t.classList.add(\x27show\x27);\x20setTimeout(()\x20=>\x20t.classList.remove(\x27show\x27),\x202000);\x20}\x0a\x20\x20\x20\x20\x0a\x20\x20\x20\x20async\x20function\x20copyToClipboard(text,\x20button)\x20{\x0a\x20\x20\x20\x20\x20\x20try\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20await\x20navigator.clipboard.writeText(text);\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20orig\x20=\x20button.innerHTML;\x0a\x20\x20\x20\x20\x20\x20\x20\x20button.innerHTML\x20=\x20\x27âœ“\x20Copied!\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20setTimeout(()\x20=>\x20button.innerHTML\x20=\x20orig,\x202000);\x0a\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x27Copied\x20to\x20clipboard!\x27);\x0a\x20\x20\x20\x20\x20\x20}\x20catch\x20(e)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x27Failed\x20to\x20copy\x27);\x0a\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x0a\x20\x20\x20\x20//\x20Simple\x20QR\x20Code\x20Generator\x0a\x20\x20\x20\x20const\x20QRCodeGenerator\x20=\x20(function()\x20{\x0a\x20\x20\x20\x20\x20\x20function\x20generate(text,\x20size)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20canvas\x20=\x20document.createElement(\x22canvas\x22);\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20qrSize\x20=\x2025;\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20cellSize\x20=\x20Math.floor(size\x20/\x20qrSize);\x0a\x20\x20\x20\x20\x20\x20\x20\x20canvas.width\x20=\x20canvas.height\x20=\x20qrSize\x20*\x20cellSize;\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20ctx\x20=\x20canvas.getContext(\x222d\x22);\x0a\x20\x20\x20\x20\x20\x20\x20\x20ctx.fillStyle\x20=\x20\x22#ffffff\x22;\x0a\x20\x20\x20\x20\x20\x20\x20\x20ctx.fillRect(0,\x200,\x20canvas.width,\x20canvas.height);\x0a\x20\x20\x20\x20\x20\x20\x20\x20ctx.fillStyle\x20=\x20\x22#000000\x22;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20//\x20Simple\x20pattern\x20(not\x20real\x20QR,\x20just\x20demonstration)\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(let\x20row\x20=\x200;\x20row\x20<\x20qrSize;\x20row++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20for\x20(let\x20col\x20=\x200;\x20col\x20<\x20qrSize;\x20col++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20((row\x20+\x20col)\x20%\x202\x20===\x200\x20||\x20(row\x20===\x20col))\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ctx.fillRect(col\x20*\x20cellSize,\x20row\x20*\x20cellSize,\x20cellSize,\x20cellSize);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20canvas;\x0a\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20return\x20{\x20generate\x20};\x0a\x20\x20\x20\x20})();\x0a\x20\x20\x20\x20\x0a\x20\x20\x20\x20function\x20generateQRCode(data)\x20{\x0a\x20\x20\x20\x20\x20\x20const\x20display\x20=\x20document.getElementById(\x27qr-display\x27);\x0a\x20\x20\x20\x20\x20\x20display.innerHTML\x20=\x20\x27<div\x20style=\x22background:#fff;padding:16px;border-radius:10px;display:inline-block;\x22></div>\x27;\x0a\x20\x20\x20\x20\x20\x20const\x20container\x20=\x20display.querySelector(\x27div\x27);\x0a\x20\x20\x20\x20\x20\x20const\x20canvas\x20=\x20QRCodeGenerator.generate(data,\x20256);\x0a\x20\x20\x20\x20\x20\x20container.appendChild(canvas);\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x0a\x20\x20\x20\x20document.getElementById(\x27copy-xray-sub\x27).addEventListener(\x27click\x27,\x20function()\x20{\x20copyToClipboard(window.CONFIG.subXrayUrl,\x20this);\x20});\x0a\x20\x20\x20\x20document.getElementById(\x27copy-sb-sub\x27).addEventListener(\x27click\x27,\x20function()\x20{\x20copyToClipboard(window.CONFIG.subSbUrl,\x20this);\x20});\x0a\x20\x20\x20\x20document.getElementById(\x27show-xray-config\x27).addEventListener(\x27click\x27,\x20()\x20=>\x20document.getElementById(\x27xray-config\x27).classList.toggle(\x27hidden\x27));\x0a\x20\x20\x20\x20document.getElementById(\x27show-sb-config\x27).addEventListener(\x27click\x27,\x20()\x20=>\x20document.getElementById(\x27sb-config\x27).classList.toggle(\x27hidden\x27));\x0a\x20\x20\x20\x20document.getElementById(\x27qr-xray-btn\x27).addEventListener(\x27click\x27,\x20()\x20=>\x20generateQRCode(window.CONFIG.singleXrayConfig));\x0a\x20\x20\x20\x20document.getElementById(\x27qr-sb-btn\x27).addEventListener(\x27click\x27,\x20()\x20=>\x20generateQRCode(window.CONFIG.singleSingboxConfig));\x0a\x20\x20</script>\x0a</body>\x0a</html>',s=generateNonce(),t=new Headers({'Content-Type':'text/html;charset=utf-8'});addSecurityHeaders(t,s,{});let u=r['replace'](/CSP_NONCE_PLACEHOLDER/g,s);return new Response(u,{'headers':t});}catch(v){console['error']('handleUserPanel\x20error:',v['message']);const w=new Headers();return addSecurityHeaders(w,null,{}),new Response('Internal\x20Server\x20Error',{'status':0x1f4,'headers':w});}}async function ProtocolOverWSHandler(a,b,c,d){let f=null;try{const g=a['headers']['get']('CF-Connecting-IP'),h=new WebSocketPair(),[i,j]=Object['values'](h);f=j,f['accept']();let k='',l='',m=0x0,n='',o=null;const p=(w,x)=>console['log']('['+k+':'+l+']\x20'+w,x||''),q=()=>{if(m>0x0&&n){const w=m,x=n;m=0x0,d['waitUntil'](updateUsage(c,x,w,d));}},r=setInterval(q,0x2710),s=()=>{clearInterval(r),q();};f['addEventListener']('close',s,{'once':!![]}),f['addEventListener']('error',s,{'once':!![]});const t=a['headers']['get']('Sec-WebSocket-Protocol')||'',u=MakeReadableWebSocketStream(f,t,p);let v={'value':null};return u['pipeTo'](new WritableStream({async 'write'(w,x){m+=w['byteLength'];if(o)return o['write'](w);if(v['value']){const G=v['value']['writable']['getWriter']();await G['write'](w),G['releaseLock']();return;}const {user:y,hasError:z,message:A,addressType:B,portRemote:portRemote=0x1bb,addressRemote:addressRemote='',rawDataIndex:C,ProtocolVersion:ProtocolVersion=new Uint8Array([0x0,0x0]),isUDP:D}=await ProcessProtocolHeader(w,c,d);if(z||!y){x['error'](new Error('Authentication\x20failed'));return;}n=y['uuid'];if(isExpired(y['expiration_date'],y['expiration_time'])){x['error'](new Error('Authentication\x20failed'));return;}if(y['traffic_limit']&&y['traffic_limit']>0x0){const H=(y['traffic_used']||0x0)+m;if(H>=y['traffic_limit']){x['error'](new Error('Authentication\x20failed'));return;}}if(y['ip_limit']&&y['ip_limit']>-0x1){const I=await c['DB']['prepare']('SELECT\x20COUNT(DISTINCT\x20ip)\x20as\x20count\x20FROM\x20user_ips\x20WHERE\x20uuid\x20=\x20?')['bind'](n)['first']('count');if(I>=y['ip_limit']){x['error'](new Error('IP\x20limit\x20exceeded'));return;}await c['DB']['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20user_ips\x20(uuid,\x20ip,\x20last_seen)\x20VALUES\x20(?,\x20?,\x20CURRENT_TIMESTAMP)')['bind'](n,g)['run']();}k=addressRemote,l=portRemote+'--'+Math['random']()+'\x20'+(D?'udp':'tcp');const E=new Uint8Array([ProtocolVersion[0x0],0x0]),F=w['slice'](C);if(D){if(portRemote===0x35){const J=await createDnsPipeline(f,E,p,K=>{m+=K;});o=J['write'],await o(F);}else x['error'](new Error('Authentication\x20failed'));return;}HandleTCPOutBound(v,B,addressRemote,portRemote,F,f,E,p,b,K=>{m+=K;});},'close'(){p('readableWebSocketStream\x20closed'),s();},'abort'(w){p('readableWebSocketStream\x20aborted',w),s();}}))['catch'](w=>{console['error']('Pipeline\x20failed:',w),safeCloseWebSocket(f),s();}),new Response(null,{'status':0x65,'webSocket':i});}catch(w){console['error']('ProtocolOverWSHandler\x20error:',w['message']);if(f)safeCloseWebSocket(f);const x=new Headers();return addSecurityHeaders(x,null,{}),new Response('Internal\x20Server\x20Error',{'status':0x1f4,'headers':x});}}async function ProcessProtocolHeader(a,b,c){try{if(a['byteLength']<0x18)return{'hasError':!![],'message':'invalid\x20data'};const d=new DataView(a['buffer']||a),f=d['getUint8'](0x0);let g;try{g=stringify(new Uint8Array(a['slice'](0x1,0x11)));}catch(u){return{'hasError':!![],'message':'invalid\x20UUID\x20format'};}const h=await getUserData(b,g,c);if(!h)return{'hasError':!![],'message':'invalid\x20user'};const i=0x11;if(a['byteLength']<i+0x1)return{'hasError':!![],'message':'invalid\x20data\x20length'};const j=d['getUint8'](i),k=i+0x1+j;if(a['byteLength']<k+0x1)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(command)'};const l=d['getUint8'](k);if(l!==0x1&&l!==0x2)return{'hasError':!![],'message':'command\x20'+l+'\x20not\x20supported'};const m=k+0x1;if(a['byteLength']<m+0x2)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(port)'};const n=d['getUint16'](m,![]),o=m+0x2;if(a['byteLength']<o+0x1)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(address\x20type)'};const p=d['getUint8'](o);let q,r,s;switch(p){case 0x1:r=0x4,s=o+0x1;if(a['byteLength']<s+r)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(ipv4)'};q=new Uint8Array(a['slice'](s,s+r))['join']('.');break;case 0x2:if(a['byteLength']<o+0x2)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(domain\x20length)'};r=d['getUint8'](o+0x1),s=o+0x2;if(a['byteLength']<s+r)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(domain)'};q=new TextDecoder()['decode'](a['slice'](s,s+r));break;case 0x3:r=0x10,s=o+0x1;if(a['byteLength']<s+r)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(ipv6)'};q=Array['from']({'length':0x8},(v,w)=>d['getUint16'](s+w*0x2,![])['toString'](0x10))['join'](':');break;default:return{'hasError':!![],'message':'invalid\x20addressType:\x20'+p};}const t=s+r;if(a['byteLength']<t)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(raw\x20data)'};return{'user':h,'hasError':![],'addressRemote':q,'addressType':p,'portRemote':n,'rawDataIndex':t,'ProtocolVersion':new Uint8Array([f]),'isUDP':l===0x2};}catch(v){return console['error']('ProcessProtocolHeader\x20error:',v['message']),{'hasError':!![],'message':'protocol\x20processing\x20error'};}}async function HandleTCPOutBound(a,b,c,d,e,f,g,h,i,j){async function k(n,o,p=![]){let q;i['socks5Relay']||p?q=await socks5Connect(b,n,o,h,i['parsedSocks5Address']):q=connect({'hostname':n,'port':o});a['value']=q,h('connected\x20to\x20'+n+':'+o);const r=q['writable']['getWriter']();return await r['write'](e),r['releaseLock'](),q;}async function l(){const n=i['enableSocks']?await k(c,d,!![]):await k(i['proxyIP']||c,i['proxyPort']||d,![]);n['closed']['catch'](o=>console['log']('retry\x20tcpSocket\x20closed\x20error',o))['finally'](()=>safeCloseWebSocket(f)),RemoteSocketToWS(n,f,g,null,h,j);}const m=await k(c,d);RemoteSocketToWS(m,f,g,l,h,j);}function MakeReadableWebSocketStream(a,b,c){return new ReadableStream({'start'(d){a['addEventListener']('message',g=>d['enqueue'](g['data'])),a['addEventListener']('close',()=>{safeCloseWebSocket(a),d['close']();}),a['addEventListener']('error',g=>{c('webSocketServer\x20has\x20error'),d['error'](g);});const {earlyData:e,error:f}=base64ToArrayBuffer(b);if(f)d['error'](f);else{if(e)d['enqueue'](e);}},'pull'(d){},'cancel'(d){c('ReadableStream\x20canceled:\x20'+d),safeCloseWebSocket(a);}});}async function RemoteSocketToWS(a,b,c,d,e,f){let g=![];return await a['readable']['pipeTo'](new WritableStream({async 'write'(h,i){if(b['readyState']!==CONST['WS_READY_STATE_OPEN']){i['error']('webSocket\x20not\x20open');return;}g=!![],c?(b['send'](await new Blob([c,h])['arrayBuffer']()),c=null):b['send'](h);},'close'(){e('remoteSocket\x20closed,\x20hasIncomingData:\x20'+g);},'abort'(h){console['error']('remoteSocket\x20abort',h);}}))['catch'](h=>{console['error']('remoteSocket\x20pipeTo\x20error',h),safeCloseWebSocket(b);}),g;}function base64ToArrayBuffer(a){if(!a)return{'earlyData':null,'error':null};try{const b=atob(a['replace'](/-/g,'+')['replace'](/_/g,'/')),c=new ArrayBuffer(b['length']),d=new Uint8Array(c);for(let e=0x0;e<b['length'];e++)d[e]=b['charCodeAt'](e);return{'earlyData':c,'error':null};}catch(f){return{'earlyData':null,'error':f};}}function safeCloseWebSocket(a){try{(a['readyState']===CONST['WS_READY_STATE_OPEN']||a['readyState']===CONST['WS_READY_STATE_CLOSING'])&&a['close']();}catch(b){console['error']('safeCloseWebSocket\x20error:',b);}}async function createDnsPipeline(a,b,c,d){let e=![];const f=new TransformStream({'transform'(h,i){for(let j=0x0;j<h['byteLength'];){if(j+0x2>h['byteLength'])break;const k=h['slice'](j,j+0x2),l=new DataView(k)['getUint16'](0x0);if(j+0x2+l>h['byteLength'])break;const m=new Uint8Array(h['slice'](j+0x2,j+0x2+l));j=j+0x2+l,i['enqueue'](m);}}});f['readable']['pipeTo'](new WritableStream({async 'write'(h){try{const i=await fetch('https://1.1.1.1/dns-query',{'method':'POST','headers':{'content-type':'application/dns-message'},'body':h}),j=await i['arrayBuffer'](),k=j['byteLength'],l=new Uint8Array([k>>0x8&0xff,k&0xff]);if(a['readyState']===CONST['WS_READY_STATE_OPEN']){c('DNS\x20query\x20successful,\x20length:\x20'+k);let m;e?m=await new Blob([l,j])['arrayBuffer']():(m=await new Blob([b,l,j])['arrayBuffer'](),e=!![]);if(d)d(m['byteLength']);a['send'](m);}}catch(n){c('DNS\x20query\x20error:\x20'+n);}}}))['catch'](h=>c('DNS\x20stream\x20error:\x20'+h));const g=f['writable']['getWriter']();return{'write':h=>g['write'](h)};}function parseIPv6(a){const b=new ArrayBuffer(0x10),c=new DataView(b),d=a['split']('::');let e=d[0x0]?d[0x0]['split'](':'):[],f=d[0x1]?d[0x1]['split'](':'):[];if(e['length']===0x1&&e[0x0]==='')e=[];if(f['length']===0x1&&f[0x0]==='')f=[];const g=0x8-(e['length']+f['length']),h=[];if(g>0x0){for(let k=0x0;k<g;k++)h['push']('0000');}const j=[...e,...h,...f];for(let l=0x0;l<0x8;l++){const m=parseInt(j[l]||'0',0x10);c['setUint16'](l*0x2,m,![]);}return new Uint8Array(b);}async function socks5Connect(a,b,c,d,e){const {username:f,password:g,hostname:h,port:i}=e;let j,k,l,m=![];try{j=connect({'hostname':h,'port':i}),k=j['readable']['getReader'](),l=j['writable']['getWriter']();const n=new TextEncoder();await l['write'](new Uint8Array([0x5,0x2,0x0,0x2]));let o=(await k['read']())['value'];if(!o||o[0x0]!==0x5||o[0x1]===0xff)throw new Error('SOCKS5\x20handshake\x20failed');if(o[0x1]===0x2){if(!f||!g)throw new Error('SOCKS5\x20requires\x20credentials');const r=new Uint8Array([0x1,f['length'],...n['encode'](f),g['length'],...n['encode'](g)]);await l['write'](r),o=(await k['read']())['value'];if(!o||o[0x0]!==0x1||o[0x1]!==0x0)throw new Error('SOCKS5\x20authentication\x20failed');}let p;switch(a){case 0x1:p=new Uint8Array([0x1,...b['split']('.')['map'](Number)]);break;case 0x2:p=new Uint8Array([0x3,b['length'],...n['encode'](b)]);break;case 0x3:const s=parseIPv6(b);p=new Uint8Array(0x1+0x10),p[0x0]=0x4,p['set'](s,0x1);break;default:throw new Error('Invalid\x20address\x20type:\x20'+a);}const q=new Uint8Array([0x5,0x1,0x0,...p,c>>0x8,c&0xff]);await l['write'](q),o=(await k['read']())['value'];if(!o||o[0x1]!==0x0)throw new Error('SOCKS5\x20connection\x20failed');return d('SOCKS5\x20connected\x20to\x20'+b+':'+c),m=!![],j;}catch(t){d('socks5Connect\x20Error:\x20'+t['message'],t);throw t;}finally{if(l)l['releaseLock']();if(k)k['releaseLock']();if(!m&&j)j['abort']();}}function socks5AddressParser(a){if(!a||typeof a!=='string')throw new Error('Invalid\x20SOCKS5\x20address\x20format');const [b,c]=a['includes']('@')?a['split']('@'):[null,a],d=c['lastIndexOf'](':');if(d===-0x1)throw new Error('Invalid\x20SOCKS5\x20address:\x20missing\x20port');let e;if(c['startsWith']('[')){const j=c['lastIndexOf'](']');if(j===-0x1||j>d)throw new Error('Invalid\x20IPv6\x20SOCKS5\x20address\x20format');e=c['substring'](0x1,j);}else e=c['substring'](0x0,d);const f=c['substring'](d+0x1),g=parseInt(f,0xa);if(!e||isNaN(g))throw new Error('Invalid\x20SOCKS5\x20address');let h,i;if(b)[h,i]=b['split'](':');return{'username':h,'password':i,'hostname':e,'port':g};}async function performHealthCheck(a,b){if(!a['DB']){console['warn']('performHealthCheck:\x20D1\x20binding\x20not\x20available');return;}const c=a['PROXYIPS']?a['PROXYIPS']['split'](',')['map'](f=>f['trim']()):Config['proxyIPs'],d=[];for(const f of c){const [g,h='443']=f['split'](':');let i=null,j=0x0;const k=Date['now']();try{const l=new AbortController(),m=setTimeout(()=>l['abort'](),CONST['HEALTH_CHECK_TIMEOUT']),n=await fetch('https://'+g+':'+h,{'signal':l['signal']});clearTimeout(m),n['ok']&&(i=Date['now']()-k,j=0x1);}catch(o){console['error']('Health\x20check\x20failed\x20for\x20'+f+':\x20'+o['message']);}d['push'](a['DB']['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20proxy_health\x20(ip_port,\x20is_healthy,\x20latency_ms,\x20last_check)\x20VALUES\x20(?,\x20?,\x20?,\x20?)')['bind'](f,j,i,Date['now']()));}try{await a['DB']['batch'](d),console['log']('Proxy\x20health\x20check\x20completed.');}catch(p){console['error']('performHealthCheck\x20batch\x20error:\x20'+p['message']);}}export default{async 'fetch'(a,b,c){try{await ensureTablesExist(b,c);let d;try{d=await Config['fromEnv'](b);}catch(n){console['error']('Configuration\x20Error:\x20'+n['message']);const o=new Headers();return addSecurityHeaders(o,null,{}),new Response('Service\x20temporarily\x20unavailable',{'status':0x1f7,'headers':o});}const f=new URL(a['url']),g=a['headers']['get']('CF-Connecting-IP'),h=b['ADMIN_PATH_PREFIX']||'admin';if(f['pathname']['startsWith']('/'+h+'/'))return await handleAdminRequest(a,b,c,h);if(f['pathname']==='/health'){const p=new Headers();return addSecurityHeaders(p,null,{}),new Response('OK',{'status':0xc8,'headers':p});}if(f['pathname']==='/health-check'&&a['method']==='GET'){await performHealthCheck(b,c);const q=new Headers();return addSecurityHeaders(q,null,{}),new Response('Health\x20check\x20performed',{'status':0xc8,'headers':q});}if(f['pathname']['startsWith']('/api/user/')){const r=f['pathname']['substring']('/api/user/'['length']),s=new Headers({'Content-Type':'application/json'});addSecurityHeaders(s,null,{});if(a['method']!=='GET')return new Response(JSON['stringify']({'error':'Method\x20Not\x20Allowed'}),{'status':0x195,'headers':s});if(!isValidUUID(r))return new Response(JSON['stringify']({'error':'Invalid\x20UUID'}),{'status':0x190,'headers':s});const t=await getUserData(b,r,c);if(!t)return new Response(JSON['stringify']({'error':'Authentication\x20failed'}),{'status':0x193,'headers':s});return new Response(JSON['stringify']({'traffic_used':t['traffic_used']||0x0,'traffic_limit':t['traffic_limit'],'expiration_date':t['expiration_date'],'expiration_time':t['expiration_time']}),{'status':0xc8,'headers':s});}if(f['pathname']==='/favicon.ico')return new Response(null,{'status':0x12d,'headers':{'Location':'https://www.google.com/favicon.ico'}});const i=a['headers']['get']('Upgrade');if(i?.['toLowerCase']()==='websocket'){if(!b['DB']){const B=new Headers();return addSecurityHeaders(B,null,{}),new Response('Service\x20not\x20configured\x20properly',{'status':0x1f7,'headers':B});}const u=b['HOST_HEADERS']?b['HOST_HEADERS']['split'](',')['map'](C=>C['trim']()):['speed.cloudflare.com'],v=pick(u),w=new Headers(a['headers']);w['set']('Host',v);const x=new Request(a,{'headers':w}),y={'userID':d['userID'],'proxyIP':d['proxyIP'],'proxyPort':d['proxyPort'],'socks5Address':d['socks5']['address'],'socks5Relay':d['socks5']['relayMode'],'enableSocks':d['socks5']['enabled'],'parsedSocks5Address':d['socks5']['enabled']?socks5AddressParser(d['socks5']['address']):{},'scamalytics':d['scamalytics']},z=await ProtocolOverWSHandler(x,y,b,c),A=new Headers(z['headers']);return addSecurityHeaders(A,null,{}),new Response(z['body'],{'status':z['status'],'webSocket':z['webSocket'],'headers':A});}const j=async C=>{const D='user_path_rate:'+g;if(await checkRateLimit(b['DB'],D,CONST['USER_PATH_RATE_LIMIT'],CONST['USER_PATH_RATE_TTL'])){const G=new Headers();return addSecurityHeaders(G,null,{}),new Response('Rate\x20limit\x20exceeded',{'status':0x1ad,'headers':G});}const E=f['pathname']['substring'](('/'+C+'/')['length']);if(!isValidUUID(E)){const H=new Headers();return addSecurityHeaders(H,null,{}),new Response('Invalid\x20UUID',{'status':0x190,'headers':H});}const F=await getUserData(b,E,c);if(!F||isExpired(F['expiration_date'],F['expiration_time'])||F['traffic_limit']&&F['traffic_limit']>0x0&&(F['traffic_used']||0x0)>=F['traffic_limit']){const I=new Headers();return addSecurityHeaders(I,null,{}),new Response('Authentication\x20failed',{'status':0x193,'headers':I});}return await handleIpSubscription(C,E,f['hostname']);};if(f['pathname']['startsWith']('/xray/'))return await j('xray');if(f['pathname']['startsWith']('/sb/'))return await j('sb');const k=f['pathname']['slice'](0x1);if(isValidUUID(k)){const C='user_path_rate:'+g;if(await checkRateLimit(b['DB'],C,CONST['USER_PATH_RATE_LIMIT'],CONST['USER_PATH_RATE_TTL'])){const E=new Headers();return addSecurityHeaders(E,null,{}),new Response('Rate\x20limit\x20exceeded',{'status':0x1ad,'headers':E});}const D=await getUserData(b,k,c);if(!D){const F=new Headers();return addSecurityHeaders(F,null,{}),new Response('Authentication\x20failed',{'status':0x193,'headers':F});}return await handleUserPanel(a,k,f['hostname'],d['proxyAddress'],D,g);}if(b['ROOT_PROXY_URL'])try{const G=new URL(b['ROOT_PROXY_URL']),H=new URL(a['url']);H['hostname']=G['hostname'],H['protocol']=G['protocol'];if(G['port'])H['port']=G['port'];const I=new Request(H['toString'](),{'method':a['method'],'headers':a['headers'],'body':a['body'],'redirect':'manual'});I['headers']['set']('Host',G['hostname']),I['headers']['set']('X-Forwarded-For',g),I['headers']['set']('X-Real-IP',g);const J=await fetch(I),K=new Headers(J['headers']);return K['delete']('content-security-policy-report-only'),K['set']('Content-Security-Policy','default-src\x20\x27self\x27\x20\x27unsafe-inline\x27\x20\x27unsafe-eval\x27\x20data:\x20blob:\x20*;\x20frame-ancestors\x20\x27self\x27;'),K['set']('X-Frame-Options','SAMEORIGIN'),new Response(J['body'],{'status':J['status'],'statusText':J['statusText'],'headers':K});}catch(L){console['error']('Reverse\x20Proxy\x20Error:\x20'+L['message']);const M=new Headers();return addSecurityHeaders(M,null,{}),new Response('Proxy\x20error:\x20'+L['message'],{'status':0x1f6,'headers':M});}const l='<!DOCTYPE\x20html><html><head><title>Welcome\x20to\x20nginx!</title></head><body><h1>Welcome\x20to\x20nginx!</h1><p>If\x20you\x20see\x20this\x20page,\x20the\x20nginx\x20web\x20server\x20is\x20successfully\x20installed\x20and\x20working.</p></body></html>',m=new Headers({'Content-Type':'text/html'});return addSecurityHeaders(m,null,{}),new Response(l,{'headers':m});}catch(N){console['error']('Fetch\x20handler\x20error:',N['message']);const O=new Headers();return addSecurityHeaders(O,null,{}),new Response('Internal\x20Server\x20Error',{'status':0x1f4,'headers':O});}}};