// <!--GAMFC-->version base on commit: 42dec017c52d0dc8fdd590c5c314e0c2dae115dd - last update: 2025-12-14 19:47:52 UTC <!--GAMFC-END-->.

import{connect}from'cloudflare:sockets';const Config={'userID':'d342d11e-d424-4583-b36e-524ab1f0afa4','proxyIPs':['nima.nscl.ir:443','bpb.yousef.isegaro.com:443'],'scamalytics':{'username':'victoriacrossn','apiKey':'ed89b4fef21aba43c15cdd15cff2138dd8d3bbde5aaaa4690ad8e94990448516','baseUrl':'https://api12.scamalytics.com/v3/'},'socks5':{'enabled':![],'relayMode':![],'address':''},async 'fromEnv'(a){let b=null;if(a['DB'])try{const {results:f}=await a['DB']['prepare']('SELECT\x20ip_port\x20FROM\x20proxy_health\x20WHERE\x20is_healthy\x20=\x201\x20ORDER\x20BY\x20latency_ms\x20ASC\x20LIMIT\x201')['all']();b=f[0x0]?.['ip_port']||null,b&&console['log']('Using\x20best\x20healthy\x20proxy\x20from\x20DB:\x20'+b);}catch(g){console['error']('Failed\x20to\x20read\x20proxy\x20health\x20from\x20DB:\x20'+g['message']);}!b&&(b=a['PROXYIP'],b&&console['log']('Using\x20proxy\x20from\x20env.PROXYIP:\x20'+b));!b&&(b=this['proxyIPs'][Math['floor'](Math['random']()*this['proxyIPs']['length'])],b&&console['log']('Using\x20proxy\x20from\x20config\x20list:\x20'+b));!b&&(console['error']('CRITICAL:\x20No\x20proxy\x20IP\x20available'),b=this['proxyIPs'][0x0]);const [c,d='443']=b['split'](':');return{'userID':a['UUID']||this['userID'],'proxyIP':c,'proxyPort':parseInt(d,0xa),'proxyAddress':b,'scamalytics':{'username':a['SCAMALYTICS_USERNAME']||this['scamalytics']['username'],'apiKey':a['SCAMALYTICS_API_KEY']||this['scamalytics']['apiKey'],'baseUrl':a['SCAMALYTICS_BASEURL']||this['scamalytics']['baseUrl']},'socks5':{'enabled':!!a['SOCKS5'],'relayMode':a['SOCKS5_RELAY']==='true'||this['socks5']['relayMode'],'address':a['SOCKS5']||this['socks5']['address']}};}},CONST={'ED_PARAMS':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'},'VLESS_PROTOCOL':'vless','WS_READY_STATE_OPEN':0x1,'WS_READY_STATE_CLOSING':0x2,'ADMIN_LOGIN_FAIL_LIMIT':0x5,'ADMIN_LOGIN_LOCK_TTL':0x258,'SCAMALYTICS_THRESHOLD':0x32,'USER_PATH_RATE_LIMIT':0x14,'USER_PATH_RATE_TTL':0x3c,'AUTO_REFRESH_INTERVAL':0xea60,'IP_CLEANUP_AGE_DAYS':0x1e,'HEALTH_CHECK_INTERVAL':0x493e0,'HEALTH_CHECK_TIMEOUT':0x1388};function generateNonce(){const a=new Uint8Array(0x10);return crypto['getRandomValues'](a),btoa(String['fromCharCode']['apply'](null,a));}function addSecurityHeaders(a,b,c={}){const d=b?'script-src\x20\x27self\x27\x20\x27nonce-'+b+'\x27\x20\x27unsafe-inline\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com':'script-src\x20\x27self\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com\x20\x27unsafe-inline\x27',e='img-src\x20\x27self\x27\x20data:\x20blob:\x20https:\x20'+(c['img']||''),f='connect-src\x20\x27self\x27\x20https:\x20wss:\x20'+(c['connect']||''),g=['default-src\x20\x27self\x27','form-action\x20\x27self\x27','object-src\x20\x27none\x27','frame-ancestors\x20\x27none\x27','base-uri\x20\x27self\x27',d,'style-src\x20\x27self\x27\x20\x27unsafe-inline\x27\x20\x27unsafe-hashes\x27',e['trim'](),f['trim'](),'worker-src\x20\x27self\x27\x20blob:','child-src\x20\x27self\x27\x20blob:'];a['set']('Content-Security-Policy',g['join'](';\x20')),a['set']('Strict-Transport-Security','max-age=63072000;\x20includeSubDomains;\x20preload'),a['set']('X-Content-Type-Options','nosniff'),a['set']('X-Frame-Options','SAMEORIGIN'),a['set']('Referrer-Policy','strict-origin-when-cross-origin'),a['set']('Permissions-Policy','camera=(),\x20microphone=(),\x20geolocation=(),\x20payment=(),\x20usb=()'),a['set']('alt-svc','h3=\x22:443\x22;\x20ma=0'),a['set']('Cross-Origin-Opener-Policy','same-origin'),a['set']('Cross-Origin-Embedder-Policy','unsafe-none'),a['set']('Cross-Origin-Resource-Policy','cross-origin');}function timingSafeEqual(c,d){if(typeof c!=='string'||typeof d!=='string')return![];const e=c['length'],f=d['length'];let g=0x0;if(e!==f){for(let h=0x0;h<e;h++){g|=c['charCodeAt'](h)^c['charCodeAt'](h);}return![];}for(let j=0x0;j<e;j++){g|=c['charCodeAt'](j)^d['charCodeAt'](j);}return g===0x0;}function escapeHTML(a){if(typeof a!=='string')return'';return a['replace'](/[&<>"']/g,function(b){const c={'&':'&amp;','<':'&lt;','>':'&gt;','\x22':'&quot;','\x27':'&#39;'};return c[b];});}function safeBase64Encode(a){try{const b=new TextEncoder(),c=b['encode'](a);let d='';for(let f=0x0;f<c['length'];f++){d+=String['fromCharCode'](c[f]);}return btoa(d);}catch(g){return btoa(unescape(encodeURIComponent(a)));}}function generateUUID(){return crypto['randomUUID']();}function isValidUUID(a){if(typeof a!=='string')return![];const b=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return b['test'](a);}function isExpired(a,b){if(!a||!b)return!![];const c=b['includes'](':')&&b['split'](':')['length']===0x2?b+':00':b,d=c['split']('.')[0x0],e=new Date(a+'T'+d+'Z');return e<=new Date()||isNaN(e['getTime']());}function formatBytes(a){if(a===0x0)return'0\x20Bytes';const b=0x400,c=['Bytes','KB','MB','GB','TB'],d=Math['floor'](Math['log'](a)/Math['log'](b));return parseFloat((a/Math['pow'](b,d))['toFixed'](0x2))+'\x20'+c[d];}async function kvGet(a,b,c='text'){if(!a)return console['error']('kvGet:\x20Database\x20not\x20available\x20for\x20key\x20'+b),null;try{const d=a['prepare']('SELECT\x20value,\x20expiration\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b),f=await d['first']();if(!f)return null;if(f['expiration']&&f['expiration']<Math['floor'](Date['now']()/0x3e8))return await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run'](),null;if(c==='json')try{return JSON['parse'](f['value']);}catch(g){return console['error']('Failed\x20to\x20parse\x20JSON\x20for\x20key\x20'+b+':\x20'+g),null;}return f['value'];}catch(h){return console['error']('kvGet\x20error\x20for\x20'+b+':\x20'+h),null;}}async function kvPut(a,b,c,d={}){if(!a){console['error']('kvPut:\x20Database\x20not\x20available\x20for\x20key\x20'+b);return;}try{typeof c==='object'&&(c=JSON['stringify'](c));const f=d['expirationTtl']?Math['floor'](Date['now']()/0x3e8+d['expirationTtl']):null;await a['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20key_value\x20(key,\x20value,\x20expiration)\x20VALUES\x20(?,\x20?,\x20?)')['bind'](b,c,f)['run']();}catch(g){console['error']('kvPut\x20error\x20for\x20'+b+':\x20'+g);}}async function kvDelete(a,b){if(!a){console['error']('kvDelete:\x20Database\x20not\x20available\x20for\x20key\x20'+b);return;}try{await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run']();}catch(c){console['error']('kvDelete\x20error\x20for\x20'+b+':\x20'+c);}}async function getUserData(a,b,c){try{if(!isValidUUID(b))return null;if(!a['DB'])return console['error']('D1\x20binding\x20missing'),null;const d='user:'+b;try{const h=await kvGet(a['DB'],d,'json');if(h&&h['uuid'])return h;}catch(i){console['error']('Failed\x20to\x20get\x20cached\x20data\x20for\x20'+b,i);}const f=await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!f)return null;const g=kvPut(a['DB'],d,f,{'expirationTtl':0xe10});return c?c['waitUntil'](g):await g,f;}catch(j){return console['error']('getUserData\x20error\x20for\x20'+b+':\x20'+j['message']),null;}}async function updateUsage(a,b,c,d){if(c<=0x0||!b)return;if(!a['DB']){console['error']('updateUsage:\x20D1\x20binding\x20missing');return;}const f='usage_lock:'+b;let g=![];try{while(!g){const k=await kvGet(a['DB'],f);!k?(await kvPut(a['DB'],f,'locked',{'expirationTtl':0x5}),g=!![]):await new Promise(l=>setTimeout(l,0x64));}const h=Math['round'](c),i=a['DB']['prepare']('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](h,b)['run'](),j=kvDelete(a['DB'],'user:'+b);d?d['waitUntil'](Promise['all']([i,j])):await Promise['all']([i,j]);}catch(l){console['error']('Failed\x20to\x20update\x20usage\x20for\x20'+b+':',l);}finally{if(g)try{await kvDelete(a['DB'],f);}catch(m){console['error']('Failed\x20to\x20release\x20lock\x20for\x20'+b+':',m);}}}async function cleanupOldIps(a,b){if(!a['DB']){console['warn']('cleanupOldIps:\x20D1\x20binding\x20not\x20available');return;}try{const c=a['DB']['prepare']('DELETE\x20FROM\x20user_ips\x20WHERE\x20last_seen\x20<\x20datetime(\x27now\x27,\x20?)')['bind']('-'+CONST['IP_CLEANUP_AGE_DAYS']+'\x20days')['run']();b?b['waitUntil'](c):await c;}catch(d){console['error']('cleanupOldIps\x20error:\x20'+d['message']);}}async function isSuspiciousIP(a,b,c=CONST['SCAMALYTICS_THRESHOLD']){if(!b['username']||!b['apiKey'])return console['warn']('Scamalytics\x20not\x20configured.\x20IP\x20'+a+'\x20allowed\x20(fail-open).'),![];const d=new AbortController(),f=setTimeout(()=>d['abort'](),0x1388);try{const g=b['baseUrl']+'score?username='+b['username']+'&ip='+a+'&key='+b['apiKey'],h=await fetch(g,{'signal':d['signal']});if(!h['ok'])return console['warn']('Scamalytics\x20API\x20returned\x20'+h['status']+'\x20for\x20'+a+'.\x20Allowing\x20(fail-open).'),![];const i=await h['json']();return i['score']>=c;}catch(j){return j['name']==='AbortError'?console['warn']('Scamalytics\x20timeout\x20for\x20'+a+'.\x20Allowing\x20(fail-open).'):console['error']('Scamalytics\x20error\x20for\x20'+a+':\x20'+j['message']+'.\x20Allowing\x20(fail-open).'),![];}finally{clearTimeout(f);}}function base32ToBuffer(a){const b='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567',c=a['toUpperCase']()['replace'](/=+$/,'');let d=0x0,e=0x0,f=0x0;const g=new Uint8Array(Math['floor'](c['length']*0x5/0x8));for(let h=0x0;h<c['length'];h++){const j=c[h],k=b['indexOf'](j);if(k===-0x1)throw new Error('Invalid\x20Base32\x20character');e=e<<0x5|k,d+=0x5,d>=0x8&&(g[f++]=e>>>d-0x8&0xff,d-=0x8);}return g['buffer'];}async function generateHOTP(a,b){const c=new ArrayBuffer(0x8),d=new DataView(c);d['setBigUint64'](0x0,BigInt(b),![]);const e=await crypto['subtle']['importKey']('raw',a,{'name':'HMAC','hash':'SHA-1'},![],['sign']),f=await crypto['subtle']['sign']('HMAC',e,c),g=new Uint8Array(f),h=g[g['length']-0x1]&0xf,i=(g[h]&0x7f)<<0x18|(g[h+0x1]&0xff)<<0x10|(g[h+0x2]&0xff)<<0x8|g[h+0x3]&0xff,j=i%0xf4240;return j['toString']()['padStart'](0x6,'0');}async function validateTOTP(a,b){if(!a||!b||b['length']!==0x6||!/^\d{6}$/['test'](b))return![];let c;try{c=base32ToBuffer(a);}catch(i){return console['error']('Failed\x20to\x20decode\x20TOTP\x20secret:',i['message']),![];}const d=0x1e,f=Math['floor'](Date['now']()/0x3e8),g=Math['floor'](f/d),h=[g,g-0x1,g+0x1];for(const j of h){const k=await generateHOTP(c,j);if(timingSafeEqual(b,k))return!![];}return![];}async function hashSHA256(a){const b=new TextEncoder(),c=b['encode'](a),d=await crypto['subtle']['digest']('SHA-256',c),e=Array['from'](new Uint8Array(d));return e['map'](function(f){return f['toString'](0x10)['padStart'](0x2,'0');})['join']('');}async function checkRateLimit(a,b,c,d){if(!a)return![];try{const f=await kvGet(a,b),g=parseInt(f,0xa)||0x0;if(g>=c)return!![];return await kvPut(a,b,(g+0x1)['toString'](),{'expirationTtl':d}),![];}catch(h){return console['error']('checkRateLimit\x20error\x20for\x20'+b+':\x20'+h),![];}}const byteToHex=Array['from']({'length':0x100},function(a,b){return(b+0x100)['toString'](0x10)['slice'](0x1);});function unsafeStringify(a,b){return b=b||0x0,(byteToHex[a[b]]+byteToHex[a[b+0x1]]+byteToHex[a[b+0x2]]+byteToHex[a[b+0x3]]+'-'+byteToHex[a[b+0x4]]+byteToHex[a[b+0x5]]+'-'+byteToHex[a[b+0x6]]+byteToHex[a[b+0x7]]+'-'+byteToHex[a[b+0x8]]+byteToHex[a[b+0x9]]+'-'+byteToHex[a[b+0xa]]+byteToHex[a[b+0xb]]+byteToHex[a[b+0xc]]+byteToHex[a[b+0xd]]+byteToHex[a[b+0xe]]+byteToHex[a[b+0xf]])['toLowerCase']();}function stringify(a,b){b=b||0x0;const c=unsafeStringify(a,b);if(!isValidUUID(c))throw new TypeError('Stringified\x20UUID\x20is\x20invalid');return c;}function generateRandomPath(a){a=a||0xc;const b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let c='';for(let d=0x0;d<a;d++){c+=b['charAt'](Math['floor'](Math['random']()*b['length']));}return'/'+c;}function makeName(a,b){return a+'-'+b['toUpperCase']();}function randomizeCase(a){let b='';for(let c=0x0;c<a['length'];c++){b+=Math['random']()<0.5?a[c]['toUpperCase']():a[c]['toLowerCase']();}return b;}function createVlessLink(a){const b=new URLSearchParams({'encryption':'none','type':'ws','host':a['host'],'path':a['path']});a['security']&&(b['set']('security',a['security']),a['security']==='tls'&&b['set']('allowInsecure','1'));if(a['sni'])b['set']('sni',a['sni']);if(a['fp'])b['set']('fp',a['fp']);if(a['alpn'])b['set']('alpn',a['alpn']);if(a['extra'])for(const c in a['extra']){b['set'](c,a['extra'][c]);}return'vless://'+a['userID']+'@'+a['address']+':'+a['port']+'?'+b['toString']()+'#'+encodeURIComponent(a['name']);}function buildLink(a){const b={'xray':{'tls':{'security':'tls','fp':'chrome','alpn':'http/1.1','extra':{'ed':'2560'}},'tcp':{'security':'none','fp':'chrome','extra':{'ed':'2560'}}},'sb':{'tls':{'security':'tls','fp':'firefox','alpn':'h3','extra':CONST['ED_PARAMS']},'tcp':{'security':'none','fp':'firefox','extra':CONST['ED_PARAMS']}}},c=b[a['core']][a['proto']];return createVlessLink({'userID':a['userID'],'address':a['address'],'port':a['port'],'host':a['hostName'],'path':generateRandomPath(a['core']==='sb'?0x12:0xc),'security':c['security'],'sni':c['security']==='tls'?randomizeCase(a['hostName']):undefined,'fp':c['fp'],'alpn':c['alpn'],'extra':c['extra'],'name':makeName(a['tag'],a['proto'])});}function pick(a){return a[Math['floor'](Math['random']()*a['length'])];}async function handleIpSubscription(a,b,c){const d=[c,'creativecommons.org','www.speedtest.net','sky.rethinkdns.com','cfip.1323123.xyz','go.inmobi.com','www.visa.com','www.wto.org','cf.090227.xyz','cdnjs.com','zula.ir','mail.tm','temp-mail.org','ipaddress.my','mdbmax.com','check-host.net','kodambroker.com','iplocation.io','whatismyip.org','www.linkedin.com','exir.io','arzex.io','ok-ex.io','arzdigital.com','pouyanit.com','auth.grok.com','grok.com','maxmind.com','whatsmyip.com','iplocation.net','ipchicken.com','showmyip.com','router-network.com','whatismyipaddress.com'],f=[0x1bb,0x20fb,0x805,0x823,0x827,0x830],g=[0x50,0x1f90,0x22b0,0x804,0x822,0x826,0x82f];var h=[];const i=c['endsWith']('.pages.dev');d['forEach'](function(k,l){h['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':k,'port':pick(f),'tag':'D'+(l+0x1)})),!i&&h['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':k,'port':pick(g),'tag':'D'+(l+0x1)}));});try{const k=await fetch('https://raw.githubusercontent.com/NiREvil/vless/refs/heads/main/Cloudflare-IPs.json');if(k['ok']){const l=await k['json'](),m=l['ipv4']||[],n=l['ipv6']||[],o=m['concat'](n)['slice'](0x0,0x14)['map'](function(p){return p['ip'];});o['forEach'](function(p,q){const s=p['includes'](':')?'['+p+']':p;h['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':s,'port':pick(f),'tag':'IP'+(q+0x1)})),!i&&h['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':s,'port':pick(g),'tag':'IP'+(q+0x1)}));});}}catch(p){console['error']('Fetch\x20IP\x20list\x20failed',p);}const j=new Headers({'Content-Type':'text/plain;charset=utf-8','Profile-Update-Interval':'6'});return addSecurityHeaders(j,null,{}),new Response(safeBase64Encode(h['join']('\x0a')),{'headers':j});}async function ensureTablesExist(a,b){if(!a['DB']){console['warn']('ensureTablesExist:\x20D1\x20binding\x20not\x20available');return;}try{const c=['CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20users\x20(uuid\x20TEXT\x20PRIMARY\x20KEY,\x20created_at\x20DATETIME\x20DEFAULT\x20CURRENT_TIMESTAMP,\x20expiration_date\x20TEXT\x20NOT\x20NULL,\x20expiration_time\x20TEXT\x20NOT\x20NULL,\x20notes\x20TEXT,\x20traffic_limit\x20INTEGER,\x20traffic_used\x20INTEGER\x20DEFAULT\x200,\x20ip_limit\x20INTEGER\x20DEFAULT\x20-1)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20user_ips\x20(uuid\x20TEXT,\x20ip\x20TEXT,\x20last_seen\x20DATETIME\x20DEFAULT\x20CURRENT_TIMESTAMP,\x20PRIMARY\x20KEY\x20(uuid,\x20ip),\x20FOREIGN\x20KEY\x20(uuid)\x20REFERENCES\x20users(uuid)\x20ON\x20DELETE\x20CASCADE)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20key_value\x20(key\x20TEXT\x20PRIMARY\x20KEY,\x20value\x20TEXT\x20NOT\x20NULL,\x20expiration\x20INTEGER)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20proxy_health\x20(ip_port\x20TEXT\x20PRIMARY\x20KEY,\x20is_healthy\x20INTEGER\x20NOT\x20NULL,\x20latency_ms\x20INTEGER,\x20last_check\x20INTEGER\x20DEFAULT\x20(strftime(\x27%s\x27,\x20\x27now\x27)))'],d=c['map'](function(j){return a['DB']['prepare'](j);});await a['DB']['batch'](d);const f=a['UUID']||Config['userID'],g=new Date();g['setMonth'](g['getMonth']()+0x1);const h=g['toISOString']()['split']('T')[0x0],i='23:59:59';try{await a['DB']['prepare']('INSERT\x20OR\x20IGNORE\x20INTO\x20users\x20(uuid,\x20expiration_date,\x20expiration_time,\x20notes,\x20traffic_limit,\x20traffic_used,\x20ip_limit)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)')['bind'](f,h,i,'Test\x20User\x20-\x20Development',null,0x40000000,-0x1)['run']();}catch(j){}console['log']('D1\x20tables\x20initialized\x20successfully');}catch(k){console['error']('Failed\x20to\x20create\x20D1\x20tables:',k);}}async function performHealthCheck(a,b){if(!a['DB']){console['warn']('performHealthCheck:\x20D1\x20binding\x20not\x20available');return;}const c=a['PROXYIPS']?a['PROXYIPS']['split'](',')['map'](function(i){return i['trim']();}):Config['proxyIPs'],d=[];for(var f=0x0;f<c['length'];f++){const i=c[f],j=i['split'](':'),k=j[0x0],l=j[0x1]||'443';var g=null,h=0x0;const m=Date['now']();try{const n=new AbortController(),o=setTimeout(function(){n['abort']();},CONST['HEALTH_CHECK_TIMEOUT']),p=await fetch('https://'+k+':'+l,{'signal':n['signal'],'method':'HEAD'});clearTimeout(o),(p['ok']||p['status']===0x194)&&(g=Date['now']()-m,h=0x1);}catch(q){console['error']('Health\x20check\x20failed\x20for\x20'+i+':\x20'+q['message']);}d['push'](a['DB']['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20proxy_health\x20(ip_port,\x20is_healthy,\x20latency_ms,\x20last_check)\x20VALUES\x20(?,\x20?,\x20?,\x20?)')['bind'](i,h,g,Math['floor'](Date['now']()/0x3e8)));}try{await a['DB']['batch'](d),console['log']('Proxy\x20health\x20check\x20completed');}catch(r){console['error']('performHealthCheck\x20batch\x20error:\x20'+r['message']);}}function getAdminLoginHTML(a,b,c){return'<!DOCTYPE\x20html>'+'<html\x20lang=\x22en\x22>'+'<head>'+'\x20\x20<meta\x20charset=\x22UTF-8\x22>'+'\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>'+'\x20\x20<title>Admin\x20Login\x20-\x20VLESS\x20Proxy</title>'+'\x20\x20<style\x20nonce=\x22'+a+'\x22>'+'\x20\x20\x20\x20*\x20{\x20box-sizing:\x20border-box;\x20margin:\x200;\x20padding:\x200;\x20}'+'\x20\x20\x20\x20body\x20{'+'\x20\x20\x20\x20\x20\x20display:\x20flex;\x20justify-content:\x20center;\x20align-items:\x20center;'+'\x20\x20\x20\x20\x20\x20min-height:\x20100vh;\x20margin:\x200;'+'\x20\x20\x20\x20\x20\x20background:\x20linear-gradient(135deg,\x20#1a1a2e\x200%,\x20#16213e\x20100%);'+'\x20\x20\x20\x20\x20\x20font-family:\x20-apple-system,\x20BlinkMacSystemFont,\x20\x22Segoe\x20UI\x22,\x20Roboto,\x20Arial,\x20sans-serif;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20.login-container\x20{'+'\x20\x20\x20\x20\x20\x20background:\x20rgba(255,\x20255,\x20255,\x200.05);'+'\x20\x20\x20\x20\x20\x20backdrop-filter:\x20blur(10px);'+'\x20\x20\x20\x20\x20\x20padding:\x2040px;'+'\x20\x20\x20\x20\x20\x20border-radius:\x2016px;'+'\x20\x20\x20\x20\x20\x20box-shadow:\x200\x208px\x2032px\x20rgba(0,\x200,\x200,\x200.3);'+'\x20\x20\x20\x20\x20\x20text-align:\x20center;'+'\x20\x20\x20\x20\x20\x20width:\x20100%;'+'\x20\x20\x20\x20\x20\x20max-width:\x20400px;'+'\x20\x20\x20\x20\x20\x20border:\x201px\x20solid\x20rgba(255,\x20255,\x20255,\x200.1);'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20h1\x20{'+'\x20\x20\x20\x20\x20\x20color:\x20#ffffff;'+'\x20\x20\x20\x20\x20\x20margin-bottom:\x2024px;'+'\x20\x20\x20\x20\x20\x20font-weight:\x20600;'+'\x20\x20\x20\x20\x20\x20font-size:\x2028px;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20form\x20{\x20display:\x20flex;\x20flex-direction:\x20column;\x20gap:\x2016px;\x20}'+'\x20\x20\x20\x20input[type=\x22password\x22],\x20input[type=\x22text\x22]\x20{'+'\x20\x20\x20\x20\x20\x20background:\x20rgba(255,\x20255,\x20255,\x200.1);'+'\x20\x20\x20\x20\x20\x20border:\x201px\x20solid\x20rgba(255,\x20255,\x20255,\x200.2);'+'\x20\x20\x20\x20\x20\x20color:\x20#ffffff;'+'\x20\x20\x20\x20\x20\x20padding:\x2014px;'+'\x20\x20\x20\x20\x20\x20border-radius:\x208px;'+'\x20\x20\x20\x20\x20\x20font-size:\x2016px;'+'\x20\x20\x20\x20\x20\x20transition:\x20all\x200.3s;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20input:focus\x20{'+'\x20\x20\x20\x20\x20\x20outline:\x20none;'+'\x20\x20\x20\x20\x20\x20border-color:\x20#3b82f6;'+'\x20\x20\x20\x20\x20\x20box-shadow:\x200\x200\x200\x203px\x20rgba(59,\x20130,\x20246,\x200.2);'+'\x20\x20\x20\x20\x20\x20background:\x20rgba(255,\x20255,\x20255,\x200.15);'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20input::placeholder\x20{\x20color:\x20rgba(255,\x20255,\x20255,\x200.5);\x20}'+'\x20\x20\x20\x20button\x20{'+'\x20\x20\x20\x20\x20\x20background:\x20linear-gradient(135deg,\x20#3b82f6\x200%,\x20#2563eb\x20100%);'+'\x20\x20\x20\x20\x20\x20color:\x20white;'+'\x20\x20\x20\x20\x20\x20border:\x20none;'+'\x20\x20\x20\x20\x20\x20padding:\x2014px;'+'\x20\x20\x20\x20\x20\x20border-radius:\x208px;'+'\x20\x20\x20\x20\x20\x20font-size:\x2016px;'+'\x20\x20\x20\x20\x20\x20font-weight:\x20600;'+'\x20\x20\x20\x20\x20\x20cursor:\x20pointer;'+'\x20\x20\x20\x20\x20\x20transition:\x20all\x200.3s;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20button:hover\x20{'+'\x20\x20\x20\x20\x20\x20transform:\x20translateY(-2px);'+'\x20\x20\x20\x20\x20\x20box-shadow:\x200\x204px\x2020px\x20rgba(59,\x20130,\x20246,\x200.4);'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20.error\x20{'+'\x20\x20\x20\x20\x20\x20color:\x20#ff6b6b;'+'\x20\x20\x20\x20\x20\x20margin-top:\x2016px;'+'\x20\x20\x20\x20\x20\x20font-size:\x2014px;'+'\x20\x20\x20\x20\x20\x20background:\x20rgba(255,\x20107,\x20107,\x200.1);'+'\x20\x20\x20\x20\x20\x20padding:\x2012px;'+'\x20\x20\x20\x20\x20\x20border-radius:\x208px;'+'\x20\x20\x20\x20\x20\x20border:\x201px\x20solid\x20rgba(255,\x20107,\x20107,\x200.3);'+'\x20\x20\x20\x20}'+'\x20\x20</style>'+'</head>'+'<body>'+'\x20\x20<div\x20class=\x22login-container\x22>'+'\x20\x20\x20\x20<h1>Admin\x20Login</h1>'+'\x20\x20\x20\x20<form\x20method=\x22POST\x22\x20action=\x22'+b+'\x22>'+'\x20\x20\x20\x20\x20\x20<input\x20type=\x22password\x22\x20name=\x22password\x22\x20placeholder=\x22Enter\x20admin\x20password\x22\x20required\x20autocomplete=\x22current-password\x22>'+'\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20name=\x22totp\x22\x20placeholder=\x222FA\x20Code\x20(if\x20enabled)\x22\x20autocomplete=\x22off\x22\x20inputmode=\x22numeric\x22\x20pattern=\x22[0-9]*\x22\x20maxlength=\x226\x22>'+'\x20\x20\x20\x20\x20\x20<button\x20type=\x22submit\x22>Login</button>'+'\x20\x20\x20\x20</form>'+(c?'<p\x20class=\x22error\x22>'+c+'</p>':'')+'\x20\x20</div>'+'</body>'+'</html>';}function getAdminPanelHTML(a,b){return'<!DOCTYPE\x20html>'+'<html\x20lang=\x22en\x22>'+'<head>'+'\x20\x20<meta\x20charset=\x22UTF-8\x22>'+'\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>'+'\x20\x20<title>Admin\x20Dashboard\x20-\x20VLESS\x20Proxy\x20Manager</title>'+'\x20\x20<style\x20nonce=\x22'+a+'\x22>'+'\x20\x20\x20\x20:root\x20{'+'\x20\x20\x20\x20\x20\x20--bg-main:\x20#0a0e17;\x20--bg-card:\x20#1a1f2e;\x20--border:\x20#2a3441;'+'\x20\x20\x20\x20\x20\x20--text-primary:\x20#F9FAFB;\x20--text-secondary:\x20#9CA3AF;'+'\x20\x20\x20\x20\x20\x20--accent:\x20#3B82F6;\x20--accent-hover:\x20#2563EB;'+'\x20\x20\x20\x20\x20\x20--danger:\x20#EF4444;\x20--success:\x20#22C55E;\x20--warning:\x20#F59e0b;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20*\x20{\x20margin:\x200;\x20padding:\x200;\x20box-sizing:\x20border-box;\x20}'+'\x20\x20\x20\x20body\x20{'+'\x20\x20\x20\x20\x20\x20font-family:\x20Inter,\x20system-ui,\x20-apple-system,\x20sans-serif;'+'\x20\x20\x20\x20\x20\x20background:\x20linear-gradient(135deg,\x20#0a0e17\x200%,\x20#111827\x2050%,\x20#0a0e17\x20100%);'+'\x20\x20\x20\x20\x20\x20color:\x20var(--text-primary);'+'\x20\x20\x20\x20\x20\x20min-height:\x20100vh;'+'\x20\x20\x20\x20\x20\x20padding:\x2020px;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20.container\x20{\x20max-width:\x201400px;\x20margin:\x200\x20auto;\x20}'+'\x20\x20\x20\x20h1\x20{\x20font-size:\x2028px;\x20margin-bottom:\x2024px;\x20color:\x20var(--accent);\x20}'+'\x20\x20\x20\x20h2\x20{\x20font-size:\x2018px;\x20margin-bottom:\x2016px;\x20border-bottom:\x202px\x20solid\x20var(--accent);\x20padding-bottom:\x208px;\x20}'+'\x20\x20\x20\x20.card\x20{'+'\x20\x20\x20\x20\x20\x20background:\x20var(--bg-card);'+'\x20\x20\x20\x20\x20\x20border-radius:\x2012px;'+'\x20\x20\x20\x20\x20\x20padding:\x2024px;'+'\x20\x20\x20\x20\x20\x20border:\x201px\x20solid\x20var(--border);'+'\x20\x20\x20\x20\x20\x20margin-bottom:\x2020px;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20.stats\x20{\x20display:\x20grid;\x20grid-template-columns:\x20repeat(auto-fit,\x20minmax(160px,\x201fr));\x20gap:\x2016px;\x20margin-bottom:\x2024px;\x20}'+'\x20\x20\x20\x20.stat-card\x20{'+'\x20\x20\x20\x20\x20\x20background:\x20var(--bg-card);'+'\x20\x20\x20\x20\x20\x20padding:\x2020px;'+'\x20\x20\x20\x20\x20\x20border-radius:\x2012px;'+'\x20\x20\x20\x20\x20\x20text-align:\x20center;'+'\x20\x20\x20\x20\x20\x20border:\x201px\x20solid\x20var(--border);'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20.stat-value\x20{\x20font-size:\x2028px;\x20font-weight:\x20700;\x20color:\x20var(--accent);\x20}'+'\x20\x20\x20\x20.stat-label\x20{\x20font-size:\x2012px;\x20color:\x20var(--text-secondary);\x20text-transform:\x20uppercase;\x20}'+'\x20\x20\x20\x20.form-grid\x20{\x20display:\x20grid;\x20grid-template-columns:\x20repeat(auto-fit,\x20minmax(200px,\x201fr));\x20gap:\x2016px;\x20}'+'\x20\x20\x20\x20.form-group\x20{\x20display:\x20flex;\x20flex-direction:\x20column;\x20}'+'\x20\x20\x20\x20.form-group\x20label\x20{\x20margin-bottom:\x206px;\x20font-size:\x2013px;\x20color:\x20var(--text-secondary);\x20}'+'\x20\x20\x20\x20input,\x20select\x20{'+'\x20\x20\x20\x20\x20\x20background:\x20#374151;'+'\x20\x20\x20\x20\x20\x20border:\x201px\x20solid\x20#4B5563;'+'\x20\x20\x20\x20\x20\x20color:\x20var(--text-primary);'+'\x20\x20\x20\x20\x20\x20padding:\x2010px;'+'\x20\x20\x20\x20\x20\x20border-radius:\x206px;'+'\x20\x20\x20\x20\x20\x20font-size:\x2014px;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20input:focus,\x20select:focus\x20{\x20outline:\x20none;\x20border-color:\x20var(--accent);\x20}'+'\x20\x20\x20\x20.btn\x20{'+'\x20\x20\x20\x20\x20\x20padding:\x2010px\x2018px;'+'\x20\x20\x20\x20\x20\x20border:\x20none;'+'\x20\x20\x20\x20\x20\x20border-radius:\x208px;'+'\x20\x20\x20\x20\x20\x20font-weight:\x20600;'+'\x20\x20\x20\x20\x20\x20cursor:\x20pointer;'+'\x20\x20\x20\x20\x20\x20transition:\x20all\x200.2s;'+'\x20\x20\x20\x20\x20\x20font-size:\x2014px;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20.btn-primary\x20{\x20background:\x20var(--accent);\x20color:\x20white;\x20}'+'\x20\x20\x20\x20.btn-primary:hover\x20{\x20background:\x20var(--accent-hover);\x20}'+'\x20\x20\x20\x20.btn-danger\x20{\x20background:\x20var(--danger);\x20color:\x20white;\x20}'+'\x20\x20\x20\x20.btn-secondary\x20{\x20background:\x20#4B5563;\x20color:\x20white;\x20}'+'\x20\x20\x20\x20table\x20{\x20width:\x20100%;\x20border-collapse:\x20collapse;\x20}'+'\x20\x20\x20\x20th,\x20td\x20{\x20padding:\x2012px;\x20text-align:\x20left;\x20border-bottom:\x201px\x20solid\x20var(--border);\x20}'+'\x20\x20\x20\x20th\x20{\x20color:\x20var(--text-secondary);\x20font-size:\x2012px;\x20text-transform:\x20uppercase;\x20}'+'\x20\x20\x20\x20.status-active\x20{\x20color:\x20var(--success);\x20}'+'\x20\x20\x20\x20.status-expired\x20{\x20color:\x20var(--danger);\x20}'+'\x20\x20\x20\x20#toast\x20{'+'\x20\x20\x20\x20\x20\x20position:\x20fixed;\x20top:\x2020px;\x20right:\x2020px;'+'\x20\x20\x20\x20\x20\x20background:\x20var(--bg-card);\x20color:\x20white;'+'\x20\x20\x20\x20\x20\x20padding:\x2016px\x2020px;\x20border-radius:\x208px;'+'\x20\x20\x20\x20\x20\x20display:\x20none;\x20z-index:\x201000;'+'\x20\x20\x20\x20\x20\x20border:\x201px\x20solid\x20var(--border);'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20#toast.show\x20{\x20display:\x20block;\x20}'+'\x20\x20\x20\x20#toast.success\x20{\x20border-left:\x204px\x20solid\x20var(--success);\x20}'+'\x20\x20\x20\x20#toast.error\x20{\x20border-left:\x204px\x20solid\x20var(--danger);\x20}'+'\x20\x20\x20\x20.modal-overlay\x20{'+'\x20\x20\x20\x20\x20\x20position:\x20fixed;\x20top:\x200;\x20left:\x200;\x20width:\x20100%;\x20height:\x20100%;'+'\x20\x20\x20\x20\x20\x20background:\x20rgba(0,0,0,0.7);\x20z-index:\x201000;'+'\x20\x20\x20\x20\x20\x20display:\x20flex;\x20justify-content:\x20center;\x20align-items:\x20center;'+'\x20\x20\x20\x20\x20\x20opacity:\x200;\x20visibility:\x20hidden;\x20transition:\x20all\x200.3s;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20.modal-overlay.show\x20{\x20opacity:\x201;\x20visibility:\x20visible;\x20}'+'\x20\x20\x20\x20.modal-content\x20{'+'\x20\x20\x20\x20\x20\x20background:\x20var(--bg-card);\x20padding:\x2028px;\x20border-radius:\x2012px;'+'\x20\x20\x20\x20\x20\x20width:\x2090%;\x20max-width:\x20500px;\x20border:\x201px\x20solid\x20var(--border);'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20.header-actions\x20{\x20display:\x20flex;\x20gap:\x2012px;\x20margin-bottom:\x2020px;\x20}'+'\x20\x20</style>'+'</head>'+'<body>'+'\x20\x20<div\x20class=\x22container\x22>'+'\x20\x20\x20\x20<h1>Admin\x20Dashboard</h1>'+'\x20\x20\x20\x20<div\x20class=\x22header-actions\x22>'+'\x20\x20\x20\x20\x20\x20<button\x20id=\x22healthCheckBtn\x22\x20class=\x22btn\x20btn-secondary\x22>Health\x20Check</button>'+'\x20\x20\x20\x20\x20\x20<button\x20id=\x22logoutBtn\x22\x20class=\x22btn\x20btn-danger\x22>Logout</button>'+'\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20<div\x20class=\x22stats\x22>'+'\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><div\x20class=\x22stat-value\x22\x20id=\x22total-users\x22>0</div><div\x20class=\x22stat-label\x22>Total\x20Users</div></div>'+'\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><div\x20class=\x22stat-value\x22\x20id=\x22active-users\x22>0</div><div\x20class=\x22stat-label\x22>Active</div></div>'+'\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><div\x20class=\x22stat-value\x22\x20id=\x22expired-users\x22>0</div><div\x20class=\x22stat-label\x22>Expired</div></div>'+'\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><div\x20class=\x22stat-value\x22\x20id=\x22total-traffic\x22>0</div><div\x20class=\x22stat-label\x22>Traffic</div></div>'+'\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20<div\x20class=\x22card\x22>'+'\x20\x20\x20\x20\x20\x20<h2>Create\x20New\x20User</h2>'+'\x20\x20\x20\x20\x20\x20<form\x20id=\x22createUserForm\x22\x20class=\x22form-grid\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22\x20style=\x22grid-column:\x201\x20/\x20-1;\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label>UUID</label>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20style=\x22display:flex;gap:8px;\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20id=\x22uuid\x22\x20required\x20style=\x22flex:1;\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20type=\x22button\x22\x20id=\x22generateUUID\x22\x20class=\x22btn\x20btn-secondary\x22>Generate</button>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label>Expiry\x20Date</label><input\x20type=\x22date\x22\x20id=\x22expiryDate\x22\x20required></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label>Expiry\x20Time</label><input\x20type=\x22time\x22\x20id=\x22expiryTime\x22\x20step=\x221\x22\x20required></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label>Notes</label><input\x20type=\x22text\x22\x20id=\x22notes\x22\x20placeholder=\x22Optional\x22></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label>Data\x20Limit</label>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20style=\x22display:flex;gap:8px;\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22number\x22\x20id=\x22dataLimit\x22\x20min=\x220\x22\x20step=\x220.01\x22\x20style=\x22flex:1;\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<select\x20id=\x22dataUnit\x22><option\x20value=\x22KB\x22>KB</option><option\x20value=\x22MB\x22>MB</option><option\x20value=\x22GB\x22\x20selected>GB</option><option\x20value=\x22TB\x22>TB</option><option\x20value=\x22unlimited\x22>Unlimited</option></select>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label>IP\x20Limit</label><input\x20type=\x22number\x22\x20id=\x22ipLimit\x22\x20min=\x22-1\x22\x20value=\x22-1\x22\x20placeholder=\x22-1\x20=\x20Unlimited\x22></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><button\x20type=\x22submit\x22\x20class=\x22btn\x20btn-primary\x22>Create\x20User</button></div>'+'\x20\x20\x20\x20\x20\x20</form>'+'\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20<div\x20class=\x22card\x22>'+'\x20\x20\x20\x20\x20\x20<h2>User\x20Management</h2>'+'\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20id=\x22searchInput\x22\x20placeholder=\x22Search...\x22\x20style=\x22width:100%;margin-bottom:16px;\x22>'+'\x20\x20\x20\x20\x20\x20<button\x20id=\x22deleteSelected\x22\x20class=\x22btn\x20btn-danger\x22\x20style=\x22margin-bottom:16px;\x22>Delete\x20Selected</button>'+'\x20\x20\x20\x20\x20\x20<div\x20style=\x22overflow-x:auto;\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20<table>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<thead><tr>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<th><input\x20type=\x22checkbox\x22\x20id=\x22selectAll\x22></th>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<th>UUID</th><th>Created</th><th>Expiry</th><th>Status</th><th>Notes</th><th>Limit</th><th>Usage</th><th>Actions</th>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</tr></thead>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<tbody\x20id=\x22userList\x22></tbody>'+'\x20\x20\x20\x20\x20\x20\x20\x20</table>'+'\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20</div>'+'\x20\x20</div>'+'\x20\x20<div\x20id=\x22editModal\x22\x20class=\x22modal-overlay\x22>'+'\x20\x20\x20\x20<div\x20class=\x22modal-content\x22>'+'\x20\x20\x20\x20\x20\x20<h2>Edit\x20User</h2>'+'\x20\x20\x20\x20\x20\x20<form\x20id=\x22editUserForm\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22hidden\x22\x20id=\x22editUuid\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22\x20style=\x22margin-top:16px;\x22><label>Expiry\x20Date</label><input\x20type=\x22date\x22\x20id=\x22editExpiryDate\x22\x20required></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22\x20style=\x22margin-top:12px;\x22><label>Expiry\x20Time</label><input\x20type=\x22time\x22\x20id=\x22editExpiryTime\x22\x20step=\x221\x22\x20required></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22\x20style=\x22margin-top:12px;\x22><label>Notes</label><input\x20type=\x22text\x22\x20id=\x22editNotes\x22></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22\x20style=\x22margin-top:12px;\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label>Data\x20Limit</label>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20style=\x22display:flex;gap:8px;\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22number\x22\x20id=\x22editDataLimit\x22\x20min=\x220\x22\x20step=\x220.01\x22\x20style=\x22flex:1;\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<select\x20id=\x22editDataUnit\x22><option\x20value=\x22KB\x22>KB</option><option\x20value=\x22MB\x22>MB</option><option\x20value=\x22GB\x22\x20selected>GB</option><option\x20value=\x22TB\x22>TB</option><option\x20value=\x22unlimited\x22>Unlimited</option></select>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22\x20style=\x22margin-top:12px;\x22><label>IP\x20Limit</label><input\x20type=\x22number\x22\x20id=\x22editIpLimit\x22\x20min=\x22-1\x22></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22\x20style=\x22margin-top:12px;\x22><label><input\x20type=\x22checkbox\x22\x20id=\x22resetTraffic\x22\x20style=\x22width:auto;margin-right:8px;\x22>Reset\x20Traffic</label></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20style=\x22display:flex;gap:12px;margin-top:20px;\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20type=\x22button\x22\x20id=\x22modalCancelBtn\x22\x20class=\x22btn\x20btn-secondary\x22>Cancel</button>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20type=\x22submit\x22\x20class=\x22btn\x20btn-primary\x22>Save</button>'+'\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20</form>'+'\x20\x20\x20\x20</div>'+'\x20\x20</div>'+'\x20\x20<div\x20id=\x22toast\x22></div>'+'\x20\x20<script\x20nonce=\x22'+a+'\x22>'+'\x20\x20\x20\x20(function()\x20{'+'\x20\x20\x20\x20\x20\x20var\x20API_BASE\x20=\x20\x22'+b+'\x22;'+'\x20\x20\x20\x20\x20\x20var\x20allUsers\x20=\x20[];'+'\x20\x20\x20\x20\x20\x20function\x20escapeHTML(s)\x20{\x20if\x20(typeof\x20s\x20!==\x20\x22string\x22)\x20return\x20\x22\x22;\x20return\x20s.replace(/[&<>\x22\x27]/g,\x20function(m)\x20{\x20return\x20{\x22&\x22:\x22&amp;\x22,\x22<\x22:\x22&lt;\x22,\x22>\x22:\x22&gt;\x22,\x22\x5c\x22\x22:\x22&quot;\x22,\x22\x27\x22:\x22&#39;\x22}[m];\x20});\x20}'+'\x20\x20\x20\x20\x20\x20function\x20formatBytes(b)\x20{\x20if\x20(b\x20===\x200)\x20return\x20\x220\x20B\x22;\x20var\x20k\x20=\x201024,\x20s\x20=\x20[\x22B\x22,\x22KB\x22,\x22MB\x22,\x22GB\x22,\x22TB\x22],\x20i\x20=\x20Math.floor(Math.log(b)/Math.log(k));\x20return\x20parseFloat((b/Math.pow(k,i)).toFixed(2))\x20+\x20\x22\x20\x22\x20+\x20s[i];\x20}'+'\x20\x20\x20\x20\x20\x20function\x20showToast(msg,\x20isErr)\x20{\x20var\x20t\x20=\x20document.getElementById(\x22toast\x22);\x20t.textContent\x20=\x20msg;\x20t.className\x20=\x20(isErr\x20?\x20\x22error\x22\x20:\x20\x22success\x22)\x20+\x20\x22\x20show\x22;\x20setTimeout(function()\x20{\x20t.className\x20=\x20\x22\x22;\x20},\x203000);\x20}'+'\x20\x20\x20\x20\x20\x20function\x20getCsrfToken()\x20{\x20var\x20m\x20=\x20document.cookie.match(/csrf_token=([^;]+)/);\x20return\x20m\x20?\x20m[1]\x20:\x20\x22\x22;\x20}'+'\x20\x20\x20\x20\x20\x20function\x20api(method,\x20endpoint,\x20body)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20opts\x20=\x20{\x20method:\x20method,\x20credentials:\x20\x22include\x22,\x20headers:\x20{\x20\x22Content-Type\x22:\x20\x22application/json\x22,\x20\x22X-CSRF-Token\x22:\x20getCsrfToken()\x20}\x20};'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(body)\x20opts.body\x20=\x20JSON.stringify(body);'+'\x20\x20\x20\x20\x20\x20\x20\x20return\x20fetch(API_BASE\x20+\x20endpoint,\x20opts).then(function(r)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(r.status\x20===\x20401)\x20{\x20showToast(\x22Session\x20expired\x22,\x20true);\x20setTimeout(function()\x20{\x20location.reload();\x20},\x202000);\x20throw\x20new\x20Error(\x22Unauthorized\x22);\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!r.ok)\x20return\x20r.json().then(function(d)\x20{\x20throw\x20new\x20Error(d.error\x20||\x20\x22Failed\x22);\x20});'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return\x20r.status\x20===\x20204\x20?\x20null\x20:\x20r.json();'+'\x20\x20\x20\x20\x20\x20\x20\x20});'+'\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20function\x20pad(n)\x20{\x20return\x20n.toString().padStart(2,\x20\x220\x22);\x20}'+'\x20\x20\x20\x20\x20\x20function\x20localToUTC(d,\x20t)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20dt\x20=\x20new\x20Date(d\x20+\x20\x22T\x22\x20+\x20t);'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(isNaN(dt.getTime()))\x20return\x20{\x20utcDate:\x20\x22\x22,\x20utcTime:\x20\x22\x22\x20};'+'\x20\x20\x20\x20\x20\x20\x20\x20return\x20{\x20utcDate:\x20dt.getUTCFullYear()\x20+\x20\x22-\x22\x20+\x20pad(dt.getUTCMonth()+1)\x20+\x20\x22-\x22\x20+\x20pad(dt.getUTCDate()),\x20utcTime:\x20pad(dt.getUTCHours())\x20+\x20\x22:\x22\x20+\x20pad(dt.getUTCMinutes())\x20+\x20\x22:\x22\x20+\x20pad(dt.getUTCSeconds())\x20};'+'\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20function\x20utcToLocal(d,\x20t)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20dt\x20=\x20new\x20Date(d\x20+\x20\x22T\x22\x20+\x20t\x20+\x20\x22Z\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(isNaN(dt.getTime()))\x20return\x20{\x20localDate:\x20\x22\x22,\x20localTime:\x20\x22\x22\x20};'+'\x20\x20\x20\x20\x20\x20\x20\x20return\x20{\x20localDate:\x20dt.getFullYear()\x20+\x20\x22-\x22\x20+\x20pad(dt.getMonth()+1)\x20+\x20\x22-\x22\x20+\x20pad(dt.getDate()),\x20localTime:\x20pad(dt.getHours())\x20+\x20\x22:\x22\x20+\x20pad(dt.getMinutes())\x20+\x20\x22:\x22\x20+\x20pad(dt.getSeconds())\x20};'+'\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20function\x20fetchStats()\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20api(\x22GET\x22,\x20\x22/stats\x22).then(function(s)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22total-users\x22).textContent\x20=\x20s.total_users;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22active-users\x22).textContent\x20=\x20s.active_users;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22expired-users\x22).textContent\x20=\x20s.expired_users;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22total-traffic\x22).textContent\x20=\x20formatBytes(s.total_traffic);'+'\x20\x20\x20\x20\x20\x20\x20\x20}).catch(function(e)\x20{\x20showToast(e.message,\x20true);\x20});'+'\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20function\x20renderUsers(users)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20list\x20=\x20document.getElementById(\x22userList\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20list.innerHTML\x20=\x20\x22\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!users\x20||\x20users.length\x20===\x200)\x20{\x20list.innerHTML\x20=\x20\x22<tr><td\x20colspan=9\x20style=text-align:center>No\x20users</td></tr>\x22;\x20return;\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20users.forEach(function(u)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20exp\x20=\x20new\x20Date(u.expiration_date\x20+\x20\x22T\x22\x20+\x20u.expiration_time\x20+\x20\x22Z\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20isExp\x20=\x20exp\x20<=\x20new\x20Date();'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20tr\x20=\x20document.createElement(\x22tr\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20tr.innerHTML\x20=\x20\x22<td><input\x20type=checkbox\x20class=user-cb\x20data-uuid=\x5c\x22\x22\x20+\x20u.uuid\x20+\x20\x22\x5c\x22></td>\x22\x20+'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x22<td\x20title=\x5c\x22\x22\x20+\x20u.uuid\x20+\x20\x22\x5c\x22>\x22\x20+\x20u.uuid.substring(0,8)\x20+\x20\x22...</td>\x22\x20+'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x22<td>\x22\x20+\x20new\x20Date(u.created_at).toLocaleString()\x20+\x20\x22</td>\x22\x20+'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x22<td>\x22\x20+\x20exp.toLocaleString()\x20+\x20\x22</td>\x22\x20+'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x22<td\x20class=\x5c\x22\x22\x20+\x20(isExp\x20?\x20\x22status-expired\x22\x20:\x20\x22status-active\x22)\x20+\x20\x22\x5c\x22>\x22\x20+\x20(isExp\x20?\x20\x22Expired\x22\x20:\x20\x22Active\x22)\x20+\x20\x22</td>\x22\x20+'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x22<td>\x22\x20+\x20escapeHTML(u.notes\x20||\x20\x22-\x22)\x20+\x20\x22</td>\x22\x20+'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x22<td>\x22\x20+\x20(u.traffic_limit\x20?\x20formatBytes(u.traffic_limit)\x20:\x20\x22Unlimited\x22)\x20+\x20\x22</td>\x22\x20+'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x22<td>\x22\x20+\x20formatBytes(u.traffic_used\x20||\x200)\x20+\x20\x22</td>\x22\x20+'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x22<td><button\x20class=btn-edit\x20data-uuid=\x5c\x22\x22\x20+\x20u.uuid\x20+\x20\x22\x5c\x22>Edit</button>\x20<button\x20class=btn-del\x20data-uuid=\x5c\x22\x22\x20+\x20u.uuid\x20+\x20\x22\x5c\x22>Del</button></td>\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20list.appendChild(tr);'+'\x20\x20\x20\x20\x20\x20\x20\x20});'+'\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20function\x20fetchUsers()\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20api(\x22GET\x22,\x20\x22/users\x22).then(function(users)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20allUsers\x20=\x20users\x20||\x20[];'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20allUsers.sort(function(a,b)\x20{\x20return\x20new\x20Date(b.created_at)\x20-\x20new\x20Date(a.created_at);\x20});'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20renderUsers(allUsers);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20fetchStats();'+'\x20\x20\x20\x20\x20\x20\x20\x20}).catch(function(e)\x20{\x20showToast(e.message,\x20true);\x20});'+'\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20function\x20setDefaultExpiry()\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20d\x20=\x20new\x20Date();\x20d.setDate(d.getDate()\x20+\x2030);'+'\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22expiryDate\x22).value\x20=\x20d.getFullYear()\x20+\x20\x22-\x22\x20+\x20pad(d.getMonth()+1)\x20+\x20\x22-\x22\x20+\x20pad(d.getDate());'+'\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22expiryTime\x22).value\x20=\x20pad(d.getHours())\x20+\x20\x22:\x22\x20+\x20pad(d.getMinutes())\x20+\x20\x22:\x22\x20+\x20pad(d.getSeconds());'+'\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22generateUUID\x22).addEventListener(\x22click\x22,\x20function()\x20{\x20document.getElementById(\x22uuid\x22).value\x20=\x20crypto.randomUUID();\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22createUserForm\x22).addEventListener(\x22submit\x22,\x20function(e)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20e.preventDefault();'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20utc\x20=\x20localToUTC(document.getElementById(\x22expiryDate\x22).value,\x20document.getElementById(\x22expiryTime\x22).value);'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!utc.utcDate)\x20{\x20showToast(\x22Invalid\x20date/time\x22,\x20true);\x20return;\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20dl\x20=\x20document.getElementById(\x22dataLimit\x22).value;'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20du\x20=\x20document.getElementById(\x22dataUnit\x22).value;'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20tl\x20=\x20null;'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(du\x20!==\x20\x22unlimited\x22\x20&&\x20dl)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20mult\x20=\x20{\x20KB:\x201024,\x20MB:\x201024*1024,\x20GB:\x201024*1024*1024,\x20TB:\x201024*1024*1024*1024\x20};'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20tl\x20=\x20parseFloat(dl)\x20*\x20(mult[du]\x20||\x201);'+'\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20api(\x22POST\x22,\x20\x22/users\x22,\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uuid:\x20document.getElementById(\x22uuid\x22).value,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20exp_date:\x20utc.utcDate,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20exp_time:\x20utc.utcTime,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20notes:\x20document.getElementById(\x22notes\x22).value,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20traffic_limit:\x20tl,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ip_limit:\x20parseInt(document.getElementById(\x22ipLimit\x22).value)\x20||\x20-1'+'\x20\x20\x20\x20\x20\x20\x20\x20}).then(function()\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x22User\x20created!\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22createUserForm\x22).reset();'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22uuid\x22).value\x20=\x20crypto.randomUUID();'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20setDefaultExpiry();'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20fetchUsers();'+'\x20\x20\x20\x20\x20\x20\x20\x20}).catch(function(e)\x20{\x20showToast(e.message,\x20true);\x20});'+'\x20\x20\x20\x20\x20\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22userList\x22).addEventListener(\x22click\x22,\x20function(e)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20t\x20=\x20e.target;'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(t.classList.contains(\x22btn-edit\x22))\x20openEditModal(t.dataset.uuid);'+'\x20\x20\x20\x20\x20\x20\x20\x20else\x20if\x20(t.classList.contains(\x22btn-del\x22))\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(confirm(\x22Delete\x20user\x20\x22\x20+\x20t.dataset.uuid\x20+\x20\x22?\x22))\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20api(\x22DELETE\x22,\x20\x22/users/\x22\x20+\x20t.dataset.uuid).then(function()\x20{\x20showToast(\x22Deleted!\x22);\x20fetchUsers();\x20}).catch(function(e)\x20{\x20showToast(e.message,\x20true);\x20});'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20});'+'\x20\x20\x20\x20\x20\x20function\x20openEditModal(uuid)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20u\x20=\x20allUsers.find(function(x)\x20{\x20return\x20x.uuid\x20===\x20uuid;\x20});'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!u)\x20return;'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20loc\x20=\x20utcToLocal(u.expiration_date,\x20u.expiration_time);'+'\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22editUuid\x22).value\x20=\x20u.uuid;'+'\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22editExpiryDate\x22).value\x20=\x20loc.localDate;'+'\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22editExpiryTime\x22).value\x20=\x20loc.localTime;'+'\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22editNotes\x22).value\x20=\x20u.notes\x20||\x20\x22\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!u.traffic_limit)\x20{\x20document.getElementById(\x22editDataUnit\x22).value\x20=\x20\x22unlimited\x22;\x20document.getElementById(\x22editDataLimit\x22).value\x20=\x20\x22\x22;\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20else\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20b\x20=\x20u.traffic_limit,\x20unit\x20=\x20\x22KB\x22,\x20val\x20=\x20b/1024;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(val\x20>=\x201024)\x20{\x20val\x20/=\x201024;\x20unit\x20=\x20\x22MB\x22;\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(val\x20>=\x201024)\x20{\x20val\x20/=\x201024;\x20unit\x20=\x20\x22GB\x22;\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(val\x20>=\x201024)\x20{\x20val\x20/=\x201024;\x20unit\x20=\x20\x22TB\x22;\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22editDataLimit\x22).value\x20=\x20val.toFixed(2);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22editDataUnit\x22).value\x20=\x20unit;'+'\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22editIpLimit\x22).value\x20=\x20u.ip_limit\x20!==\x20null\x20?\x20u.ip_limit\x20:\x20-1;'+'\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22resetTraffic\x22).checked\x20=\x20false;'+'\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22editModal\x22).classList.add(\x22show\x22);'+'\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22modalCancelBtn\x22).addEventListener(\x22click\x22,\x20function()\x20{\x20document.getElementById(\x22editModal\x22).classList.remove(\x22show\x22);\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22editModal\x22).addEventListener(\x22click\x22,\x20function(e)\x20{\x20if\x20(e.target\x20===\x20this)\x20this.classList.remove(\x22show\x22);\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22editUserForm\x22).addEventListener(\x22submit\x22,\x20function(e)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20e.preventDefault();'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20utc\x20=\x20localToUTC(document.getElementById(\x22editExpiryDate\x22).value,\x20document.getElementById(\x22editExpiryTime\x22).value);'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!utc.utcDate)\x20{\x20showToast(\x22Invalid\x20date/time\x22,\x20true);\x20return;\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20dl\x20=\x20document.getElementById(\x22editDataLimit\x22).value;'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20du\x20=\x20document.getElementById(\x22editDataUnit\x22).value;'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20tl\x20=\x20null;'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(du\x20!==\x20\x22unlimited\x22\x20&&\x20dl)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20mult\x20=\x20{\x20KB:\x201024,\x20MB:\x201024*1024,\x20GB:\x201024*1024*1024,\x20TB:\x201024*1024*1024*1024\x20};'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20tl\x20=\x20parseFloat(dl)\x20*\x20(mult[du]\x20||\x201);'+'\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20api(\x22PUT\x22,\x20\x22/users/\x22\x20+\x20document.getElementById(\x22editUuid\x22).value,\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20exp_date:\x20utc.utcDate,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20exp_time:\x20utc.utcTime,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20notes:\x20document.getElementById(\x22editNotes\x22).value,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20traffic_limit:\x20tl,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ip_limit:\x20parseInt(document.getElementById(\x22editIpLimit\x22).value)\x20||\x20-1,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20reset_traffic:\x20document.getElementById(\x22resetTraffic\x22).checked'+'\x20\x20\x20\x20\x20\x20\x20\x20}).then(function()\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x22Updated!\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22editModal\x22).classList.remove(\x22show\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20fetchUsers();'+'\x20\x20\x20\x20\x20\x20\x20\x20}).catch(function(e)\x20{\x20showToast(e.message,\x20true);\x20});'+'\x20\x20\x20\x20\x20\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22selectAll\x22).addEventListener(\x22change\x22,\x20function(e)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20document.querySelectorAll(\x22.user-cb\x22).forEach(function(cb)\x20{\x20cb.checked\x20=\x20e.target.checked;\x20});'+'\x20\x20\x20\x20\x20\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22deleteSelected\x22).addEventListener(\x22click\x22,\x20function()\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20sel\x20=\x20Array.from(document.querySelectorAll(\x22.user-cb:checked\x22)).map(function(cb)\x20{\x20return\x20cb.dataset.uuid;\x20});'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!sel.length)\x20{\x20showToast(\x22None\x20selected\x22,\x20true);\x20return;\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(confirm(\x22Delete\x20\x22\x20+\x20sel.length\x20+\x20\x22\x20users?\x22))\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20api(\x22POST\x22,\x20\x22/users/bulk-delete\x22,\x20{\x20uuids:\x20sel\x20}).then(function()\x20{\x20showToast(\x22Deleted!\x22);\x20fetchUsers();\x20}).catch(function(e)\x20{\x20showToast(e.message,\x20true);\x20});'+'\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22searchInput\x22).addEventListener(\x22input\x22,\x20function()\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20q\x20=\x20this.value.toLowerCase();'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20filtered\x20=\x20allUsers.filter(function(u)\x20{\x20return\x20u.uuid.toLowerCase().includes(q)\x20||\x20(u.notes\x20&&\x20u.notes.toLowerCase().includes(q));\x20});'+'\x20\x20\x20\x20\x20\x20\x20\x20renderUsers(filtered);'+'\x20\x20\x20\x20\x20\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22logoutBtn\x22).addEventListener(\x22click\x22,\x20function()\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20api(\x22POST\x22,\x20\x22/logout\x22,\x20{}).then(function()\x20{\x20showToast(\x22Logged\x20out!\x22);\x20setTimeout(function()\x20{\x20location.reload();\x20},\x201000);\x20}).catch(function(e)\x20{\x20showToast(e.message,\x20true);\x20});'+'\x20\x20\x20\x20\x20\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22healthCheckBtn\x22).addEventListener(\x22click\x22,\x20function()\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20api(\x22POST\x22,\x20\x22/health-check\x22,\x20{}).then(function()\x20{\x20showToast(\x22Health\x20check\x20done!\x22);\x20fetchUsers();\x20}).catch(function(e)\x20{\x20showToast(e.message,\x20true);\x20});'+'\x20\x20\x20\x20\x20\x20});'+'\x20\x20\x20\x20\x20\x20setDefaultExpiry();'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22uuid\x22).value\x20=\x20crypto.randomUUID();'+'\x20\x20\x20\x20\x20\x20fetchUsers();'+'\x20\x20\x20\x20\x20\x20setInterval(fetchUsers,\x2060000);'+'\x20\x20\x20\x20})();'+'\x20\x20</script>'+'</body>'+'</html>';}async function isAdmin(a,b){const c=a['headers']['get']('Cookie');if(!c)return![];const d=c['match'](/auth_token=([^;]+)/),e=d?d[0x1]:null;if(!e)return![];const f=await hashSHA256(e),g=await kvGet(b['DB'],'admin_session_token_hash');return g&&timingSafeEqual(f,g);}async function handleAdminRequest(a,b,c,d){try{await ensureTablesExist(b,c);const i=new URL(a['url']),j={'Content-Type':'application/json'},k=new Headers({'Content-Type':'text/html;charset=utf-8'}),l=a['headers']['get']('CF-Connecting-IP');if(!b['ADMIN_KEY'])return addSecurityHeaders(k,null,{}),new Response('Admin\x20panel\x20not\x20configured',{'status':0x1f7,'headers':k});if(b['ADMIN_IP_WHITELIST']){const p=b['ADMIN_IP_WHITELIST']['split'](',')['map'](function(q){return q['trim']();});if(!p['includes'](l))return console['warn']('Admin\x20access\x20denied\x20for\x20IP:\x20'+l),addSecurityHeaders(k,null,{}),new Response('Access\x20denied',{'status':0x193,'headers':k});}else{const q={'username':b['SCAMALYTICS_USERNAME']||Config['scamalytics']['username'],'apiKey':b['SCAMALYTICS_API_KEY']||Config['scamalytics']['apiKey'],'baseUrl':b['SCAMALYTICS_BASEURL']||Config['scamalytics']['baseUrl']};if(await isSuspiciousIP(l,q,b['SCAMALYTICS_THRESHOLD']||CONST['SCAMALYTICS_THRESHOLD']))return console['warn']('Admin\x20access\x20denied\x20for\x20suspicious\x20IP:\x20'+l),addSecurityHeaders(k,null,{}),new Response('Access\x20denied',{'status':0x193,'headers':k});}if(b['ADMIN_HEADER_KEY']){const r=a['headers']['get']('X-Admin-Auth');if(!timingSafeEqual(r||'',b['ADMIN_HEADER_KEY']))return addSecurityHeaders(k,null,{}),new Response('Access\x20denied',{'status':0x193,'headers':k});}const m='/'+d+'/'+b['ADMIN_KEY'];if(!i['pathname']['startsWith'](m)){const s=new Headers();return addSecurityHeaders(s,null,{}),new Response('Not\x20found',{'status':0x194,'headers':s});}const n=i['pathname']['substring'](m['length'])||'/';if(n['startsWith']('/api/')){if(!b['DB']){const w=new Headers(j);return addSecurityHeaders(w,null,{}),new Response(JSON['stringify']({'error':'Database\x20not\x20configured'}),{'status':0x1f7,'headers':w});}if(!await isAdmin(a,b)){const x=new Headers(j);return addSecurityHeaders(x,null,{}),new Response(JSON['stringify']({'error':'Forbidden'}),{'status':0x193,'headers':x});}const t='admin_api_rate:'+l;if(await checkRateLimit(b['DB'],t,0x64,0x3c)){const y=new Headers(j);return addSecurityHeaders(y,null,{}),new Response(JSON['stringify']({'error':'Rate\x20limit\x20exceeded'}),{'status':0x1ad,'headers':y});}if(a['method']!=='GET'){const z=a['headers']['get']('Origin'),A=a['headers']['get']('Sec-Fetch-Site');if(!z||new URL(z)['hostname']!==i['hostname']){const E=new Headers(j);return addSecurityHeaders(E,null,{}),new Response(JSON['stringify']({'error':'Invalid\x20request\x20origin'}),{'status':0x193,'headers':E});}const B=a['headers']['get']('X-CSRF-Token'),C=a['headers']['get']('Cookie')?.['match'](/csrf_token=([^;]+)/),D=C?C[0x1]:null;if(!B||!D||!timingSafeEqual(B,D)){const F=new Headers(j);return addSecurityHeaders(F,null,{}),new Response(JSON['stringify']({'error':'CSRF\x20validation\x20failed'}),{'status':0x193,'headers':F});}}if(n==='/api/stats'&&a['method']==='GET'){const G=new Headers(j);addSecurityHeaders(G,null,{});try{const H=await b['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users')['first']('count'),I=await b['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users\x20WHERE\x20datetime(expiration_date\x20||\x20\x27T\x27\x20||\x20expiration_time\x20||\x20\x27Z\x27)\x20<\x20datetime(\x27now\x27)')['first'](),J=I?.['count']||0x0,K=H-J,L=await b['DB']['prepare']('SELECT\x20SUM(traffic_used)\x20as\x20sum\x20FROM\x20users')['first'](),M=L?.['sum']||0x0;return new Response(JSON['stringify']({'total_users':H,'active_users':K,'expired_users':J,'total_traffic':M}),{'status':0xc8,'headers':G});}catch(N){return new Response(JSON['stringify']({'error':N['message']}),{'status':0x1f4,'headers':G});}}if(n==='/api/users'&&a['method']==='GET'){const O=new Headers(j);addSecurityHeaders(O,null,{});try{const {results:P}=await b['DB']['prepare']('SELECT\x20uuid,\x20created_at,\x20expiration_date,\x20expiration_time,\x20notes,\x20traffic_limit,\x20traffic_used,\x20ip_limit\x20FROM\x20users\x20ORDER\x20BY\x20created_at\x20DESC')['all']();return new Response(JSON['stringify'](P||[]),{'status':0xc8,'headers':O});}catch(Q){return new Response(JSON['stringify']({'error':Q['message']}),{'status':0x1f4,'headers':O});}}if(n==='/api/users'&&a['method']==='POST'){const R=new Headers(j);addSecurityHeaders(R,null,{});try{const S=await a['json'](),T=S['uuid'],U=S['exp_date'],V=S['exp_time'],W=S['notes'],X=S['traffic_limit'],Y=S['ip_limit'];if(!T||!U||!V||!/^\d{4}-\d{2}-\d{2}$/['test'](U)||!/^\d{2}:\d{2}:\d{2}$/['test'](V))throw new Error('Invalid\x20or\x20missing\x20fields');return await b['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20expiration_date,\x20expiration_time,\x20notes,\x20traffic_limit,\x20ip_limit,\x20traffic_used)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x200)')['bind'](T,U,V,W||null,X,Y||-0x1)['run'](),new Response(JSON['stringify']({'success':!![],'uuid':T}),{'status':0xc9,'headers':R});}catch(Z){if(Z['message']&&Z['message']['includes']('UNIQUE\x20constraint\x20failed'))return new Response(JSON['stringify']({'error':'UUID\x20already\x20exists'}),{'status':0x199,'headers':R});return new Response(JSON['stringify']({'error':Z['message']}),{'status':0x190,'headers':R});}}if(n==='/api/users/bulk-delete'&&a['method']==='POST'){const a0=new Headers(j);addSecurityHeaders(a0,null,{});try{const a1=await a['json'](),a2=a1['uuids'];if(!Array['isArray'](a2)||a2['length']===0x0)throw new Error('Invalid\x20request:\x20Expected\x20array\x20of\x20UUIDs');const a3=b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?'),a4=a2['map'](function(a5){return a3['bind'](a5);});return await b['DB']['batch'](a4),new Response(JSON['stringify']({'success':!![],'count':a2['length']}),{'status':0xc8,'headers':a0});}catch(a5){return new Response(JSON['stringify']({'error':a5['message']}),{'status':0x190,'headers':a0});}}const u=n['match'](/^\/api\/users\/([a-f0-9-]+)$/);if(u&&a['method']==='PUT'){const a6=new Headers(j);addSecurityHeaders(a6,null,{});const a7=u[0x1];try{const a8=await a['json'](),a9=a8['exp_date'],aa=a8['exp_time'],ab=a8['notes'],ac=a8['traffic_limit'],ad=a8['ip_limit'],ae=a8['reset_traffic'];if(!a9||!aa||!/^\d{4}-\d{2}-\d{2}$/['test'](a9)||!/^\d{2}:\d{2}:\d{2}$/['test'](aa))throw new Error('Invalid\x20date/time\x20format');var f='UPDATE\x20users\x20SET\x20expiration_date\x20=\x20?,\x20expiration_time\x20=\x20?,\x20notes\x20=\x20?,\x20traffic_limit\x20=\x20?,\x20ip_limit\x20=\x20?',g=[a9,aa,ab||null,ac,ad||-0x1];return ae&&(f+=',\x20traffic_used\x20=\x200'),f+='\x20WHERE\x20uuid\x20=\x20?',g['push'](a7),await b['DB']['prepare'](f)['bind']['apply'](b['DB']['prepare'](f),g)['run'](),c['waitUntil'](kvDelete(b['DB'],'user:'+a7)),new Response(JSON['stringify']({'success':!![],'uuid':a7}),{'status':0xc8,'headers':a6});}catch(af){return new Response(JSON['stringify']({'error':af['message']}),{'status':0x190,'headers':a6});}}if(u&&a['method']==='DELETE'){const ag=new Headers(j);addSecurityHeaders(ag,null,{});const ah=u[0x1];try{return await b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](ah)['run'](),c['waitUntil'](kvDelete(b['DB'],'user:'+ah)),new Response(JSON['stringify']({'success':!![],'uuid':ah}),{'status':0xc8,'headers':ag});}catch(ai){return new Response(JSON['stringify']({'error':ai['message']}),{'status':0x1f4,'headers':ag});}}if(n==='/api/logout'&&a['method']==='POST'){const aj=new Headers(j);addSecurityHeaders(aj,null,{});try{return await kvDelete(b['DB'],'admin_session_token_hash'),aj['append']('Set-Cookie','auth_token=;\x20Max-Age=0;\x20Path=/;\x20Secure;\x20HttpOnly;\x20SameSite=Strict'),aj['append']('Set-Cookie','csrf_token=;\x20Max-Age=0;\x20Path=/;\x20Secure;\x20SameSite=Strict'),new Response(JSON['stringify']({'success':!![]}),{'status':0xc8,'headers':aj});}catch(ak){return new Response(JSON['stringify']({'error':ak['message']}),{'status':0x1f4,'headers':aj});}}if(n==='/api/health-check'&&a['method']==='POST'){const al=new Headers(j);addSecurityHeaders(al,null,{});try{return await performHealthCheck(b,c),new Response(JSON['stringify']({'success':!![]}),{'status':0xc8,'headers':al});}catch(am){return new Response(JSON['stringify']({'error':am['message']}),{'status':0x1f4,'headers':al});}}const v=new Headers(j);return addSecurityHeaders(v,null,{}),new Response(JSON['stringify']({'error':'API\x20route\x20not\x20found'}),{'status':0x194,'headers':v});}if(n==='/'){if(a['method']==='POST'){const ao='login_fail_ip:'+l;try{const ap=await kvGet(b['DB'],ao),aq=parseInt(ap,0xa)||0x0;if(aq>=CONST['ADMIN_LOGIN_FAIL_LIMIT'])return addSecurityHeaders(k,null,{}),new Response('Too\x20many\x20failed\x20attempts.\x20Try\x20again\x20later.',{'status':0x1ad,'headers':k});const ar=await a['formData']();if(timingSafeEqual(ar['get']('password'),b['ADMIN_KEY'])){if(b['ADMIN_TOTP_SECRET']){const aw=ar['get']('totp');if(!await validateTOTP(b['ADMIN_TOTP_SECRET'],aw)){const ax=generateNonce();return addSecurityHeaders(k,ax,{}),c['waitUntil'](kvPut(b['DB'],ao,(aq+0x1)['toString'](),{'expirationTtl':CONST['ADMIN_LOGIN_LOCK_TTL']})),new Response(getAdminLoginHTML(ax,m,'Invalid\x20TOTP\x20code.\x20Attempt\x20'+(aq+0x1)+'/'+CONST['ADMIN_LOGIN_FAIL_LIMIT']),{'status':0x191,'headers':k});}}const as=crypto['randomUUID'](),at=crypto['randomUUID'](),au=await hashSHA256(as);c['waitUntil'](Promise['all']([kvPut(b['DB'],'admin_session_token_hash',au,{'expirationTtl':0x15180}),kvDelete(b['DB'],ao)]));const av=new Headers({'Location':m});return av['append']('Set-Cookie','auth_token='+as+';\x20HttpOnly;\x20Secure;\x20Path='+m+';\x20Max-Age=86400;\x20SameSite=Strict'),av['append']('Set-Cookie','csrf_token='+at+';\x20Secure;\x20Path='+m+';\x20Max-Age=86400;\x20SameSite=Strict'),addSecurityHeaders(av,null,{}),new Response(null,{'status':0x12e,'headers':av});}else{c['waitUntil'](kvPut(b['DB'],ao,(aq+0x1)['toString'](),{'expirationTtl':CONST['ADMIN_LOGIN_LOCK_TTL']}));const ay=generateNonce();return addSecurityHeaders(k,ay,{}),new Response(getAdminLoginHTML(ay,m,'Invalid\x20password.\x20Attempt\x20'+(aq+0x1)+'/'+CONST['ADMIN_LOGIN_FAIL_LIMIT']),{'status':0x191,'headers':k});}}catch(az){return console['error']('Admin\x20login\x20error:',az),addSecurityHeaders(k,null,{}),new Response('Internal\x20error\x20during\x20login',{'status':0x1f4,'headers':k});}}if(a['method']==='GET'){const aA=generateNonce();addSecurityHeaders(k,aA,{});var h;return await isAdmin(a,b)?h=getAdminPanelHTML(aA,m+'/api'):h=getAdminLoginHTML(aA,m,''),new Response(h,{'headers':k});}const an=new Headers();return addSecurityHeaders(an,null,{}),new Response('Method\x20Not\x20Allowed',{'status':0x195,'headers':an});}const o=new Headers();return addSecurityHeaders(o,null,{}),new Response('Not\x20found',{'status':0x194,'headers':o});}catch(aB){console['error']('handleAdminRequest\x20error:',aB['message'],aB['stack']);const aC=new Headers();return addSecurityHeaders(aC,null,{}),new Response('Internal\x20Server\x20Error',{'status':0x1f4,'headers':aC});}}async function resolveProxyIP(a){const b=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,c=/^\[?[0-9a-fA-F:]+\]?$/;if(b['test'](a)||c['test'](a))return a;const d=[{'url':'https://cloudflare-dns.com/dns-query?name='+encodeURIComponent(a)+'&type=A','parse':function(g){var h=g['Answer'];return h?(h['find'](function(j){return j['type']===0x1;})||{})['data']:null;}},{'url':'https://dns.google/resolve?name='+encodeURIComponent(a)+'&type=A','parse':function(g){var h=g['Answer'];return h?(h['find'](function(j){return j['type']===0x1;})||{})['data']:null;}}];for(var f=0x0;f<d['length'];f++){const g=d[f];try{const h=await fetch(g['url'],{'headers':{'accept':'application/dns-json'}});if(h['ok']){const j=await h['json'](),k=g['parse'](j);if(k&&b['test'](k))return k;}}catch(l){}}return a;}async function getGeo(a,b){if(b&&(b['city']||b['country']))return{'city':b['city']||'','country':b['country']||'','isp':b['asOrganization']||''};const c=[{'url':'https://ip-api.com/json/'+a+'?fields=status,message,city,country,isp','parse':async function(f){const g=await f['json']();if(g['status']==='fail')throw new Error(g['message']||'API\x20Error');return{'city':g['city']||'','country':g['country']||'','isp':g['isp']||''};}},{'url':'https://ipwho.is/'+a,'parse':async function(f){const g=await f['json']();if(!g['success'])throw new Error('API\x20Error');return{'city':g['city']||'','country':g['country']||'','isp':(g['connection']?g['connection']['isp']:'')||''};}}];for(var d=0x0;d<c['length'];d++){const f=c[d];try{const g=new AbortController(),h=setTimeout(function(){g['abort']();},0xbb8),j=await fetch(f['url'],{'signal':g['signal'],'headers':{'Accept':'application/json'}});clearTimeout(h);if(j['ok']){const k=await f['parse'](j);if(k&&(k['city']||k['country']))return k;}}catch(l){}}return{'city':'','country':'Global','isp':'Cloudflare'};}function getUserPanelHTML(a){const b=a['nonce'],c=a['userID'],d=a['hostName'],e=a['proxyAddress'],f=a['proxyIP'],g=a['proxyGeo'],h=a['clientIp'],i=a['clientGeo'],j=a['userData'],k=a['singleXrayConfig'],l=a['singleSingboxConfig'],m=a['subXrayUrl'],n=a['subSbUrl'],o=a['isUserExpired'],p=a['usageDisplay'],q=a['trafficLimitStr'],r=a['usagePercentage'],s=a['expirationDateTime'],t=[g['city'],g['country']]['filter'](Boolean)['join'](',\x20')||'Unknown',u=[i['city'],i['country']]['filter'](Boolean)['join'](',\x20')||'Unknown';return'<!DOCTYPE\x20html>'+'<html\x20lang=\x22en\x22>'+'<head>'+'\x20\x20<meta\x20charset=\x22UTF-8\x22>'+'\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>'+'\x20\x20<title>User\x20Panel\x20-\x20VLESS\x20Configuration</title>'+'\x20\x20<style\x20nonce=\x22'+b+'\x22>'+'\x20\x20\x20\x20:root\x20{'+'\x20\x20\x20\x20\x20\x20--bg:\x20#0b1220;\x20--card:\x20#0f1724;\x20--muted:\x20#9aa4b2;\x20--accent:\x20#3b82f6;'+'\x20\x20\x20\x20\x20\x20--success:\x20#22c55e;\x20--danger:\x20#ef4444;\x20--warning:\x20#f59e0b;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20*\x20{\x20box-sizing:\x20border-box;\x20margin:\x200;\x20padding:\x200;\x20}'+'\x20\x20\x20\x20body\x20{'+'\x20\x20\x20\x20\x20\x20font-family:\x20Inter,\x20system-ui,\x20-apple-system,\x20sans-serif;'+'\x20\x20\x20\x20\x20\x20background:\x20linear-gradient(135deg,\x20#030712\x200%,\x20#0f172a\x2050%,\x20#030712\x20100%);'+'\x20\x20\x20\x20\x20\x20color:\x20#e6eef8;\x20min-height:\x20100vh;\x20padding:\x2020px;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20.container\x20{\x20max-width:\x201100px;\x20margin:\x200\x20auto;\x20}'+'\x20\x20\x20\x20.card\x20{'+'\x20\x20\x20\x20\x20\x20background:\x20rgba(15,\x2023,\x2036,\x200.9);'+'\x20\x20\x20\x20\x20\x20backdrop-filter:\x20blur(20px);'+'\x20\x20\x20\x20\x20\x20border-radius:\x2016px;\x20padding:\x2024px;'+'\x20\x20\x20\x20\x20\x20border:\x201px\x20solid\x20rgba(255,255,255,0.06);'+'\x20\x20\x20\x20\x20\x20margin-bottom:\x2020px;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20h1\x20{\x20font-size:\x2028px;\x20margin-bottom:\x208px;\x20color:\x20var(--accent);\x20}'+'\x20\x20\x20\x20h2\x20{\x20font-size:\x2018px;\x20margin-bottom:\x2016px;\x20border-bottom:\x202px\x20solid\x20var(--accent);\x20padding-bottom:\x208px;\x20}'+'\x20\x20\x20\x20.lead\x20{\x20color:\x20var(--muted);\x20margin-bottom:\x2024px;\x20}'+'\x20\x20\x20\x20.stats\x20{\x20display:\x20grid;\x20grid-template-columns:\x20repeat(auto-fit,\x20minmax(150px,\x201fr));\x20gap:\x2016px;\x20margin-bottom:\x2024px;\x20}'+'\x20\x20\x20\x20.stat\x20{'+'\x20\x20\x20\x20\x20\x20padding:\x2016px;\x20background:\x20rgba(30,\x2041,\x2059,\x200.6);'+'\x20\x20\x20\x20\x20\x20border-radius:\x2012px;\x20text-align:\x20center;'+'\x20\x20\x20\x20\x20\x20border:\x201px\x20solid\x20rgba(255,255,255,0.04);'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20.stat\x20.val\x20{\x20font-size:\x2022px;\x20font-weight:\x20700;\x20margin-bottom:\x204px;\x20}'+'\x20\x20\x20\x20.stat\x20.lbl\x20{\x20font-size:\x2011px;\x20color:\x20var(--muted);\x20text-transform:\x20uppercase;\x20}'+'\x20\x20\x20\x20.stat.active\x20.val\x20{\x20color:\x20var(--success);\x20}'+'\x20\x20\x20\x20.stat.expired\x20.val\x20{\x20color:\x20var(--danger);\x20}'+'\x20\x20\x20\x20.info-grid\x20{\x20display:\x20grid;\x20grid-template-columns:\x20repeat(auto-fit,\x20minmax(170px,\x201fr));\x20gap:\x2012px;\x20margin-top:\x2016px;\x20}'+'\x20\x20\x20\x20.info-item\x20{\x20background:\x20rgba(255,255,255,0.02);\x20padding:\x2012px;\x20border-radius:\x208px;\x20}'+'\x20\x20\x20\x20.info-item\x20.label\x20{\x20font-size:\x2011px;\x20color:\x20var(--muted);\x20text-transform:\x20uppercase;\x20margin-bottom:\x204px;\x20}'+'\x20\x20\x20\x20.info-item\x20.value\x20{\x20font-weight:\x20600;\x20word-break:\x20break-all;\x20font-size:\x2013px;\x20}'+'\x20\x20\x20\x20.progress-bar\x20{'+'\x20\x20\x20\x20\x20\x20height:\x2012px;\x20background:\x20rgba(7,21,41,0.8);'+'\x20\x20\x20\x20\x20\x20border-radius:\x208px;\x20overflow:\x20hidden;\x20margin:\x2012px\x200;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20.progress-fill\x20{\x20height:\x20100%;\x20border-radius:\x208px;\x20transition:\x20width\x201s\x20ease;\x20}'+'\x20\x20\x20\x20.progress-fill.low\x20{\x20background:\x20linear-gradient(90deg,\x20#22c55e,\x20#16a34a);\x20}'+'\x20\x20\x20\x20.progress-fill.medium\x20{\x20background:\x20linear-gradient(90deg,\x20#f59e0b,\x20#d97706);\x20}'+'\x20\x20\x20\x20.progress-fill.high\x20{\x20background:\x20linear-gradient(90deg,\x20#ef4444,\x20#dc2626);\x20}'+'\x20\x20\x20\x20.btn\x20{'+'\x20\x20\x20\x20\x20\x20display:\x20inline-flex;\x20align-items:\x20center;\x20gap:\x208px;'+'\x20\x20\x20\x20\x20\x20padding:\x2010px\x2016px;\x20border-radius:\x208px;\x20border:\x20none;'+'\x20\x20\x20\x20\x20\x20cursor:\x20pointer;\x20font-weight:\x20600;\x20font-size:\x2014px;'+'\x20\x20\x20\x20\x20\x20transition:\x20all\x200.2s;\x20text-decoration:\x20none;\x20color:\x20inherit;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20.btn.primary\x20{\x20background:\x20linear-gradient(135deg,\x20#3b82f6,\x20#2563eb);\x20color:\x20white;\x20}'+'\x20\x20\x20\x20.btn.primary:hover\x20{\x20transform:\x20translateY(-2px);\x20box-shadow:\x200\x208px\x2020px\x20rgba(59,130,246,0.4);\x20}'+'\x20\x20\x20\x20.btn.ghost\x20{\x20background:\x20rgba(255,255,255,0.05);\x20border:\x201px\x20solid\x20rgba(255,255,255,0.1);\x20color:\x20var(--muted);\x20}'+'\x20\x20\x20\x20.btn.ghost:hover\x20{\x20background:\x20rgba(255,255,255,0.1);\x20color:\x20white;\x20}'+'\x20\x20\x20\x20.buttons\x20{\x20display:\x20flex;\x20gap:\x2010px;\x20flex-wrap:\x20wrap;\x20margin-top:\x2012px;\x20}'+'\x20\x20\x20\x20pre.config\x20{'+'\x20\x20\x20\x20\x20\x20background:\x20#071529;\x20padding:\x2012px;\x20border-radius:\x208px;'+'\x20\x20\x20\x20\x20\x20overflow:\x20auto;\x20font-family:\x20monospace;\x20font-size:\x2012px;'+'\x20\x20\x20\x20\x20\x20color:\x20#cfe8ff;\x20max-height:\x20180px;\x20display:\x20none;\x20margin-top:\x2012px;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20pre.config.show\x20{\x20display:\x20block;\x20}'+'\x20\x20\x20\x20.qr-container\x20{'+'\x20\x20\x20\x20\x20\x20background:\x20white;\x20padding:\x2020px;\x20border-radius:\x2016px;'+'\x20\x20\x20\x20\x20\x20display:\x20inline-block;\x20box-shadow:\x200\x208px\x2025px\x20rgba(0,0,0,0.2);'+'\x20\x20\x20\x20\x20\x20margin:\x2016px\x200;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20#qr-display\x20{\x20min-height:\x20280px;\x20display:\x20flex;\x20align-items:\x20center;\x20justify-content:\x20center;\x20flex-direction:\x20column;\x20}'+'\x20\x20\x20\x20#toast\x20{'+'\x20\x20\x20\x20\x20\x20position:\x20fixed;\x20right:\x2020px;\x20top:\x2020px;'+'\x20\x20\x20\x20\x20\x20background:\x20rgba(15,27,42,0.98);\x20backdrop-filter:\x20blur(20px);'+'\x20\x20\x20\x20\x20\x20padding:\x2014px\x2018px;\x20border-radius:\x2012px;'+'\x20\x20\x20\x20\x20\x20border:\x201px\x20solid\x20rgba(255,255,255,0.08);'+'\x20\x20\x20\x20\x20\x20display:\x20none;\x20color:\x20#cfe8ff;\x20z-index:\x201000;'+'\x20\x20\x20\x20}'+'\x20\x20\x20\x20#toast.show\x20{\x20display:\x20block;\x20}'+'\x20\x20\x20\x20#toast.success\x20{\x20border-left:\x204px\x20solid\x20var(--success);\x20}'+'\x20\x20\x20\x20#toast.error\x20{\x20border-left:\x204px\x20solid\x20var(--danger);\x20}'+'\x20\x20\x20\x20.grid\x20{\x20display:\x20grid;\x20grid-template-columns:\x201fr\x20360px;\x20gap:\x2020px;\x20}'+'\x20\x20\x20\x20@media\x20(max-width:\x20900px)\x20{\x20.grid\x20{\x20grid-template-columns:\x201fr;\x20}\x20}'+'\x20\x20\x20\x20.text-center\x20{\x20text-align:\x20center;\x20}'+'\x20\x20\x20\x20.expiry-warning\x20{\x20background:\x20rgba(239,68,68,0.1);\x20border:\x201px\x20solid\x20rgba(239,68,68,0.3);\x20padding:\x2012px;\x20border-radius:\x208px;\x20margin-top:\x2012px;\x20color:\x20#fca5a5;\x20}'+'\x20\x20\x20\x20.expiry-info\x20{\x20background:\x20rgba(34,197,94,0.1);\x20border:\x201px\x20solid\x20rgba(34,197,94,0.3);\x20padding:\x2012px;\x20border-radius:\x208px;\x20margin-top:\x2012px;\x20color:\x20#86efac;\x20}'+'\x20\x20</style>'+'</head>'+'<body>'+'\x20\x20<div\x20class=\x22container\x22>'+'\x20\x20\x20\x20<h1>VXR.SXR\x20Configuration\x20Panel</h1>'+'\x20\x20\x20\x20<p\x20class=\x22lead\x22>Manage\x20your\x20proxy\x20configuration\x20and\x20view\x20subscription\x20links.</p>'+'\x20\x20\x20\x20<div\x20class=\x22stats\x22>'+'\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat\x20'+(o?'expired':'active')+'\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22val\x22>'+(o?'Expired':'Active')+'</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22lbl\x22>Status</div>'+'\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22val\x22>'+p+'</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22lbl\x22>Data\x20Used</div>'+'\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22val\x22>'+q+'</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22lbl\x22>Data\x20Limit</div>'+'\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22val\x22\x20id=\x22expiry-countdown\x22>--</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22lbl\x22>Time\x20Left</div>'+'\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20</div>'+(j['traffic_limit']&&j['traffic_limit']>0x0?'\x20\x20\x20\x20<div\x20class=\x22card\x22>'+'\x20\x20\x20\x20\x20\x20<h2>Usage\x20Statistics</h2>'+'\x20\x20\x20\x20\x20\x20<div\x20class=\x22progress-bar\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22progress-fill\x20'+(r>0x50?'high':r>0x32?'medium':'low')+'\x22\x20style=\x22width:'+r['toFixed'](0x2)+'%\x22></div>'+'\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20<p\x20class=\x22text-center\x22\x20style=\x22color:var(--muted);\x22>'+p+'\x20of\x20'+q+'\x20('+r['toFixed'](0x2)+'%)</p>'+'\x20\x20\x20\x20</div>':'')+(s?'\x20\x20\x20\x20<div\x20class=\x22card\x22>'+'\x20\x20\x20\x20\x20\x20<h2>Expiration</h2>'+'\x20\x20\x20\x20\x20\x20<p\x20id=\x22expiry-local\x22\x20style=\x22color:var(--muted);\x22>Loading...</p>'+(o?'<div\x20class=\x22expiry-warning\x22>Your\x20account\x20has\x20expired.\x20Please\x20contact\x20admin\x20to\x20renew.</div>':'<div\x20class=\x22expiry-info\x22>Your\x20account\x20is\x20active.</div>')+'\x20\x20\x20\x20</div>':'')+'\x20\x20\x20\x20<div\x20class=\x22grid\x22>'+'\x20\x20\x20\x20\x20\x20<div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22card\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h2>Network\x20Information</h2>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-grid\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22><span\x20class=\x22label\x22>Proxy\x20Host</span><span\x20class=\x22value\x22>'+escapeHTML(e||d)+'</span></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22><span\x20class=\x22label\x22>Proxy\x20IP</span><span\x20class=\x22value\x22>'+escapeHTML(f)+'</span></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22><span\x20class=\x22label\x22>Proxy\x20Location</span><span\x20class=\x22value\x22>'+escapeHTML(t)+'</span></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22><span\x20class=\x22label\x22>Your\x20IP</span><span\x20class=\x22value\x22>'+escapeHTML(h)+'</span></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22><span\x20class=\x22label\x22>Your\x20Location</span><span\x20class=\x22value\x22>'+escapeHTML(u)+'</span></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22><span\x20class=\x22label\x22>Your\x20ISP</span><span\x20class=\x22value\x22>'+escapeHTML(i['isp']||'Unknown')+'</span></div>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22card\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h2>Subscription\x20Links</h2>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h3\x20style=\x22font-size:15px;margin:12px\x200\x208px;color:var(--accent);\x22>Xray\x20/\x20V2Ray</h3>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22buttons\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20primary\x22\x20id=\x22btn-copy-xray-sub\x22>Copy\x20Sub\x20Link</button>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20ghost\x22\x20id=\x22btn-copy-xray-config\x22>Copy\x20Config</button>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20ghost\x22\x20id=\x22btn-toggle-xray\x22>View\x20Config</button>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20ghost\x22\x20id=\x22btn-qr-xray\x22>QR\x20Code</button>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<pre\x20class=\x22config\x22\x20id=\x22xray-config\x22>'+escapeHTML(k)+'</pre>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h3\x20style=\x22font-size:15px;margin:16px\x200\x208px;color:var(--accent);\x22>Sing-Box\x20/\x20Clash</h3>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22buttons\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20primary\x22\x20id=\x22btn-copy-sb-sub\x22>Copy\x20Sub\x20Link</button>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20ghost\x22\x20id=\x22btn-copy-sb-config\x22>Copy\x20Config</button>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20ghost\x22\x20id=\x22btn-toggle-sb\x22>View\x20Config</button>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20ghost\x22\x20id=\x22btn-qr-sb\x22>QR\x20Code</button>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<pre\x20class=\x22config\x22\x20id=\x22sb-config\x22>'+escapeHTML(l)+'</pre>'+'\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20<aside>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22card\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h2>QR\x20Code\x20Scanner</h2>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22color:var(--muted);margin-bottom:12px;\x22>Scan\x20with\x20your\x20VPN\x20app\x20to\x20import\x20config.</p>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22qr-display\x22\x20class=\x22text-center\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22color:var(--muted);\x22>Click\x20a\x20QR\x20Code\x20button\x20to\x20generate.</p>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22card\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h2>Account\x20Details</h2>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22\x20style=\x22margin-top:12px;\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22label\x22>UUID</span>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22value\x22\x20style=\x22font-family:monospace;font-size:11px;\x22>'+escapeHTML(c)+'</span>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22\x20style=\x22margin-top:12px;\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22label\x22>Created</span>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22value\x22>'+(j['created_at']?new Date(j['created_at'])['toLocaleDateString']():'N/A')+'</span>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>'+(j['notes']?'<div\x20class=\x22info-item\x22\x20style=\x22margin-top:12px;\x22><span\x20class=\x22label\x22>Notes</span><span\x20class=\x22value\x22>'+escapeHTML(j['notes'])+'</span></div>':'')+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-item\x22\x20style=\x22margin-top:12px;\x22>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22label\x22>IP\x20Limit</span>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22value\x22>'+(j['ip_limit']===-0x1?'Unlimited':j['ip_limit'])+'</span>'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20\x20\x20</aside>'+'\x20\x20\x20\x20</div>'+'\x20\x20\x20\x20<div\x20class=\x22card\x22>'+'\x20\x20\x20\x20\x20\x20<p\x20class=\x22text-center\x22\x20style=\x22color:var(--muted);\x22>Keep\x20your\x20subscription\x20links\x20private.\x20For\x20support,\x20contact\x20your\x20administrator.</p>'+'\x20\x20\x20\x20</div>'+'\x20\x20</div>'+'\x20\x20<div\x20id=\x22toast\x22></div>'+'\x20\x20<script\x20src=\x22https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js\x22\x20integrity=\x22sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA==\x22\x20crossorigin=\x22anonymous\x22\x20referrerpolicy=\x22no-referrer\x22></script>'+'\x20\x20<script\x20nonce=\x22'+b+'\x22>'+'\x20\x20\x20\x20(function()\x20{'+'\x20\x20\x20\x20\x20\x20var\x20CONFIG\x20=\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20uuid:\x20\x22'+c+'\x22,'+'\x20\x20\x20\x20\x20\x20\x20\x20subXrayUrl:\x20\x22'+m+'\x22,'+'\x20\x20\x20\x20\x20\x20\x20\x20subSbUrl:\x20\x22'+n+'\x22,'+'\x20\x20\x20\x20\x20\x20\x20\x20singleXrayConfig:\x20'+JSON['stringify'](k)+','+'\x20\x20\x20\x20\x20\x20\x20\x20singleSingboxConfig:\x20'+JSON['stringify'](l)+','+'\x20\x20\x20\x20\x20\x20\x20\x20expirationDateTime:\x20'+(s?'\x22'+s+'\x22':'null')+'\x20\x20\x20\x20\x20\x20};'+'\x20\x20\x20\x20\x20\x20function\x20showToast(msg,\x20isErr)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20t\x20=\x20document.getElementById(\x22toast\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20t.textContent\x20=\x20msg;'+'\x20\x20\x20\x20\x20\x20\x20\x20t.className\x20=\x20(isErr\x20?\x20\x22error\x22\x20:\x20\x22success\x22)\x20+\x20\x22\x20show\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20setTimeout(function()\x20{\x20t.className\x20=\x20\x22\x22;\x20},\x203000);'+'\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20function\x20copyText(text,\x20btn)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20navigator.clipboard.writeText(text).then(function()\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20orig\x20=\x20btn.textContent;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20btn.textContent\x20=\x20\x22Copied!\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x22Copied\x20to\x20clipboard!\x22,\x20false);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20setTimeout(function()\x20{\x20btn.textContent\x20=\x20orig;\x20},\x202000);'+'\x20\x20\x20\x20\x20\x20\x20\x20}).catch(function()\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20ta\x20=\x20document.createElement(\x22textarea\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ta.value\x20=\x20text;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ta.style.cssText\x20=\x20\x22position:fixed;top:-9999px;\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.body.appendChild(ta);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ta.select();'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20try\x20{\x20document.execCommand(\x22copy\x22);\x20showToast(\x22Copied!\x22,\x20false);\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20catch(e)\x20{\x20showToast(\x22Copy\x20failed\x22,\x20true);\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.body.removeChild(ta);'+'\x20\x20\x20\x20\x20\x20\x20\x20});'+'\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20function\x20generateQR(text)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20container\x20=\x20document.getElementById(\x22qr-display\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20container.innerHTML\x20=\x20\x22\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!text\x20||\x20text.length\x20===\x200)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20container.innerHTML\x20=\x20\x22<p\x20style=color:#ef4444>No\x20config\x20data\x20to\x20generate\x20QR\x20code.</p>\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x22No\x20config\x20data\x22,\x20true);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;'+'\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20cleanText\x20=\x20text.trim();'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(cleanText.length\x20>\x202953)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20container.innerHTML\x20=\x20\x22<p\x20style=color:#ef4444>Config\x20too\x20large\x20for\x20QR\x20code.\x20Please\x20copy\x20the\x20link\x20instead.</p>\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x22Config\x20too\x20large\x20for\x20QR\x22,\x20true);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;'+'\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20try\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(typeof\x20QRCode\x20!==\x20\x22undefined\x22)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20qrDiv\x20=\x20document.createElement(\x22div\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20qrDiv.className\x20=\x20\x22qr-container\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20new\x20QRCode(qrDiv,\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20text:\x20cleanText,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20width:\x20256,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20height:\x20256,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20colorDark:\x20\x22#000000\x22,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20colorLight:\x20\x22#ffffff\x22,'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20correctLevel:\x20QRCode.CorrectLevel.L'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20});'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20container.appendChild(qrDiv);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x22QR\x20Code\x20generated!\x22,\x20false);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x20else\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20throw\x20new\x20Error(\x22QRCode\x20library\x20not\x20loaded\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20}\x20catch\x20(e)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20console.error(\x22QR\x20generation\x20failed:\x22,\x20e);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20encoded\x20=\x20encodeURIComponent(cleanText);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20googleUrl\x20=\x20\x22https://chart.googleapis.com/chart?cht=qr&chl=\x22\x20+\x20encoded\x20+\x20\x22&chs=256x256&choe=UTF-8&chld=L|1\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(googleUrl.length\x20>\x202000)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20container.innerHTML\x20=\x20\x22<p\x20style=color:#ef4444>Config\x20too\x20large.\x20Please\x20copy\x20the\x20link\x20instead.</p>\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x22Config\x20too\x20large\x20for\x20QR\x22,\x20true);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20wrapper\x20=\x20document.createElement(\x22div\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20wrapper.className\x20=\x20\x22qr-container\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20img\x20=\x20document.createElement(\x22img\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20img.src\x20=\x20googleUrl;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20img.alt\x20=\x20\x22QR\x20Code\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20img.style.cssText\x20=\x20\x22display:block;width:256px;height:256px;\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20img.onerror\x20=\x20function()\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20container.innerHTML\x20=\x20\x22<p\x20style=color:#ef4444>QR\x20generation\x20failed.\x20Copy\x20the\x20link\x20instead.</p>\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x22QR\x20generation\x20failed\x22,\x20true);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20};'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20img.onload\x20=\x20function()\x20{\x20showToast(\x22QR\x20Code\x20generated!\x22,\x20false);\x20};'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20wrapper.appendChild(img);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20container.appendChild(wrapper);'+'\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22btn-copy-xray-sub\x22).addEventListener(\x22click\x22,\x20function()\x20{\x20copyText(CONFIG.subXrayUrl,\x20this);\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22btn-copy-xray-config\x22).addEventListener(\x22click\x22,\x20function()\x20{\x20copyText(CONFIG.singleXrayConfig,\x20this);\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22btn-toggle-xray\x22).addEventListener(\x22click\x22,\x20function()\x20{\x20document.getElementById(\x22xray-config\x22).classList.toggle(\x22show\x22);\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22btn-qr-xray\x22).addEventListener(\x22click\x22,\x20function()\x20{\x20generateQR(CONFIG.singleXrayConfig);\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22btn-copy-sb-sub\x22).addEventListener(\x22click\x22,\x20function()\x20{\x20copyText(CONFIG.subSbUrl,\x20this);\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22btn-copy-sb-config\x22).addEventListener(\x22click\x22,\x20function()\x20{\x20copyText(CONFIG.singleSingboxConfig,\x20this);\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22btn-toggle-sb\x22).addEventListener(\x22click\x22,\x20function()\x20{\x20document.getElementById(\x22sb-config\x22).classList.toggle(\x22show\x22);\x20});'+'\x20\x20\x20\x20\x20\x20document.getElementById(\x22btn-qr-sb\x22).addEventListener(\x22click\x22,\x20function()\x20{\x20generateQR(CONFIG.singleSingboxConfig);\x20});'+'\x20\x20\x20\x20\x20\x20function\x20updateExpiry()\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!CONFIG.expirationDateTime)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22expiry-countdown\x22).textContent\x20=\x20\x22Unlimited\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20var\x20el\x20=\x20document.getElementById(\x22expiry-local\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(el)\x20el.textContent\x20=\x20\x22No\x20expiration\x20set\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;'+'\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20exp\x20=\x20new\x20Date(CONFIG.expirationDateTime);'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(isNaN(exp.getTime()))\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x22expiry-countdown\x22).textContent\x20=\x20\x22Invalid\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;'+'\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20now\x20=\x20new\x20Date();'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20diff\x20=\x20Math.floor((exp\x20-\x20now)\x20/\x201000);'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20countdownEl\x20=\x20document.getElementById(\x22expiry-countdown\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20localEl\x20=\x20document.getElementById(\x22expiry-local\x22);'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(diff\x20<\x200)\x20{'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20countdownEl.textContent\x20=\x20\x22Expired\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;'+'\x20\x20\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20d\x20=\x20Math.floor(diff\x20/\x2086400);'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20h\x20=\x20Math.floor((diff\x20%\x2086400)\x20/\x203600);'+'\x20\x20\x20\x20\x20\x20\x20\x20var\x20m\x20=\x20Math.floor((diff\x20%\x203600)\x20/\x2060);'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(d\x20>\x200)\x20countdownEl.textContent\x20=\x20d\x20+\x20\x22d\x20\x22\x20+\x20h\x20+\x20\x22h\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20else\x20if\x20(h\x20>\x200)\x20countdownEl.textContent\x20=\x20h\x20+\x20\x22h\x20\x22\x20+\x20m\x20+\x20\x22m\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20else\x20countdownEl.textContent\x20=\x20m\x20+\x20\x22m\x22;'+'\x20\x20\x20\x20\x20\x20\x20\x20if\x20(localEl)\x20localEl.textContent\x20=\x20\x22Expires:\x20\x22\x20+\x20exp.toLocaleString();'+'\x20\x20\x20\x20\x20\x20}'+'\x20\x20\x20\x20\x20\x20updateExpiry();'+'\x20\x20\x20\x20\x20\x20setInterval(updateExpiry,\x201000);'+'\x20\x20\x20\x20})();'+'\x20\x20</script>'+'</body>'+'</html>';}async function handleUserPanel(a,b,c,d,f,g){try{const j='https://'+c+'/xray/'+b,k='https://'+c+'/sb/'+b,l=buildLink({'core':'xray','proto':'tls','userID':b,'hostName':c,'address':c,'port':0x1bb,'tag':'Main'}),m=buildLink({'core':'sb','proto':'tls','userID':b,'hostName':c,'address':c,'port':0x1bb,'tag':'Main'}),n=isExpired(f['expiration_date'],f['expiration_time']),o=f['expiration_date']&&f['expiration_time']?f['expiration_date']+'T'+f['expiration_time']+'Z':null;var h=0x0;f['traffic_limit']&&f['traffic_limit']>0x0&&(h=Math['min']((f['traffic_used']||0x0)/f['traffic_limit']*0x64,0x64));const p=a['cf']||{},q={'city':p['city']||'','country':p['country']||'','isp':p['asOrganization']||''},r=d['split'](':')[0x0],s=await resolveProxyIP(r),t=await getGeo(s)||{'city':'','country':'','isp':''},u=formatBytes(f['traffic_used']||0x0);var i='Unlimited';f['traffic_limit']&&f['traffic_limit']>0x0&&(i=formatBytes(f['traffic_limit']));const v=generateNonce(),w=new Headers({'Content-Type':'text/html;charset=utf-8'});addSecurityHeaders(w,v,{'img':'data:\x20https:','connect':'https:'});const x=getUserPanelHTML({'nonce':v,'userID':b,'hostName':c,'proxyAddress':d,'proxyIP':s,'proxyGeo':t,'clientIp':g,'clientGeo':q,'userData':f,'singleXrayConfig':l,'singleSingboxConfig':m,'subXrayUrl':j,'subSbUrl':k,'isUserExpired':n,'usageDisplay':u,'trafficLimitStr':i,'usagePercentage':h,'expirationDateTime':o});return new Response(x,{'headers':w});}catch(y){console['error']('handleUserPanel\x20error:',y['message'],y['stack']);const z=new Headers();return addSecurityHeaders(z,null,{}),new Response('Internal\x20Server\x20Error',{'status':0x1f4,'headers':z});}}async function ProtocolOverWSHandler(a,b,c,d){var f=null;try{const m=a['headers']['get']('CF-Connecting-IP');if(await isSuspiciousIP(m,b['scamalytics'],c['SCAMALYTICS_THRESHOLD']||CONST['SCAMALYTICS_THRESHOLD']))return new Response('Access\x20denied',{'status':0x193});const n=new WebSocketPair(),o=n[0x0],p=n[0x1];f=p,f['accept']();var g='',h='',i=0x0,j='',k=null;function q(w,x){console['log']('['+g+':'+h+']\x20'+w,x||'');}function r(){if(i>0x0&&j){const w=i,x=j;i=0x0,d['waitUntil'](updateUsage(c,x,w,d)['catch'](function(y){console['error']('Deferred\x20usage\x20update\x20failed\x20for\x20'+x+':',y);}));}}const s=setInterval(r,0x2710);function t(){clearInterval(s),r();}f['addEventListener']('close',t,{'once':!![]}),f['addEventListener']('error',t,{'once':!![]});const u=a['headers']['get']('Sec-WebSocket-Protocol')||'',v=MakeReadableWebSocketStream(f,u,q);var l={'value':null};return v['pipeTo'](new WritableStream({async 'write'(w,x){i+=w['byteLength'];if(k)return k['write'](w);if(l['value']){const B=l['value']['writable']['getWriter']();await B['write'](w),B['releaseLock']();return;}const y=await ProcessProtocolHeader(w,c,d);if(y['hasError']||!y['user']){x['error'](new Error('Authentication\x20failed'));return;}j=y['user']['uuid'];if(isExpired(y['user']['expiration_date'],y['user']['expiration_time'])){x['error'](new Error('Account\x20expired'));return;}if(y['user']['traffic_limit']&&y['user']['traffic_limit']>0x0){const C=(y['user']['traffic_used']||0x0)+i;if(C>=y['user']['traffic_limit']){x['error'](new Error('Traffic\x20limit\x20exceeded'));return;}}if(y['user']['ip_limit']&&y['user']['ip_limit']>-0x1){const D=await c['DB']['prepare']('SELECT\x20COUNT(DISTINCT\x20ip)\x20as\x20count\x20FROM\x20user_ips\x20WHERE\x20uuid\x20=\x20?')['bind'](j)['first']('count'),E=D||0x0;if(E>=y['user']['ip_limit']){const F=await c['DB']['prepare']('SELECT\x20ip\x20FROM\x20user_ips\x20WHERE\x20uuid\x20=\x20?\x20AND\x20ip\x20=\x20?')['bind'](j,m)['first']();if(!F){x['error'](new Error('IP\x20limit\x20exceeded'));return;}}await c['DB']['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20user_ips\x20(uuid,\x20ip,\x20last_seen)\x20VALUES\x20(?,\x20?,\x20CURRENT_TIMESTAMP)')['bind'](j,m)['run']();}g=y['addressRemote'],h=y['portRemote']+'--'+Math['random']()+(y['isUDP']?'\x20udp':'\x20tcp');const z=new Uint8Array([y['ProtocolVersion'][0x0],0x0]),A=w['slice'](y['rawDataIndex']);if(y['isUDP']){if(y['portRemote']===0x35){const G=await createDnsPipeline(f,z,q,function(H){i+=H;});k=G['write'],await k(A);}else x['error'](new Error('UDP\x20only\x20supported\x20for\x20DNS\x20(port\x2053)'));return;}HandleTCPOutBound(l,y['addressType'],y['addressRemote'],y['portRemote'],A,f,z,q,b,function(H){i+=H;});},'close':function(){q('readableWebSocketStream\x20closed'),t();},'abort':function(w){q('readableWebSocketStream\x20aborted',w),t();}}))['catch'](function(w){console['error']('Pipeline\x20failed:',w['stack']||w),safeCloseWebSocket(f),t();}),new Response(null,{'status':0x65,'webSocket':o});}catch(w){console['error']('ProtocolOverWSHandler\x20error:',w['message'],w['stack']);if(f)try{safeCloseWebSocket(f);}catch(y){console['error']('Error\x20closing\x20WebSocket:',y);}const x=new Headers();return addSecurityHeaders(x,null,{}),new Response('Internal\x20Server\x20Error',{'status':0x1f4,'headers':x});}}async function ProcessProtocolHeader(a,b,c){try{if(a['byteLength']<0x18)return{'hasError':!![],'message':'invalid\x20data'};const l=new DataView(a['buffer']||a),m=l['getUint8'](0x0);var d;try{d=stringify(new Uint8Array(a['slice'](0x1,0x11)));}catch(x){return{'hasError':!![],'message':'invalid\x20UUID\x20format'};}const n=await getUserData(b,d,c);if(!n)return{'hasError':!![],'message':'invalid\x20user'};const o=0x11;if(a['byteLength']<o+0x1)return{'hasError':!![],'message':'invalid\x20data\x20length'};const p=l['getUint8'](o),q=o+0x1+p;if(a['byteLength']<q+0x1)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(command)'};const r=l['getUint8'](q);if(r!==0x1&&r!==0x2)return{'hasError':!![],'message':'command\x20'+r+'\x20not\x20supported'};const s=q+0x1;if(a['byteLength']<s+0x2)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(port)'};const t=l['getUint16'](s,![]),u=s+0x2;if(a['byteLength']<u+0x1)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(address\x20type)'};const v=l['getUint8'](u);var f,g,h;switch(v){case 0x1:g=0x4,h=u+0x1;if(a['byteLength']<h+g)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(ipv4)'};f=new Uint8Array(a['slice'](h,h+g))['join']('.');break;case 0x2:if(a['byteLength']<u+0x2)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(domain\x20length)'};g=l['getUint8'](u+0x1),h=u+0x2;if(a['byteLength']<h+g)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(domain)'};f=new TextDecoder()['decode'](a['slice'](h,h+g));break;case 0x3:g=0x10,h=u+0x1;if(a['byteLength']<h+g)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(ipv6)'};var j=[];for(var k=0x0;k<0x8;k++){j['push'](l['getUint16'](h+k*0x2,![])['toString'](0x10));}f=j['join'](':');break;default:return{'hasError':!![],'message':'invalid\x20addressType:\x20'+v};}const w=h+g;if(a['byteLength']<w)return{'hasError':!![],'message':'invalid\x20data\x20length\x20(raw\x20data)'};return{'user':n,'hasError':![],'addressRemote':f,'addressType':v,'portRemote':t,'rawDataIndex':w,'ProtocolVersion':new Uint8Array([m]),'isUDP':r===0x2};}catch(y){return console['error']('ProcessProtocolHeader\x20error:',y['message'],y['stack']),{'hasError':!![],'message':'protocol\x20processing\x20error'};}}async function HandleTCPOutBound(a,b,c,d,e,f,g,h,i,j){async function k(n,o,p){var q;i['socks5Relay']?q=await socks5Connect(b,n,o,h,i['parsedSocks5Address']):q=p?await socks5Connect(b,n,o,h,i['parsedSocks5Address']):connect({'hostname':n,'port':o});a['value']=q,h('connected\x20to\x20'+n+':'+o);const r=q['writable']['getWriter']();return await r['write'](e),r['releaseLock'](),q;}async function l(){const n=i['enableSocks']?await k(c,d,!![]):await k(i['proxyIP']||c,i['proxyPort']||d,![]);n['closed']['catch'](function(o){console['log']('retry\x20tcpSocket\x20closed\x20error',o);})['finally'](function(){safeCloseWebSocket(f);}),RemoteSocketToWS(n,f,g,null,h,j);}const m=await k(c,d);RemoteSocketToWS(m,f,g,l,h,j);}function MakeReadableWebSocketStream(a,b,c){return new ReadableStream({'start':function(d){a['addEventListener']('message',function(f){d['enqueue'](f['data']);}),a['addEventListener']('close',function(){safeCloseWebSocket(a),d['close']();}),a['addEventListener']('error',function(f){c('webSocketServer\x20has\x20error'),d['error'](f);});const e=base64ToArrayBuffer(b);if(e['error'])d['error'](e['error']);else{if(e['earlyData'])d['enqueue'](e['earlyData']);}},'pull':function(d){},'cancel':function(d){c('ReadableStream\x20canceled:\x20'+d),safeCloseWebSocket(a);}});}async function RemoteSocketToWS(a,b,c,d,e,f){var g=![],h=c;await a['readable']['pipeTo'](new WritableStream({'write':async function(i,j){if(b['readyState']!==CONST['WS_READY_STATE_OPEN']){j['error'](new Error('webSocket\x20not\x20open'));return;}g=!![],h?(b['send'](await new Blob([h,i])['arrayBuffer']()),h=null):b['send'](i),f&&f(i['byteLength']);},'close':function(){e('remoteSocket\x20closed,\x20hasIncomingData:\x20'+g);},'abort':function(i){console['error']('remoteSocket\x20abort',i);}}))['catch'](function(i){console['error']('remoteSocket\x20pipeTo\x20error',i),safeCloseWebSocket(b);}),!g&&d&&(e('No\x20incoming\x20data,\x20retrying'),await d());}function base64ToArrayBuffer(a){if(!a)return{'earlyData':null,'error':null};try{const c=atob(a['replace'](/-/g,'+')['replace'](/_/g,'/')),d=new ArrayBuffer(c['length']),e=new Uint8Array(d);for(var b=0x0;b<c['length'];b++){e[b]=c['charCodeAt'](b);}return{'earlyData':d,'error':null};}catch(f){return{'earlyData':null,'error':f};}}function safeCloseWebSocket(a){try{(a['readyState']===CONST['WS_READY_STATE_OPEN']||a['readyState']===CONST['WS_READY_STATE_CLOSING'])&&a['close']();}catch(b){console['error']('safeCloseWebSocket\x20error:',b);}}async function createDnsPipeline(a,b,c,d){var e=![];const f=new TransformStream({'transform':function(h,i){for(var j=0x0;j<h['byteLength'];){if(j+0x2>h['byteLength'])break;const k=h['slice'](j,j+0x2),l=new DataView(k)['getUint16'](0x0);if(j+0x2+l>h['byteLength'])break;const m=new Uint8Array(h['slice'](j+0x2,j+0x2+l));j=j+0x2+l,i['enqueue'](m);}}});f['readable']['pipeTo'](new WritableStream({'write':async function(h){try{const j=await fetch('https://1.1.1.1/dns-query',{'method':'POST','headers':{'content-type':'application/dns-message'},'body':h}),k=await j['arrayBuffer'](),l=k['byteLength'],m=new Uint8Array([l>>0x8&0xff,l&0xff]);if(a['readyState']===CONST['WS_READY_STATE_OPEN']){c('DNS\x20query\x20success,\x20length:\x20'+l);var i;e?i=await new Blob([m,k])['arrayBuffer']():(i=await new Blob([b,m,k])['arrayBuffer'](),e=!![]),d&&d(i['byteLength']),a['send'](i);}}catch(n){c('DNS\x20query\x20error:\x20'+n);}}}))['catch'](function(h){c('DNS\x20stream\x20error:\x20'+h);});const g=f['writable']['getWriter']();return{'write':function(h){return g['write'](h);}};}function parseIPv6(a){const b=new ArrayBuffer(0x10),c=new DataView(b),d=a['split']('::');var e=d[0x0]?d[0x0]['split'](':'):[],f=d[0x1]?d[0x1]['split'](':'):[];if(e['length']===0x1&&e[0x0]==='')e=[];if(f['length']===0x1&&f[0x0]==='')f=[];const g=0x8-(e['length']+f['length']),h=[];if(g>0x0)for(var j=0x0;j<g;j++){h['push']('0000');}const k=e['concat'](h)['concat'](f);for(var j=0x0;j<0x8;j++){const l=parseInt(k[j]||'0',0x10);c['setUint16'](j*0x2,l,![]);}return new Uint8Array(b);}async function socks5Connect(a,b,c,d,f){const g=f['username'],h=f['password'],i=f['hostname'],j=f['port'];var k,l,m,n=![];try{k=connect({'hostname':i,'port':j}),l=k['readable']['getReader'](),m=k['writable']['getWriter']();const u=new TextEncoder();await m['write'](new Uint8Array([0x5,0x2,0x0,0x2]));var o=await l['read'](),p=o['value'];if(!p||p[0x0]!==0x5||p[0x1]===0xff)throw new Error('SOCKS5\x20handshake\x20failed');if(p[0x1]===0x2){if(!g||!h)throw new Error('SOCKS5\x20requires\x20credentials');const w=u['encode'](g),x=u['encode'](h),y=new Uint8Array(0x3+w['length']+x['length']);y[0x0]=0x1,y[0x1]=w['length'],y['set'](w,0x2),y[0x2+w['length']]=x['length'],y['set'](x,0x3+w['length']),await m['write'](y),o=await l['read'](),p=o['value'];if(!p||p[0x0]!==0x1||p[0x1]!==0x0)throw new Error('SOCKS5\x20auth\x20failed\x20(Code:\x20'+(p?p[0x1]:'null')+')');}var q;switch(a){case 0x1:var r=b['split']('.')['map'](Number);q=new Uint8Array([0x1,r[0x0],r[0x1],r[0x2],r[0x3]]);break;case 0x2:var s=u['encode'](b);q=new Uint8Array(0x2+s['length']),q[0x0]=0x3,q[0x1]=s['length'],q['set'](s,0x2);break;case 0x3:var t=parseIPv6(b);if(t['length']!==0x10)throw new Error('Failed\x20to\x20parse\x20IPv6:\x20'+b);q=new Uint8Array(0x1+0x10),q[0x0]=0x4,q['set'](t,0x1);break;default:throw new Error('Invalid\x20address\x20type:\x20'+a);}const v=new Uint8Array(0x4+q['length']+0x2);v[0x0]=0x5,v[0x1]=0x1,v[0x2]=0x0,v['set'](q,0x3),v[0x3+q['length']]=c>>0x8,v[0x3+q['length']+0x1]=c&0xff,await m['write'](v),o=await l['read'](),p=o['value'];if(!p||p[0x1]!==0x0)throw new Error('SOCKS5\x20connection\x20failed\x20(Code:\x20'+(p?p[0x1]:'null')+')');return d('SOCKS5\x20connection\x20to\x20'+b+':'+c+'\x20established'),n=!![],k;}catch(z){d('socks5Connect\x20error:\x20'+z['message'],z);throw z;}finally{if(m)m['releaseLock']();if(l)l['releaseLock']();if(!n&&k)try{k['abort']();}catch(A){d('Error\x20aborting\x20SOCKS5\x20socket',A);}}}function socks5AddressParser(a){if(!a||typeof a!=='string')throw new Error('Invalid\x20SOCKS5\x20address\x20format');var b=null,c=a;if(a['includes']('@')){var d=a['indexOf']('@');b=a['substring'](0x0,d),c=a['substring'](d+0x1);}const e=c['lastIndexOf'](':');if(e===-0x1)throw new Error('Invalid\x20SOCKS5\x20address:\x20missing\x20port');var f;if(c['startsWith']('[')){const l=c['lastIndexOf'](']');if(l===-0x1||l>e)throw new Error('Invalid\x20IPv6\x20SOCKS5\x20address');f=c['substring'](0x1,l);}else f=c['substring'](0x0,e);const g=c['substring'](e+0x1),h=parseInt(g,0xa);if(!f||isNaN(h))throw new Error('Invalid\x20SOCKS5\x20address');var i,j;if(b){var k=b['indexOf'](':');k!==-0x1?(i=b['substring'](0x0,k),j=b['substring'](k+0x1)):i=b;}return{'username':i,'password':j,'hostname':f,'port':h};}export default{async 'fetch'(a,b,c){try{await ensureTablesExist(b,c);var d;try{d=await Config['fromEnv'](b);}catch(o){console['error']('Configuration\x20error:\x20'+o['message']);const p=new Headers();return addSecurityHeaders(p,null,{}),new Response('Service\x20unavailable',{'status':0x1f7,'headers':p});}const g=new URL(a['url']),h=a['headers']['get']('CF-Connecting-IP'),i=b['ADMIN_PATH_PREFIX']||'admin';if(g['pathname']['startsWith']('/'+i+'/'))return await handleAdminRequest(a,b,c,i);if(g['pathname']==='/health'){const q=new Headers();return addSecurityHeaders(q,null,{}),new Response('OK',{'status':0xc8,'headers':q});}if(g['pathname']==='/health-check'&&a['method']==='GET'){await performHealthCheck(b,c);const r=new Headers();return addSecurityHeaders(r,null,{}),new Response('Health\x20check\x20performed',{'status':0xc8,'headers':r});}if(g['pathname']['startsWith']('/api/user/')){const s=g['pathname']['substring']('/api/user/'['length']),t=new Headers({'Content-Type':'application/json'});addSecurityHeaders(t,null,{});if(a['method']!=='GET')return new Response(JSON['stringify']({'error':'Method\x20Not\x20Allowed'}),{'status':0x195,'headers':t});if(!isValidUUID(s))return new Response(JSON['stringify']({'error':'Invalid\x20UUID'}),{'status':0x190,'headers':t});const u=await getUserData(b,s,c);if(!u)return new Response(JSON['stringify']({'error':'User\x20not\x20found'}),{'status':0x194,'headers':t});return new Response(JSON['stringify']({'traffic_used':u['traffic_used']||0x0,'traffic_limit':u['traffic_limit'],'expiration_date':u['expiration_date'],'expiration_time':u['expiration_time']}),{'status':0xc8,'headers':t});}if(g['pathname']==='/favicon.ico')return new Response(null,{'status':0x12d,'headers':{'Location':'https://www.google.com/favicon.ico'}});const j=a['headers']['get']('Upgrade');if(j&&j['toLowerCase']()==='websocket'){if(!b['DB']){const C=new Headers();return addSecurityHeaders(C,null,{}),new Response('Service\x20not\x20configured',{'status':0x1f7,'headers':C});}const v=b['HOST_HEADERS']?b['HOST_HEADERS']['split'](',')['map'](function(D){return D['trim']();}):['speed.cloudflare.com','www.cloudflare.com'],w=pick(v),x=new Headers(a['headers']);x['set']('Host',w);const y=new Request(a,{'headers':x}),z={'userID':d['userID'],'proxyIP':d['proxyIP'],'proxyPort':d['proxyPort'],'socks5Address':d['socks5']['address'],'socks5Relay':d['socks5']['relayMode'],'enableSocks':d['socks5']['enabled'],'parsedSocks5Address':d['socks5']['enabled']?socks5AddressParser(d['socks5']['address']):{},'scamalytics':d['scamalytics']},A=await ProtocolOverWSHandler(y,z,b,c),B=new Headers(A['headers']);return addSecurityHeaders(B,null,{}),new Response(A['body'],{'status':A['status'],'webSocket':A['webSocket'],'headers':B});}async function k(D){const E='user_path_rate:'+h;if(await checkRateLimit(b['DB'],E,CONST['USER_PATH_RATE_LIMIT'],CONST['USER_PATH_RATE_TTL'])){const H=new Headers();return addSecurityHeaders(H,null,{}),new Response('Rate\x20limit\x20exceeded',{'status':0x1ad,'headers':H});}const F=g['pathname']['substring'](('/'+D+'/')['length']);if(!isValidUUID(F)){const I=new Headers();return addSecurityHeaders(I,null,{}),new Response('Invalid\x20UUID',{'status':0x190,'headers':I});}const G=await getUserData(b,F,c);if(!G){const J=new Headers();return addSecurityHeaders(J,null,{}),new Response('User\x20not\x20found',{'status':0x193,'headers':J});}if(isExpired(G['expiration_date'],G['expiration_time'])){const K=new Headers();return addSecurityHeaders(K,null,{}),new Response('Account\x20expired',{'status':0x193,'headers':K});}if(G['traffic_limit']&&G['traffic_limit']>0x0&&(G['traffic_used']||0x0)>=G['traffic_limit']){const L=new Headers();return addSecurityHeaders(L,null,{}),new Response('Traffic\x20limit\x20exceeded',{'status':0x193,'headers':L});}return await handleIpSubscription(D,F,g['hostname']);}if(g['pathname']['startsWith']('/xray/'))return await k('xray');if(g['pathname']['startsWith']('/sb/'))return await k('sb');const l=g['pathname']['slice'](0x1);if(isValidUUID(l)){const D='user_path_rate:'+h;if(await checkRateLimit(b['DB'],D,CONST['USER_PATH_RATE_LIMIT'],CONST['USER_PATH_RATE_TTL'])){const F=new Headers();return addSecurityHeaders(F,null,{}),new Response('Rate\x20limit\x20exceeded',{'status':0x1ad,'headers':F});}const E=await getUserData(b,l,c);if(!E){const G=new Headers();return addSecurityHeaders(G,null,{}),new Response('User\x20not\x20found',{'status':0x193,'headers':G});}return await handleUserPanel(a,l,g['hostname'],d['proxyAddress'],E,h);}if(b['ROOT_PROXY_URL'])try{var f;try{f=new URL(b['ROOT_PROXY_URL']);}catch(L){console['error']('Invalid\x20ROOT_PROXY_URL:\x20'+b['ROOT_PROXY_URL'],L);const M=new Headers();return addSecurityHeaders(M,null,{}),new Response('Proxy\x20configuration\x20error',{'status':0x1f4,'headers':M});}const H=new URL(a['url']);H['hostname']=f['hostname'],H['protocol']=f['protocol'];f['port']&&(H['port']=f['port']);const I=new Request(H['toString'](),{'method':a['method'],'headers':a['headers'],'body':a['body'],'redirect':'manual'});I['headers']['set']('Host',f['hostname']),I['headers']['set']('X-Forwarded-For',h),I['headers']['set']('X-Forwarded-Proto',H['protocol']['replace'](':','')),I['headers']['set']('X-Real-IP',h);const J=await fetch(I),K=new Headers(J['headers']);return K['delete']('content-security-policy-report-only'),K['delete']('x-frame-options'),!K['has']('Content-Security-Policy')&&K['set']('Content-Security-Policy','default-src\x20\x27self\x27\x20\x27unsafe-inline\x27\x20\x27unsafe-eval\x27\x20data:\x20blob:\x20*;\x20frame-ancestors\x20\x27self\x27;'),!K['has']('X-Frame-Options')&&K['set']('X-Frame-Options','SAMEORIGIN'),!K['has']('Strict-Transport-Security')&&K['set']('Strict-Transport-Security','max-age=31536000;\x20includeSubDomains'),K['set']('alt-svc','h3=\x22:443\x22;\x20ma=0'),new Response(J['body'],{'status':J['status'],'statusText':J['statusText'],'headers':K});}catch(N){console['error']('Reverse\x20Proxy\x20Error:\x20'+N['message'],N['stack']);const O=new Headers();return addSecurityHeaders(O,null,{}),new Response('Proxy\x20error:\x20'+N['message'],{'status':0x1f6,'headers':O});}const m='<!DOCTYPE\x20html><html><head><title>Welcome\x20to\x20nginx!</title><style>body\x20{\x20width:\x2035em;\x20margin:\x200\x20auto;\x20font-family:\x20Tahoma,\x20Verdana,\x20Arial,\x20sans-serif;\x20}</style></head><body><h1>Welcome\x20to\x20nginx!</h1><p>If\x20you\x20see\x20this\x20page,\x20the\x20nginx\x20web\x20server\x20is\x20successfully\x20installed\x20and\x20working.\x20Further\x20configuration\x20is\x20required.</p><p>For\x20online\x20documentation\x20and\x20support\x20please\x20refer\x20to\x20<a\x20href=\x22http://nginx.org/\x22>nginx.org</a>.</p><p><em>Thank\x20you\x20for\x20using\x20nginx.</em></p></body></html>',n=new Headers({'Content-Type':'text/html'});return addSecurityHeaders(n,null,{}),new Response(m,{'headers':n});}catch(P){console['error']('Fetch\x20handler\x20error:',P['message'],P['stack']);const Q=new Headers();return addSecurityHeaders(Q,null,{}),new Response('Internal\x20Server\x20Error',{'status':0x1f4,'headers':Q});}},async 'scheduled'(a,b,c){try{console['log']('Running\x20scheduled\x20health\x20check...'),await performHealthCheck(b,c),await cleanupOldIps(b,c),console['log']('Scheduled\x20tasks\x20completed\x20successfully');}catch(d){console['error']('Scheduled\x20task\x20error:',d['message']);}}};